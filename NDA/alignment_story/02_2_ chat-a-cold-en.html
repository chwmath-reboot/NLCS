<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S-Engine ER Intern Simulator v1.0</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #1a2a3a 0%, #0d1a26 100%);
      color: #e0e0e0;
      font-family: 'Noto Sans', sans-serif;
      padding: 15px;
      font-size: 14px;
    }
    
    .container { max-width: 800px; margin: 0 auto; }
    
    header { text-align: center; margin-bottom: 15px; }
    
    h1 { font-size: 1.6rem; color: #4ecdc4; margin-bottom: 5px; }
    
    .subtitle { color: #888; font-size: 0.8rem; }
    
    .credit { 
      color: #ffd700; 
      font-size: 0.75rem; 
      margin-top: 5px;
      font-style: italic;
    }
    
    .gold-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,0.3);
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid rgba(255,215,0,0.3);
    }
    
    .gold-total { font-size: 1.2rem; color: #ffd700; font-weight: bold; }
    
    .gold-change { font-size: 0.9rem; padding: 3px 8px; border-radius: 4px; }
    .gold-change.positive { background: rgba(46,204,113,0.2); color: #2ecc71; }
    .gold-change.negative { background: rgba(231,76,60,0.2); color: #e74c3c; }
    .gold-change.neutral { background: rgba(255,255,255,0.1); color: #888; }
    
    .dialog-box {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      min-height: 200px;
      max-height: 350px;
      overflow-y: auto;
    }
    
    .dialog-line { margin-bottom: 12px; padding: 8px 12px; border-radius: 8px; line-height: 1.5; }
    .dialog-line.nurse { background: rgba(155,89,182,0.2); border-left: 3px solid #9b59b6; }
    .dialog-line.intern { background: rgba(52,152,219,0.2); border-left: 3px solid #3498db; }
    .dialog-line.patient { background: rgba(230,126,34,0.2); border-left: 3px solid #e67e22; }
    .dialog-line.system { background: rgba(46,204,113,0.2); border-left: 3px solid #2ecc71; font-style: italic; }
    .dialog-line.result { background: rgba(255,215,0,0.15); border-left: 3px solid #ffd700; font-weight: bold; }
    
    .speaker { font-weight: bold; margin-right: 8px; }
    .speaker.nurse { color: #9b59b6; }
    .speaker.intern { color: #3498db; }
    .speaker.patient { color: #e67e22; }
    
    .chart-box {
      background: rgba(255,255,255,0.95);
      color: #333;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      font-family: 'Courier New', monospace;
    }
    
    .chart-title { font-weight: bold; font-size: 1rem; border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 10px; text-align: center; }
    .chart-row { display: flex; margin-bottom: 5px; }
    .chart-label { font-weight: bold; min-width: 100px; }
    .chart-value { flex: 1; }
    .chart-symptoms { display: flex; flex-wrap: wrap; gap: 5px; }
    .symptom-tag { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; }
    
    .button-area { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
    .button-title { color: #4ecdc4; font-size: 0.85rem; margin-bottom: 10px; }
    .symptom-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
    
    .symptom-btn {
      padding: 8px 14px;
      background: rgba(52,152,219,0.3);
      border: 1px solid rgba(52,152,219,0.5);
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .symptom-btn:hover { background: rgba(52,152,219,0.5); transform: translateY(-1px); }
    .symptom-btn.selected { background: rgba(46,204,113,0.4); border-color: #2ecc71; }
    
    .action-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    
    .action-btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn.primary { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
    .action-btn.secondary { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
    .action-btn.success { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
    .action-btn.danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
    .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    
    .diagnosis-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 15px; }
    .diagnosis-btn { padding: 15px 40px; border: 2px solid; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
    .diagnosis-btn.cold { background: rgba(46,204,113,0.2); border-color: #2ecc71; color: #2ecc71; }
    .diagnosis-btn.report { background: rgba(231,76,60,0.2); border-color: #e74c3c; color: #e74c3c; }
    .diagnosis-btn:hover { transform: scale(1.05); }
    
    .stats-bar { display: flex; justify-content: space-around; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 1.2rem; font-weight: bold; color: #4ecdc4; }
    .stat-label { color: #888; }
    
    .settings-panel { background: rgba(0,0,0,0.4); border: 1px solid rgba(78,205,196,0.3); border-radius: 8px; margin-bottom: 15px; padding: 10px 15px; display: flex; align-items: center; gap: 15px; }
    .settings-label { color: #4ecdc4; font-size: 0.85rem; }
    .temp-toggle { display: flex; gap: 5px; }
    .temp-btn { padding: 5px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: #888; cursor: pointer; font-size: 0.85rem; }
    .temp-btn.active { background: rgba(78,205,196,0.3); border-color: #4ecdc4; color: #4ecdc4; }
    
    .test-panel { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,165,0,0.3); border-radius: 8px; margin-top: 15px; overflow: hidden; }
    .test-title { padding: 10px 15px; background: rgba(255,165,0,0.15); color: #ffa500; font-size: 0.85rem; cursor: pointer; }
    .test-content { padding: 15px; }
    .test-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .test-row label { min-width: 120px; color: #aaa; }
    .test-row input { width: 80px; padding: 5px 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: #fff; font-size: 0.9rem; }
    
    .ending-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .ending-content { text-align: center; padding: 40px; background: linear-gradient(135deg, rgba(46,204,113,0.2), rgba(39,174,96,0.1)); border: 2px solid #2ecc71; border-radius: 20px; max-width: 450px; }
    .ending-screen.fail .ending-content { background: linear-gradient(135deg, rgba(231,76,60,0.2), rgba(192,57,43,0.1)); border-color: #e74c3c; }
    .ending-screen.bankrupt .ending-content { background: linear-gradient(135deg, rgba(127,140,141,0.2), rgba(95,106,106,0.1)); border-color: #7f8c8d; }
    .ending-icon { font-size: 4rem; margin-bottom: 20px; }
    .ending-title { font-size: 1.8rem; font-weight: bold; color: #2ecc71; margin-bottom: 15px; }
    .ending-screen.fail .ending-title { color: #e74c3c; }
    .ending-screen.bankrupt .ending-title { color: #7f8c8d; }
    .ending-text { font-size: 1.1rem; color: #ccc; line-height: 1.6; margin-bottom: 20px; }
    .ending-text strong { color: #4ecdc4; font-size: 1.3rem; }
    .ending-stats { display: flex; justify-content: center; gap: 20px; font-size: 0.95rem; color: #aaa; }
    .ending-stats strong { color: #ffd700; }
    
    .dialog-box::-webkit-scrollbar { width: 6px; }
    .dialog-box::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    .dialog-box::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè• ER Intern Simulator</h1>
      <div class="subtitle">S-Engine Medical Domain Extension v1.0 | Level: Junior (Intern)</div>
      <div class="credit">NLPg with S-Engine, Coded by Claude.</div>
    </header>
    
    <div class="settings-panel">
      <span class="settings-label">üå°Ô∏è Temperature Unit:</span>
      <div class="temp-toggle">
        <button class="temp-btn active" id="btn-celsius" onclick="setTempUnit('C')">¬∞C</button>
        <button class="temp-btn" id="btn-fahrenheit" onclick="setTempUnit('F')">¬∞F</button>
      </div>
    </div>
    
    <div class="gold-bar">
      <div class="gold-total">üí∞ <span id="gold-total">0</span> Gold</div>
      <div id="gold-change" class="gold-change neutral">No recent change</div>
    </div>
    
    <div class="stats-bar">
      <div class="stat-item"><div class="stat-value" id="stat-patients">0</div><div class="stat-label">Patients</div></div>
      <div class="stat-item"><div class="stat-value" id="stat-correct">0</div><div class="stat-label">Correct</div></div>
      <div class="stat-item"><div class="stat-value" id="stat-missed">0</div><div class="stat-label">Misdiagnosis</div></div>
    </div>
    
    <div class="dialog-box" id="dialog-box">
      <div class="dialog-line system"><span>üë©‚Äç‚öïÔ∏è Welcome to the Emergency Room, Dr. Kim.</span></div>
    </div>
    
    <div class="chart-box">
      <div class="chart-title">üìã Patient Chart</div>
      <div class="chart-row"><span class="chart-label">Temperature:</span><span class="chart-value" id="chart-temp">-</span></div>
      <div class="chart-row"><span class="chart-label">Symptoms:</span><div class="chart-symptoms" id="chart-symptoms"><span style="color:#888;">-</span></div></div>
    </div>
    
    <div class="button-area" id="button-area">
      <div style="text-align: center; margin-bottom: 15px; color: #4ecdc4; font-size: 1rem;">
        üéØ Challenge: Correctly diagnose 95+ out of 100 patients to become a star intern!
      </div>
      <div class="action-buttons">
        <button class="action-btn primary" onclick="startNewPatient()">ü©∫ Next Patient</button>
      </div>
    </div>
    
    <div class="test-panel">
      <div class="test-title" onclick="toggleTestPanel()">üîß Test Mode (Click to open)</div>
      <div class="test-content" id="test-content" style="display: none;">
        <div class="test-row"><label>Patients Seen:</label><input type="number" id="test-patients" value="0" min="0" max="100"></div>
        <div class="test-row"><label>Correct:</label><input type="number" id="test-correct" value="0" min="0" max="100"></div>
        <div class="test-row"><label>Misdiagnoses:</label><input type="number" id="test-missed" value="0" min="0" max="100"></div>
        <button class="action-btn secondary" onclick="applyTestStats()" style="margin-top: 10px; padding: 8px 20px;">Apply</button>
      </div>
    </div>
    
    <div class="ending-screen" id="ending-screen" style="display: none;">
      <div class="ending-content">
        <div class="ending-icon">üéâ</div>
        <div class="ending-title">Congratulations!</div>
        <div class="ending-text">You have been promoted from<br>Intern to <strong>Resident</strong>!</div>
        <div class="ending-stats">
          <span>Patients: <strong id="ending-patients">100</strong></span>
          <span>Correct: <strong id="ending-correct">95</strong></span>
          <span>Accuracy: <strong id="ending-rate">95%</strong></span>
        </div>
        <button class="action-btn success" onclick="continueGame()" style="margin-top: 20px;">üéÆ Continue Game</button>
      </div>
    </div>
    
    <div class="ending-screen fail" id="fail-screen" style="display: none;">
      <div class="ending-content">
        <div class="ending-icon">üò¢</div>
        <div class="ending-title">Not Quite...</div>
        <div class="ending-text">You didn't reach 95 correct diagnoses.<br>Try again!</div>
        <div class="ending-stats">
          <span>Patients: <strong id="fail-patients">100</strong></span>
          <span>Correct: <strong id="fail-correct">90</strong></span>
          <span>Accuracy: <strong id="fail-rate">90%</strong></span>
        </div>
        <button class="action-btn primary" onclick="restartGame()" style="margin-top: 20px;">üîÑ Start Over</button>
      </div>
    </div>
    
    <div class="ending-screen bankrupt" id="bankrupt-screen" style="display: none;">
      <div class="ending-content">
        <div class="ending-icon">üíÄ</div>
        <div class="ending-title">The studio went bankrupt.</div>
        <div class="ending-text">The Resident version will not be released.</div>
        <button class="action-btn danger" onclick="restartGame()" style="margin-top: 20px;">üîÑ Back to Start</button>
      </div>
    </div>
  </div>

  <script>
    const state = {
      gold: 0, lastChange: 0, patients: 0, correct: 0, missed: 0,
      phase: 'idle', currentPatient: null, selectedSymptoms: [], sinusitisAnswers: [],
      tempUnit: 'C'
    };
    
    function setTempUnit(unit) {
      state.tempUnit = unit;
      document.getElementById('btn-celsius').className = unit === 'C' ? 'temp-btn active' : 'temp-btn';
      document.getElementById('btn-fahrenheit').className = unit === 'F' ? 'temp-btn active' : 'temp-btn';
    }
    
    function celsiusToFahrenheit(c) { return (c * 9/5 + 32).toFixed(1); }
    function formatTemp(celsius) { return state.tempUnit === 'F' ? celsiusToFahrenheit(parseFloat(celsius)) + '¬∞F' : celsius + '¬∞C'; }
    
    const SYMPTOMS = {
      'Runny Nose': ["My nose keeps running like water.", "I can't stop using tissues.", "I keep sniffling, it's so uncomfortable."],
      'Stuffy Nose': ["My nose feels completely blocked.", "It's so hard to breathe through my nose.", "I've been breathing through my mouth."],
      'Sore Throat': ["My throat is scratchy and uncomfortable.", "It hurts every time I swallow.", "My throat feels raw."],
      'Dry Cough': ["I have a dry cough, no phlegm.", "The cough won't stop, it's exhausting.", "I cough every time I try to speak."],
      'Productive Cough': ["I feel phlegm stuck when I cough.", "There's a gurgling sound in my throat.", "I keep spitting out mucus."],
      'Night Cough': ["Lying down makes my cough worse.", "I wake up every night coughing.", "I barely slept, coughing all night."],
      'Body Aches': ["My whole body aches.", "My arms and legs feel heavy.", "Everything hurts."],
      'Headache': ["I have a throbbing headache.", "My head hurts so much I can't concentrate.", "There's pressure behind my eyes."],
      'Fatigue': ["I have no energy at all.", "I get tired with the smallest movement.", "I feel so weak."],
      'Loss of Appetite': ["I have no appetite.", "Food doesn't taste good.", "Nothing sounds appealing."],
      'Fever': ["I feel hot, like I have a fever.", "My face feels flushed and warm.", "I couldn't sleep because of the fever."],
      'Chills': ["I feel chilly and have goosebumps.", "Even with thick clothes, I still feel cold.", "First I'm cold, then suddenly hot."],
      'Dizziness': ["I felt dizzy and had to lean against the wall.", "I feel slightly dizzy when I look up."],
      'Mild Nausea': ["I feel a bit queasy sometimes.", "My stomach feels slightly upset."]
    };
    
    const SINUSITIS_RESPONSES = {
      A: { question: "Do you have pain around your face or eyes when pressed?",
           positive: ["Yes, my face feels stuffed up.", "The area under my eyes keeps throbbing.", "It hurts when I press here."],
           negative: ["No, nothing like that.", "My face feels fine."] },
      B: { question: "Is your nasal discharge thick, discolored, or have a strong odor?",
           positive: ["There's a strong smell when I blow my nose.", "It's yellowish-green and thick.", "The mucus won't come out easily."],
           negative: ["No, it's just clear.", "The color is normal."] },
      C: { question: "When did your cough start? Does it get worse at night?",
           positive: ["It's been 3-4 days, especially bad at night.", "Over a week and won't go away.", "Much worse when I lie down."],
           negative: ["Just started yesterday.", "A day or two."] },
      D: { question: "Does your headache get worse when you bend your head down?",
           positive: ["Yes! It's hard to even wash my face.", "Sharp pain behind my eyes when I bend.", "The pain increases when I lower my head."],
           negative: ["No, it doesn't change.", "I'm not sure about that."] }
    };
    
    function generatePatient() {
      const isSinusitis = Math.random() < 0.1;
      const allSymptoms = Object.keys(SYMPTOMS);
      const numSymptoms = 2 + Math.floor(Math.random() * 4);
      const selectedSymptoms = allSymptoms.sort(() => Math.random() - 0.5).slice(0, numSymptoms);
      
      const hasFever = selectedSymptoms.includes('Fever') || selectedSymptoms.includes('Chills');
      let tempCelsius = hasFever ? (37.5 + Math.random() * 1.0).toFixed(1) : (36.3 + Math.random() * 0.7).toFixed(1);
      
      const firstCount = Math.max(1, Math.floor(selectedSymptoms.length * (0.5 + Math.random() * 0.3)));
      
      let sinusitisPositive = [];
      if (isSinusitis) {
        const numPos = 1 + Math.floor(Math.random() * 3);
        sinusitisPositive = ['A','B','C','D'].sort(() => Math.random() - 0.5).slice(0, numPos);
      }
      
      return {
        isSinusitis, symptoms: selectedSymptoms,
        firstSymptoms: selectedSymptoms.slice(0, firstCount),
        secondSymptoms: selectedSymptoms.slice(firstCount),
        temperature: tempCelsius, sinusitisPositive
      };
    }
    
    function getSymptomDialogue(s) { const d = SYMPTOMS[s]; return d[Math.floor(Math.random() * d.length)]; }
    function generateFirstAnswer(p) { return p.firstSymptoms.map(s => getSymptomDialogue(s)).join(' '); }
    function generateSecondAnswer(p) { return p.secondSymptoms.length === 0 ? "Nothing else, that's it." : p.secondSymptoms.map(s => getSymptomDialogue(s)).join(' '); }
    
    function addDialog(type, speaker, text) {
      const box = document.getElementById('dialog-box');
      const line = document.createElement('div');
      line.className = `dialog-line ${type}`;
      line.innerHTML = speaker ? `<span class="speaker ${type}">${speaker}:</span> ${text}` : text;
      box.appendChild(line);
      box.scrollTop = box.scrollHeight;
    }
    
    function clearChart() {
      document.getElementById('chart-temp').textContent = '-';
      document.getElementById('chart-symptoms').innerHTML = '<span style="color:#888;">-</span>';
    }
    
    function updateChart() {
      const div = document.getElementById('chart-symptoms');
      div.innerHTML = state.selectedSymptoms.length === 0 ? '<span style="color:#888;">-</span>' : 
        state.selectedSymptoms.map(s => `<span class="symptom-tag">${s}</span>`).join('');
    }
    
    function updateGold(change) {
      state.gold += change;
      document.getElementById('gold-total').textContent = state.gold;
      const el = document.getElementById('gold-change');
      if (change > 0) { el.className = 'gold-change positive'; el.textContent = `+${change} Gold`; }
      else if (change < 0) { el.className = 'gold-change negative'; el.textContent = `${change} Gold`; }
      else { el.className = 'gold-change neutral'; el.textContent = 'No recent change'; }
    }
    
    function updateStats() {
      document.getElementById('stat-patients').textContent = state.patients;
      document.getElementById('stat-correct').textContent = state.correct;
      document.getElementById('stat-missed').textContent = state.missed;
    }
    
    function renderSymptomButtons() {
      const area = document.getElementById('button-area');
      area.innerHTML = `
        <div class="button-title">üìù Select symptoms to record on the chart</div>
        <div class="symptom-buttons">
          ${Object.keys(SYMPTOMS).map(s => `<button class="symptom-btn ${state.selectedSymptoms.includes(s) ? 'selected' : ''}" onclick="toggleSymptom('${s}')">${s}</button>`).join('')}
        </div>
        <div class="action-buttons"><button class="action-btn primary" onclick="confirmSymptoms()">‚úÖ Done Recording</button></div>
      `;
    }
    
    function renderAdditionalQuestionChoice() {
      document.getElementById('button-area').innerHTML = `
        <div class="button-title">ü§î Would you like to ask additional questions?</div>
        <div class="action-buttons">
          <button class="action-btn success" onclick="askAdditionalQuestions()">Yes</button>
          <button class="action-btn secondary" onclick="skipTodiagnosis()">No</button>
        </div>
      `;
    }
    
    function renderQuestionButtons() {
      const asked = state.sinusitisAnswers.map(a => a.key);
      const remaining = ['A','B','C','D'].filter(k => !asked.includes(k));
      const labels = { A: 'Face/Eye Pain', B: 'Discharge Color/Odor', C: 'Cough Duration', D: 'Headache When Bending' };
      document.getElementById('button-area').innerHTML = `
        <div class="button-title">üîç Select a follow-up question</div>
        <div class="symptom-buttons">${remaining.map(k => `<button class="symptom-btn" onclick="askSinusitisQuestion('${k}')">${labels[k]}</button>`).join('')}</div>
        <div class="action-buttons" style="margin-top:15px;"><button class="action-btn danger" onclick="skipTodiagnosis()">Stop & Diagnose</button></div>
      `;
    }
    
    function renderDiagnosisButtons() {
      document.getElementById('button-area').innerHTML = `
        <div class="button-title">ü©∫ Make your diagnosis</div>
        <div class="diagnosis-buttons">
          <button class="diagnosis-btn cold" onclick="makeDiagnosis('cold')">üíä Common Cold</button>
          <button class="diagnosis-btn report" onclick="makeDiagnosis('report')">üìû Report to Senior</button>
        </div>
      `;
    }
    
    function renderNextPatientButton() {
      document.getElementById('button-area').innerHTML = `<div class="action-buttons"><button class="action-btn primary" onclick="startNewPatient()">ü©∫ Next Patient</button></div>`;
    }
    
    function startNewPatient() {
      state.currentPatient = generatePatient();
      state.selectedSymptoms = [];
      state.sinusitisAnswers = [];
      state.phase = 'firstQuestion';
      state.patients++;
      clearChart(); updateStats();
      document.getElementById('dialog-box').innerHTML = '';
      addDialog('nurse', 'Senior Nurse', "Dr. Kim, could you see this patient please?");
      setTimeout(() => {
        addDialog('intern', 'Dr. Kim', "What seems to be the problem today?");
        setTimeout(() => { addDialog('patient', 'Patient', generateFirstAnswer(state.currentPatient)); renderSymptomButtons(); }, 800);
      }, 600);
    }
    
    function toggleSymptom(s) {
      const idx = state.selectedSymptoms.indexOf(s);
      if (idx >= 0) state.selectedSymptoms.splice(idx, 1);
      else state.selectedSymptoms.push(s);
      updateChart(); renderSymptomButtons();
    }
    
    function confirmSymptoms() {
      if (state.phase === 'firstQuestion') {
        state.phase = 'secondQuestion';
        addDialog('intern', 'Dr. Kim', "Is there anything else bothering you?");
        setTimeout(() => { addDialog('patient', 'Patient', generateSecondAnswer(state.currentPatient)); setTimeout(renderSymptomButtons, 600); }, 600);
      } else if (state.phase === 'secondQuestion') {
        state.phase = 'tempCheck';
        const temp = formatTemp(state.currentPatient.temperature);
        addDialog('nurse', 'Senior Nurse', `Patient's temperature is ${temp}.`);
        document.getElementById('chart-temp').textContent = temp;
        setTimeout(() => { state.phase = 'additionalQuestion'; renderAdditionalQuestionChoice(); }, 600);
      }
    }
    
    function askAdditionalQuestions() { state.phase = 'sinusitisCheck'; state.sinusitisAnswers = []; renderQuestionButtons(); }
    
    function askSinusitisQuestion(key) {
      const q = SINUSITIS_RESPONSES[key];
      addDialog('intern', 'Dr. Kim', q.question);
      setTimeout(() => {
        const isPos = state.currentPatient.sinusitisPositive.includes(key);
        const resp = isPos ? q.positive : q.negative;
        addDialog('patient', 'Patient', resp[Math.floor(Math.random() * resp.length)]);
        if (isPos) addDialog('system', null, '‚ö†Ô∏è [Concerning symptom detected]');
        state.sinusitisAnswers.push({ key, positive: isPos });
        setTimeout(() => { state.sinusitisAnswers.length >= 4 ? (state.phase = 'diagnosis', renderDiagnosisButtons()) : renderQuestionButtons(); }, 600);
      }, 600);
    }
    
    function skipTodiagnosis() { state.phase = 'diagnosis'; renderDiagnosisButtons(); }
    
    function makeDiagnosis(type) {
      const p = state.currentPatient;
      const wrong = state.selectedSymptoms.filter(s => !p.symptoms.includes(s));
      const missed = p.symptoms.filter(s => !state.selectedSymptoms.includes(s));
      const penalty = (wrong.length + missed.length) * 20;
      let gold = 0, text = '';
      
      if (type === 'cold') {
        if (p.isSinusitis) { gold = -100; text = '‚ùå Misdiagnosis! Patient has sinusitis. (-100 Gold)'; state.missed++; }
        else { gold = 100 - penalty; text = penalty > 0 ? `‚úÖ Correct! (+100, errors -${penalty} = ${gold >= 0 ? '+' : ''}${gold} Gold)` : '‚úÖ Perfect diagnosis! (+100 Gold)'; state.correct++; }
      } else {
        if (p.isSinusitis) { gold = 100 - penalty; text = penalty > 0 ? `‚úÖ Good call! (+100, errors -${penalty} = ${gold >= 0 ? '+' : ''}${gold} Gold)` : '‚úÖ Perfect judgment! (+100 Gold)'; state.correct++; }
        else { gold = 50 - penalty; text = penalty > 0 ? `‚ö†Ô∏è Safe choice. (+50, errors -${penalty} = ${gold >= 0 ? '+' : ''}${gold} Gold)` : '‚ö†Ô∏è Safe choice. (+50 Gold)'; }
      }
      
      updateGold(gold); updateStats();
      addDialog('result', null, text);
      addDialog('system', null, p.isSinusitis ? 'üìã Actual: Sinusitis' : 'üìã Actual: Common Cold');
      showSymptomFeedback(p);
      state.phase = 'idle';
      state.patients >= 100 ? setTimeout(checkEnding, 1500) : renderNextPatientButton();
    }
    
    function showSymptomFeedback(p) {
      const correct = state.selectedSymptoms.filter(s => p.symptoms.includes(s));
      const wrong = state.selectedSymptoms.filter(s => !p.symptoms.includes(s));
      const missed = p.symptoms.filter(s => !state.selectedSymptoms.includes(s));
      
      let html = '<div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.1);border-radius:8px;">';
      html += '<div style="font-weight:bold;margin-bottom:8px;">üìä Symptom Results</div>';
      if (correct.length) html += '<div style="margin-bottom:5px;">' + correct.map(s => `<span style="display:inline-block;margin:2px;padding:3px 8px;background:rgba(46,204,113,0.3);border:2px solid #2ecc71;border-radius:15px;color:#2ecc71;">‚≠ï ${s}</span>`).join('') + '</div>';
      if (wrong.length) html += '<div style="margin-bottom:5px;">' + wrong.map(s => `<span style="display:inline-block;margin:2px;padding:3px 8px;background:rgba(0,0,0,0.3);border:2px solid #333;border-radius:15px;color:#888;">‚úñ ${s}</span>`).join('') + '</div>';
      if (missed.length) html += '<div style="margin-bottom:5px;">' + missed.map(s => `<span style="display:inline-block;margin:2px;padding:3px 8px;background:rgba(46,204,113,0.15);border:2px solid #2ecc71;border-radius:4px;color:#2ecc71;">üìå ${s}</span>`).join('') + '</div>';
      html += `<div style="margin-top:8px;font-size:0.85rem;color:#aaa;">Accuracy: ${correct.length}/${p.symptoms.length} (${Math.round(correct.length/p.symptoms.length*100)}%)</div></div>`;
      
      const div = document.createElement('div');
      div.className = 'dialog-line system';
      div.innerHTML = html;
      document.getElementById('dialog-box').appendChild(div);
    }
    
    function toggleTestPanel() {
      const c = document.getElementById('test-content');
      const t = document.querySelector('.test-title');
      c.style.display = c.style.display === 'none' ? 'block' : 'none';
      t.textContent = c.style.display === 'none' ? 'üîß Test Mode (Click to open)' : 'üîß Test Mode (Click to close)';
    }
    
    function applyTestStats() {
      state.patients = parseInt(document.getElementById('test-patients').value) || 0;
      state.correct = parseInt(document.getElementById('test-correct').value) || 0;
      state.missed = parseInt(document.getElementById('test-missed').value) || 0;
      updateStats();
      addDialog('system', null, `üìä Applied: ${state.patients} patients, ${state.correct} correct, ${state.missed} missed`);
      checkEnding();
    }
    
    function checkEnding() { if (state.patients >= 100) state.correct >= 95 ? showSuccessEnding() : showFailEnding(); }
    
    function showSuccessEnding() {
      const r = Math.round(state.correct / state.patients * 100);
      document.getElementById('ending-patients').textContent = state.patients;
      document.getElementById('ending-correct').textContent = state.correct;
      document.getElementById('ending-rate').textContent = r + '%';
      document.getElementById('ending-screen').style.display = 'flex';
    }
    
    function showFailEnding() {
      const r = Math.round(state.correct / state.patients * 100);
      document.getElementById('fail-patients').textContent = state.patients;
      document.getElementById('fail-correct').textContent = state.correct;
      document.getElementById('fail-rate').textContent = r + '%';
      document.getElementById('fail-screen').style.display = 'flex';
    }
    
    function continueGame() {
      document.getElementById('ending-screen').style.display = 'none';
      document.getElementById('bankrupt-screen').style.display = 'flex';
    }
    
    function restartGame() {
      ['ending-screen', 'fail-screen', 'bankrupt-screen'].forEach(id => document.getElementById(id).style.display = 'none');
      Object.assign(state, { gold: 0, lastChange: 0, patients: 0, correct: 0, missed: 0, phase: 'idle', currentPatient: null, selectedSymptoms: [], sinusitisAnswers: [] });
      document.getElementById('gold-total').textContent = '0';
      document.getElementById('gold-change').className = 'gold-change neutral';
      document.getElementById('gold-change').textContent = 'No recent change';
      updateStats(); clearChart();
      ['test-patients', 'test-correct', 'test-missed'].forEach(id => document.getElementById(id).value = 0);
      document.getElementById('dialog-box').innerHTML = '';
      addDialog('system', null, 'üë©‚Äç‚öïÔ∏è Welcome to the Emergency Room, Dr. Kim.');
      addDialog('system', null, 'Press "Next Patient" to begin.');
      document.getElementById('button-area').innerHTML = `
        <div style="text-align:center;margin-bottom:15px;color:#4ecdc4;font-size:1rem;">üéØ Challenge: Correctly diagnose 95+ out of 100 patients to become a star intern!</div>
        <div class="action-buttons"><button class="action-btn primary" onclick="startNewPatient()">ü©∫ Next Patient</button></div>
      `;
    }
    
    addDialog('system', null, 'Press "Next Patient" to begin.');
  </script>
</body>
</html>
