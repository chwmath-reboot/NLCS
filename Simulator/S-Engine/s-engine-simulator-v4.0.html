<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S-Engine æˆ°é¬ª è©¦æ¼”å™¨ v4 - ë‹¤ìˆ˜ì „</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
      color: #e0e0e0;
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      padding: 15px 10px;
      font-size: 14px;
    }
    
    .container { max-width: 1600px; margin: 0 auto; }
    
    header { text-align: center; margin-bottom: 15px; }
    
    h1 {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.8rem;
      background: linear-gradient(135deg, #ffd700 0%, #ff6b35 50%, #ffd700 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle { color: #888; font-size: 0.8rem; }
    
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 350px 1fr;
      gap: 12px;
      align-items: start;
    }
    
    @media (max-width: 1200px) {
      .main-layout { 
        grid-template-columns: 1fr; 
      }
    }
    
    /* íŒ€ ì˜ì—­ */
    .team {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .team-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 4px;
    }
    
    .team-header.ally {
      background: rgba(231,76,60,0.15);
      border: 1px solid rgba(231,76,60,0.3);
    }
    
    .team-header.enemy {
      background: rgba(52,152,219,0.15);
      border: 1px solid rgba(52,152,219,0.3);
    }
    
    .team-header h2 {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.1rem;
    }
    
    .team-header.ally h2 { color: #e74c3c; }
    .team-header.enemy h2 { color: #3498db; }
    
    .btn-add {
      padding: 4px 12px;
      font-size: 0.8rem;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: #aaa;
      cursor: pointer;
    }
    
    .btn-add:hover { background: rgba(255,255,255,0.2); }
    .btn-add:disabled { opacity: 0.3; cursor: not-allowed; }
    
    /* ìºë¦­í„° ì¹´ë“œ */
    .char-card {
      border-radius: 8px;
      padding: 10px;
      position: relative;
    }
    
    .char-card.ally {
      background: linear-gradient(135deg, rgba(231,76,60,0.08) 0%, rgba(231,76,60,0.02) 100%);
      border: 1px solid rgba(231,76,60,0.25);
    }
    
    .char-card.enemy {
      background: linear-gradient(135deg, rgba(52,152,219,0.08) 0%, rgba(52,152,219,0.02) 100%);
      border: 1px solid rgba(52,152,219,0.25);
    }
    
    .char-card.dead {
      opacity: 0.4;
      filter: grayscale(0.8);
    }
    
    .char-card.flee-warning {
      box-shadow: 0 0 10px rgba(243,156,18,0.5);
    }
    
    .btn-remove {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 20px;
      height: 20px;
      padding: 0;
      font-size: 14px;
      line-height: 18px;
      background: rgba(255,0,0,0.2);
      border: 1px solid rgba(255,0,0,0.3);
      border-radius: 50%;
      color: #e74c3c;
      cursor: pointer;
    }
    
    .btn-remove:hover { background: rgba(255,0,0,0.4); }
    
    .char-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .char-header input {
      flex: 1;
      padding: 4px 8px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      color: #fff;
      font-size: 0.85rem;
    }
    
    .char-status {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(46,204,113,0.2);
      color: #2ecc71;
    }
    
    .char-status.dead {
      background: rgba(231,76,60,0.2);
      color: #e74c3c;
    }
    
    .char-status.flee {
      background: rgba(243,156,18,0.2);
      color: #f39c12;
    }
    
    .char-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 8px;
    }
    
    .char-grid select {
      width: 100%;
      padding: 4px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      color: #fff;
      font-size: 0.75rem;
    }
    
    .char-grid label {
      display: block;
      font-size: 0.65rem;
      color: #888;
      margin-bottom: 2px;
    }
    
    .stat-bars {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    
    .stat-bar {
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      padding: 4px 6px;
    }
    
    .stat-bar .label {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      margin-bottom: 2px;
    }
    
    .stat-bar .track {
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .stat-bar .fill {
      height: 100%;
      transition: width 0.3s;
    }
    
    .stat-bar .fill.hp { background: linear-gradient(90deg, #c0392b, #e74c3c); }
    .stat-bar .fill.ng { background: linear-gradient(90deg, #2980b9, #3498db); }
    
    .char-power {
      margin-top: 6px;
      padding: 4px 6px;
      background: rgba(155,89,182,0.1);
      border-radius: 4px;
      font-size: 0.7rem;
      display: flex;
      justify-content: space-between;
    }
    
    .highlight-red { color: #e74c3c; }
    .highlight-blue { color: #3498db; }
    .highlight-gold { color: #ffd700; }
    .highlight-purple { color: #9b59b6; }
    .highlight-green { color: #2ecc71; }
    
    /* ì¤‘ì•™ ì „íˆ¬ ì˜ì—­ */
    .battle-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .battle-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .btn {
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover { transform: scale(1.03); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-battle { background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; }
    .btn-auto { background: linear-gradient(135deg, #f39c12, #d68910); color: #fff; }
    .btn-stop { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: #fff; }
    .btn-reset { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #aaa; }
    
    .battle-log-container {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      height: 500px;
    }
    
    .log-header {
      padding: 8px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .log-header h3 {
      color: #ffd700;
      font-family: 'Noto Serif KR', serif;
      font-size: 0.95rem;
    }
    
    .round-counter {
      background: rgba(255,215,0,0.2);
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      color: #ffd700;
    }
    
    .log-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      font-family: 'D2Coding', monospace;
      font-size: 0.75rem;
      line-height: 1.4;
    }
    
    .log-line { margin-bottom: 1px; color: #bbb; }
    .log-line.title { color: #ffd700; font-weight: bold; }
    .log-line.danger { color: #e74c3c; }
    .log-line.warning { color: #f39c12; }
    .log-line.success { color: #2ecc71; }
    .log-line.info { color: #3498db; }
    .log-line.skill { color: #9b59b6; }
    .log-line.round-title { 
      color: #fff; 
      background: rgba(255,255,255,0.1); 
      padding: 2px 6px; 
      border-radius: 3px;
      margin: 4px 0;
    }
    
    .battle-result {
      padding: 10px;
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }
    
    .result-text {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.1rem;
    }
    
    .result-winner { color: #ffd700; }
    .result-draw { color: #9b59b6; }
    
    /* íƒ€ê²ŸíŒ… ëª¨ë“œ */
    .targeting-mode {
      padding: 6px 10px;
      background: rgba(255,215,0,0.1);
      border: 1px solid rgba(255,215,0,0.3);
      border-radius: 6px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .targeting-mode label { color: #ffd700; }
    .targeting-mode select {
      padding: 3px 6px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: #fff;
      font-size: 0.75rem;
    }
    
    footer {
      text-align: center;
      margin-top: 15px;
      color: #555;
      font-size: 0.7rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>S-Engine æˆ°é¬ª è©¦æ¼”å™¨</h1>
      <p class="subtitle">v4.0 - ë‹¤ìˆ˜ vs ë‹¤ìˆ˜ (ìµœëŒ€ 3 vs 3)</p>
    </header>
    
    <div class="main-layout">
      <!-- ì•„êµ° íŒ€ -->
      <div class="team" id="ally-team">
        <div class="team-header ally">
          <h2>âš”ï¸ ì•„êµ°</h2>
          <button class="btn-add" onclick="addCharacter('ally')">+ ì¶”ê°€</button>
        </div>
        <div id="ally-chars"></div>
      </div>
      
      <!-- ì¤‘ì•™ ì „íˆ¬ ì˜ì—­ -->
      <div class="battle-area">
        <div class="battle-controls">
          <button class="btn btn-battle" onclick="executeOneRound()">âš”ï¸ 1í•©</button>
          <button class="btn btn-auto" id="btn-auto" onclick="startAutoBattle()">ğŸ”„ ìë™</button>
          <button class="btn btn-stop" id="btn-stop" onclick="stopAutoBattle()" style="display:none;">â¹ï¸ ì¤‘ì§€</button>
          <button class="btn btn-reset" onclick="resetBattle()">â†º ì´ˆê¸°í™”</button>
        </div>
        
        <div class="targeting-mode">
          <label>íƒ€ê²ŸíŒ…:</label>
          <select id="targeting-mode">
            <option value="weakest">ì•½í•œ ì  ìš°ì„ </option>
            <option value="strongest">ê°•í•œ ì  ìš°ì„ </option>
            <option value="random">ë¬´ì‘ìœ„</option>
          </select>
        </div>
        
        <div class="battle-log-container">
          <div class="log-header">
            <h3>ğŸ“œ ì „íˆ¬ ê¸°ë¡</h3>
            <div class="round-counter">ì œ <span id="round-num">0</span> í•©</div>
          </div>
          <div class="log-content" id="log-content">
            <div class="log-line info">ì–‘ íŒ€ì— ìºë¦­í„°ë¥¼ ë°°ì¹˜í•˜ê³  ì „íˆ¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</div>
          </div>
          <div class="battle-result" id="battle-result" style="display: none;">
            <div class="result-text" id="result-text"></div>
          </div>
        </div>
      </div>
      
      <!-- ì êµ° íŒ€ -->
      <div class="team" id="enemy-team">
        <div class="team-header enemy">
          <h2>ğŸ›¡ï¸ ì êµ°</h2>
          <button class="btn-add" onclick="addCharacter('enemy')">+ ì¶”ê°€</button>
        </div>
        <div id="enemy-chars"></div>
      </div>
    </div>
    
    <footer>
      S-Engine Combat Simulator v4.0 by ShadowK | ê°œë°œìš© ì‹œë®¬ë ˆì´í„°
    </footer>
  </div>
  
  <script>
    // ===== ë°ì´í„° =====
    const GYEONGJI = {
      'ì‚¼ë¥˜': { level: 1, speed: Math.sqrt(1), label: 'ä¸‰æµ' },
      'ì´ë¥˜': { level: 2, speed: Math.sqrt(2), label: 'äºŒæµ' },
      'ì¼ë¥˜': { level: 3, speed: Math.sqrt(3), label: 'ä¸€æµ' },
      'ì ˆì •': { level: 4, speed: Math.sqrt(4), label: 'çµ¶é ‚' },
      'ì´ˆì ˆì •': { level: 5, speed: Math.sqrt(5), label: 'è¶…çµ¶é ‚' },
      'í™”ê²½': { level: 6, speed: Math.sqrt(6), label: 'åŒ–å¢ƒ' },
      'í˜„ê²½': { level: 7, speed: Math.sqrt(7), label: 'ç„å¢ƒ' },
      'ìƒì‚¬ê²½': { level: 8, speed: Math.sqrt(8), label: 'ç”Ÿæ­»å¢ƒ' },
      'ìì—°ê²½': { level: 9, speed: Math.sqrt(9), label: 'è‡ªç„¶å¢ƒ' }
    };
    
    const SIMBEOP = {
      'ì‚¼ì¬ì‹¬ë²•': { chukgi: 10, stab: 90, type: 'ê¸°ë³¸' },
      'ê¸°ì´ˆì‹¬ë²•': { chukgi: 20, stab: 80, type: 'ê¸°ì´ˆ' },
      'ê¸°ë³¸ì‹¬ë²•': { chukgi: 30, stab: 70, type: 'ê¸°ë³¸' },
      'ì‹¬í™”ì‹¬ë²•': { chukgi: 40, stab: 70, type: 'ì‹¬í™”' },
      'ë¹„ì „ì‹¬ë²•': { chukgi: 70, stab: 60, type: 'ë¹„ì „' },
      'ëª…ìš´ì‹¬ë²•': { chukgi: 110, stab: 80, type: 'ì‹ ê³µLv1' },
      'ë‹¬ë§ˆì‹¬ê³µ': { chukgi: 120, stab: 80, type: 'ì‹ ê³µLv2' },
      'ì²œë§ˆì‹¬ê³µ': { chukgi: 130, stab: 70, type: 'ì‹ ê³µLv2' }
    };
    
    const THRESHOLD = { 'ê¸°ì´ˆ': 40, 'ê¸°ë³¸': 40, 'ì‹¬í™”': 40, 'ë¹„ì „': 35, 'ì‹ ê³µLv1': 30, 'ì‹ ê³µLv2': 25 };
    
    const MUGONG = {
      'ê²€ê¸°': { 1: [2,1], 2: [4,1], 3: [6,1], 4: [8,1], 5: [10,1] },
      'ê²€ì‚¬': { 1: [6,2], 2: [9,2], 3: [12,2], 4: [15,2], 5: [18,2] },
      'ê²€ê°•': { 1: [15,3], 2: [19,3], 3: [23,3], 4: [28,3], 5: [33,3] }
    };
    
    const LEVEL_NAME = ['', 'ä¸‹', 'ä¸­', 'ä¸Šä¸‹', 'ä¸Šä¸­', 'ä¸Šä¸Š'];
    const FLEE_BONUS = 15;
    
    // ===== ê²Œì„ ìƒíƒœ =====
    let gameState = {
      round: 0,
      running: false,
      interval: null,
      winner: null,
      chars: {
        ally: [],
        enemy: []
      }
    };
    
    let charIdCounter = 0;
    
    // ===== ìºë¦­í„° ìƒì„± =====
    function createCharacter(team, preset = {}) {
      const id = ++charIdCounter;
      const isAlly = team === 'ally';
      
      return {
        id,
        team,
        name: preset.name || (isAlly ? `ì•„êµ°${id}` : `ì êµ°${id}`),
        gyeongji: preset.gyeongji || (isAlly ? 'ì ˆì •' : 'ì¼ë¥˜'),
        simbeop: preset.simbeop || (isAlly ? 'ê¸°ë³¸ì‹¬ë²•' : 'ê¸°ì´ˆì‹¬ë²•'),
        bobeop: preset.bobeop || (isAlly ? 5 : 3),
        mugong: preset.mugong || (isAlly ? 'ê²€ê°•' : 'ê²€ì‚¬'),
        mugongLv: preset.mugongLv || 3,
        ungi: preset.ungi || 100,
        hp: 100,
        neigong: 100,
        maxHp: 100,
        maxNeigong: 100
      };
    }
    
    function addCharacter(team) {
      if (gameState.chars[team].length >= 3) return;
      if (gameState.round > 0) return; // ì „íˆ¬ ì¤‘ ì¶”ê°€ ë¶ˆê°€
      
      const char = createCharacter(team);
      gameState.chars[team].push(char);
      renderTeam(team);
      updateAddButtons();
    }
    
    function removeCharacter(team, id) {
      if (gameState.round > 0) return;
      gameState.chars[team] = gameState.chars[team].filter(c => c.id !== id);
      renderTeam(team);
      updateAddButtons();
    }
    
    function updateAddButtons() {
      document.querySelectorAll('.btn-add').forEach(btn => {
        const team = btn.closest('.team').id.replace('-team', '');
        btn.disabled = gameState.chars[team].length >= 3 || gameState.round > 0;
      });
    }
    
    // ===== ìºë¦­í„° ê³„ì‚° =====
    function calcChar(char) {
      const g = GYEONGJI[char.gyeongji];
      const s = SIMBEOP[char.simbeop];
      const m = MUGONG[char.mugong]?.[char.mugongLv] || [0, 0];
      
      const ungiGyeongro = Math.sqrt(s.chukgi);
      const danger = 1 / Math.sqrt(s.stab);
      const ungiRemain = 100 - char.ungi;
      
      let atkTime = 3 / g.speed;
      if (char.neigong < 70) atkTime /= Math.max(0.1, 1 - (70 - char.neigong) * 0.03);
      
      const moveSpeed = char.bobeop > 0 ? Math.sqrt(char.bobeop) : 1;
      const bobeopBonus = char.bobeop * 0.1;
      const mugongBonus = m[0] / 100;
      const cost = m[1];
      
      let basePower = ungiGyeongro * (char.ungi / 100);
      if (char.hp < 80) basePower *= (1 - (80 - char.hp) * 0.03);
      
      const totalPower = basePower * (1 + mugongBonus) * (1 + bobeopBonus);
      const threshold = THRESHOLD[s.type];
      const shouldFlee = char.neigong <= threshold + FLEE_BONUS;
      const isDead = char.neigong <= threshold || char.hp <= 0;
      
      return {
        ...char, g, s, ungiGyeongro, danger, ungiRemain, atkTime,
        moveSpeed, bobeopBonus, mugongBonus, cost, basePower, totalPower,
        threshold, shouldFlee, isDead
      };
    }
    
    // ===== ë Œë”ë§ =====
    function renderTeam(team) {
      const container = document.getElementById(`${team}-chars`);
      const isAlly = team === 'ally';
      
      container.innerHTML = gameState.chars[team].map(char => {
        const c = calcChar(char);
        const statusClass = c.isDead ? 'dead' : (c.shouldFlee ? 'flee' : '');
        const statusText = c.isDead ? 'ì „íˆ¬ë¶ˆëŠ¥' : (c.shouldFlee ? 'ë„ì£¼ê¶Œì¥' : 'ì „íˆ¬ê°€ëŠ¥');
        const cardClass = c.isDead ? 'dead' : (c.shouldFlee ? 'flee-warning' : '');
        
        return `
          <div class="char-card ${team} ${cardClass}" data-id="${char.id}">
            ${gameState.round === 0 ? `<button class="btn-remove" onclick="removeCharacter('${team}', ${char.id})">Ã—</button>` : ''}
            
            <div class="char-header">
              <input type="text" value="${char.name}" onchange="updateChar('${team}', ${char.id}, 'name', this.value)" ${gameState.round > 0 ? 'disabled' : ''}>
              <span class="char-status ${statusClass}">${statusText}</span>
            </div>
            
            <div class="char-grid">
              <div>
                <label>ê²½ì§€</label>
                <select onchange="updateChar('${team}', ${char.id}, 'gyeongji', this.value)" ${gameState.round > 0 ? 'disabled' : ''}>
                  ${Object.keys(GYEONGJI).map(g => `<option value="${g}" ${char.gyeongji === g ? 'selected' : ''}>${g}</option>`).join('')}
                </select>
              </div>
              <div>
                <label>ì‹¬ë²•</label>
                <select onchange="updateChar('${team}', ${char.id}, 'simbeop', this.value)" ${gameState.round > 0 ? 'disabled' : ''}>
                  ${Object.keys(SIMBEOP).map(s => `<option value="${s}" ${char.simbeop === s ? 'selected' : ''}>${s}</option>`).join('')}
                </select>
              </div>
              <div>
                <label>ë³´ë²• Lv${char.bobeop}</label>
                <select onchange="updateChar('${team}', ${char.id}, 'bobeop', +this.value)" ${gameState.round > 0 ? 'disabled' : ''}>
                  ${[0,1,2,3,4,5,6,7,8,9].map(b => `<option value="${b}" ${char.bobeop === b ? 'selected' : ''}>${b === 0 ? 'ì—†ìŒ' : 'Lv'+b}</option>`).join('')}
                </select>
              </div>
              <div>
                <label>ë¬´ê³µ</label>
                <select onchange="updateChar('${team}', ${char.id}, 'mugong', this.value)" ${gameState.round > 0 ? 'disabled' : ''}>
                  ${Object.keys(MUGONG).map(m => `<option value="${m}" ${char.mugong === m ? 'selected' : ''}>${m}</option>`).join('')}
                </select>
              </div>
              <div>
                <label>ìˆ™ë ¨</label>
                <select onchange="updateChar('${team}', ${char.id}, 'mugongLv', +this.value)" ${gameState.round > 0 ? 'disabled' : ''}>
                  ${[1,2,3,4,5].map(l => `<option value="${l}" ${char.mugongLv === l ? 'selected' : ''}>${LEVEL_NAME[l]}</option>`).join('')}
                </select>
              </div>
              <div>
                <label>ìš´ê¸° ${char.ungi}%</label>
                <select onchange="updateChar('${team}', ${char.id}, 'ungi', +this.value)" ${gameState.round > 0 ? 'disabled' : ''}>
                  ${[100,95,90,85,80].map(u => `<option value="${u}" ${char.ungi === u ? 'selected' : ''}>${u}%</option>`).join('')}
                </select>
              </div>
            </div>
            
            <div class="stat-bars">
              <div class="stat-bar">
                <div class="label">
                  <span>ì²´ë ¥</span>
                  <span class="highlight-red">${char.hp.toFixed(1)}</span>
                </div>
                <div class="track">
                  <div class="fill hp" style="width: ${Math.max(0, char.hp)}%"></div>
                </div>
              </div>
              <div class="stat-bar">
                <div class="label">
                  <span>ë‚´ê³µ</span>
                  <span class="highlight-blue">${char.neigong.toFixed(1)}</span>
                </div>
                <div class="track">
                  <div class="fill ng" style="width: ${Math.max(0, char.neigong)}%"></div>
                </div>
              </div>
            </div>
            
            <div class="char-power">
              <span><span class="highlight-purple">${char.mugong} ${LEVEL_NAME[char.mugongLv]}</span> (ì†Œë¹„: ${c.cost})</span>
              <span>íŒŒê´´ë ¥: <span class="highlight-gold">${c.totalPower.toFixed(1)}</span></span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function updateChar(team, id, key, value) {
      const char = gameState.chars[team].find(c => c.id === id);
      if (char) {
        char[key] = value;
        renderTeam(team);
      }
    }
    
    function renderAll() {
      renderTeam('ally');
      renderTeam('enemy');
    }
    
    // ===== ì „íˆ¬ ë¡œì§ =====
    function addLog(text, cls = '') {
      const el = document.getElementById('log-content');
      const line = document.createElement('div');
      line.className = `log-line ${cls}`;
      line.textContent = text;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }
    
    function getAliveChars(team) {
      return gameState.chars[team].filter(c => {
        const calc = calcChar(c);
        return !calc.isDead;
      });
    }
    
    function selectTarget(attacker, enemies) {
      const alive = enemies.filter(e => !calcChar(e).isDead);
      if (alive.length === 0) return null;
      
      const mode = document.getElementById('targeting-mode').value;
      
      if (mode === 'weakest') {
        return alive.reduce((a, b) => a.neigong < b.neigong ? a : b);
      } else if (mode === 'strongest') {
        return alive.reduce((a, b) => calcChar(a).totalPower > calcChar(b).totalPower ? a : b);
      } else {
        return alive[Math.floor(Math.random() * alive.length)];
      }
    }
    
    function executeOneRound() {
      if (gameState.winner) return;
      
      const allyAlive = getAliveChars('ally');
      const enemyAlive = getAliveChars('enemy');
      
      if (allyAlive.length === 0 || enemyAlive.length === 0) {
        checkWinner();
        return;
      }
      
      gameState.round++;
      document.getElementById('round-num').textContent = gameState.round;
      
      if (gameState.round === 1) {
        document.getElementById('log-content').innerHTML = '';
      }
      
      addLog(`â•â•â•â•â•â• ì œ ${gameState.round} í•© â•â•â•â•â•â•`, 'round-title');
      
      // ëª¨ë“  ìƒì¡´ ìºë¦­í„° í–‰ë™ ìˆœì„œ ì •ë ¬
      const allChars = [...allyAlive, ...enemyAlive].map(c => ({
        char: c,
        calc: calcChar(c)
      }));
      
      // ì´ë™ì†ë„ â†’ ê³µê²©ì†ë„ ìˆœ ì •ë ¬
      allChars.sort((a, b) => {
        if (b.calc.moveSpeed !== a.calc.moveSpeed) {
          return b.calc.moveSpeed - a.calc.moveSpeed;
        }
        return a.calc.atkTime - b.calc.atkTime;
      });
      
      // ìˆœì„œëŒ€ë¡œ ê³µê²©
      for (const { char, calc } of allChars) {
        // í–‰ë™ ì‹œì ì— ìƒì¡´ ì²´í¬
        const currentCalc = calcChar(char);
        if (currentCalc.isDead) continue;
        
        const enemies = char.team === 'ally' ? gameState.chars.enemy : gameState.chars.ally;
        const target = selectTarget(char, enemies);
        
        if (!target) continue;
        
        processAttack(char, target);
      }
      
      // ìƒì‚¬ê²½/ìì—°ê²½ í¡ìˆ˜
      processNeigongDrain();
      
      renderAll();
      updateAddButtons();
      checkWinner();
    }
    
    function processAttack(attacker, defender) {
      const aCalc = calcChar(attacker);
      const dCalc = calcChar(defender);
      
      if (aCalc.isDead || dCalc.isDead) return;
      
      // ë‚´ê³µ ì†Œë¹„ ì²´í¬
      if (attacker.neigong < aCalc.cost) {
        addLog(`${attacker.name}: ë‚´ê³µ ë¶€ì¡±!`, 'warning');
        return;
      }
      
      attacker.neigong -= aCalc.cost;
      
      // ëª…ì¤‘ë¥ 
      let hit = 100;
      if (attacker.neigong <= 50) {
        hit = Math.max(5, 95 - (50 - attacker.neigong) * 5);
      }
      
      if (Math.random() * 100 >= hit) {
        addLog(`${attacker.name} â†’ ${defender.name} ë¹—ë‚˜ê°! (${hit.toFixed(0)}%)`, 'warning');
        const self = aCalc.ungiRemain * aCalc.danger;
        attacker.hp -= self * 0.1;
        attacker.neigong -= self * 0.9;
        return;
      }
      
      // ê²½ì§€/ì‹¬ë²• ë³´ì •
      const gDiff = aCalc.g.level - dCalc.g.level;
      let mod = 1;
      if (gDiff < 0) mod += gDiff * 0.03;
      
      // í”¼í•´ ê³„ì‚°
      const dmg = aCalc.totalPower * 10 * mod;
      const hpDmg = dmg * 0.2;
      const ngDmg = dmg * 0.8;
      
      defender.hp -= hpDmg;
      defender.neigong -= ngDmg;
      
      addLog(`${attacker.name} [${attacker.mugong}] â†’ ${defender.name}`, 'skill');
      addLog(`  í”¼í•´: ì²´ë ¥-${hpDmg.toFixed(1)} ë‚´ê³µ-${ngDmg.toFixed(1)}`);
      
      // ìš´ê¸° ë‚´ìƒ
      const aNaesang = aCalc.ungiRemain * aCalc.danger;
      const dNaesang = dCalc.ungiRemain * dCalc.danger;
      
      if (aNaesang > 0.5) {
        attacker.hp -= aNaesang * 0.1;
        attacker.neigong -= aNaesang * 0.9;
      }
      if (dNaesang > 0.5) {
        defender.hp -= dNaesang * 0.1;
        defender.neigong -= dNaesang * 0.9;
      }
      
      // ìµœì†Œê°’ ë³´ì •
      attacker.hp = Math.max(0, attacker.hp);
      attacker.neigong = Math.max(0, attacker.neigong);
      defender.hp = Math.max(0, defender.hp);
      defender.neigong = Math.max(0, defender.neigong);
      
      // ì „íˆ¬ë¶ˆëŠ¥ ì²´í¬
      const newDCalc = calcChar(defender);
      if (newDCalc.isDead) {
        addLog(`ğŸ’€ ${defender.name} ì „íˆ¬ë¶ˆëŠ¥!`, 'danger');
      } else if (newDCalc.shouldFlee) {
        addLog(`âš ï¸ ${defender.name} ë„ì£¼ ê¶Œì¥`, 'warning');
      }
    }
    
    function processNeigongDrain() {
      const all = [...gameState.chars.ally, ...gameState.chars.enemy];
      
      for (const char of all) {
        const calc = calcChar(char);
        if (calc.isDead) continue;
        if (calc.g.level < 8) continue;
        
        const enemies = char.team === 'ally' ? gameState.chars.enemy : gameState.chars.ally;
        
        for (const enemy of enemies) {
          const eCalc = calcChar(enemy);
          if (eCalc.isDead) continue;
          if (eCalc.g.level >= calc.g.level) continue;
          
          const rate = calc.g.level === 9 ? 0.01 : 0.005;
          const drain = enemy.neigong * rate;
          enemy.neigong -= drain;
          char.neigong = Math.min(100, char.neigong + drain);
          
          if (drain > 0.1) {
            addLog(`${char.name} ë‚´ê³µí¡ìˆ˜ â† ${enemy.name}: +${drain.toFixed(2)}`, 'success');
          }
        }
      }
    }
    
    function checkWinner() {
      const allyAlive = getAliveChars('ally').length;
      const enemyAlive = getAliveChars('enemy').length;
      
      if (allyAlive === 0 && enemyAlive === 0) {
        gameState.winner = 'draw';
        showResult('âš”ï¸ ìŒë°© ì „ë©¸!', 'result-draw');
      } else if (allyAlive === 0) {
        gameState.winner = 'enemy';
        showResult(`ğŸ† ì êµ° ìŠ¹ë¦¬! (${gameState.round}í•©)`, 'result-winner');
      } else if (enemyAlive === 0) {
        gameState.winner = 'ally';
        showResult(`ğŸ† ì•„êµ° ìŠ¹ë¦¬! (${gameState.round}í•©)`, 'result-winner');
      }
      
      if (gameState.winner) stopAutoBattle();
    }
    
    function showResult(text, cls) {
      document.getElementById('battle-result').style.display = 'block';
      const el = document.getElementById('result-text');
      el.className = `result-text ${cls}`;
      el.textContent = text;
      addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'divider');
      addLog(text, 'success');
    }
    
    function startAutoBattle() {
      if (gameState.winner) return;
      if (getAliveChars('ally').length === 0 || getAliveChars('enemy').length === 0) return;
      
      gameState.running = true;
      document.getElementById('btn-auto').style.display = 'none';
      document.getElementById('btn-stop').style.display = 'inline-block';
      
      gameState.interval = setInterval(() => {
        if (gameState.winner) { stopAutoBattle(); return; }
        executeOneRound();
      }, 500);
    }
    
    function stopAutoBattle() {
      gameState.running = false;
      if (gameState.interval) {
        clearInterval(gameState.interval);
        gameState.interval = null;
      }
      document.getElementById('btn-auto').style.display = 'inline-block';
      document.getElementById('btn-stop').style.display = 'none';
    }
    
    function resetBattle() {
      stopAutoBattle();
      
      // ìƒíƒœ ì´ˆê¸°í™”
      gameState.round = 0;
      gameState.winner = null;
      
      // HP/ë‚´ê³µ ë³µêµ¬
      for (const team of ['ally', 'enemy']) {
        for (const char of gameState.chars[team]) {
          char.hp = 100;
          char.neigong = 100;
        }
      }
      
      document.getElementById('round-num').textContent = '0';
      document.getElementById('log-content').innerHTML = '<div class="log-line info">ì–‘ íŒ€ì— ìºë¦­í„°ë¥¼ ë°°ì¹˜í•˜ê³  ì „íˆ¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</div>';
      document.getElementById('battle-result').style.display = 'none';
      
      renderAll();
      updateAddButtons();
    }
    
    // ===== ì´ˆê¸°í™” =====
    function init() {
      // ê¸°ë³¸ ìºë¦­í„° ë°°ì¹˜
      gameState.chars.ally.push(createCharacter('ally', { name: 'ê²€í˜¸', gyeongji: 'ì ˆì •', simbeop: 'ê¸°ë³¸ì‹¬ë²•', mugong: 'ê²€ê°•', mugongLv: 3, bobeop: 5 }));
      gameState.chars.enemy.push(createCharacter('enemy', { name: 'ë„ì 1', gyeongji: 'ì¼ë¥˜', simbeop: 'ê¸°ì´ˆì‹¬ë²•', mugong: 'ê²€ì‚¬', mugongLv: 2, bobeop: 3 }));
      gameState.chars.enemy.push(createCharacter('enemy', { name: 'ë„ì 2', gyeongji: 'ì´ë¥˜', simbeop: 'ê¸°ì´ˆì‹¬ë²•', mugong: 'ê²€ê¸°', mugongLv: 2, bobeop: 2 }));
      gameState.chars.enemy.push(createCharacter('enemy', { name: 'ë„ì 3', gyeongji: 'ì´ë¥˜', simbeop: 'ê¸°ì´ˆì‹¬ë²•', mugong: 'ê²€ê¸°', mugongLv: 1, bobeop: 1 }));
      
      renderAll();
      updateAddButtons();
    }
    
    init();
  </script>
</body>
</html>
