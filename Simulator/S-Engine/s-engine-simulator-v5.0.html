<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S-Engine æˆ°é¬ª è©¦æ¼”å™¨ v5 - ì‹¤ì‹œê°„ ìš´ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
      color: #e0e0e0;
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      padding: 15px 10px;
      font-size: 14px;
    }
    
    .container { max-width: 1400px; margin: 0 auto; }
    
    header { text-align: center; margin-bottom: 15px; }
    
    h1 {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.8rem;
      background: linear-gradient(135deg, #ffd700 0%, #ff6b35 50%, #ffd700 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle { color: #888; font-size: 0.8rem; }
    
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 420px 1fr;
      gap: 15px;
      align-items: start;
    }
    
    @media (max-width: 1200px) {
      .main-layout { grid-template-columns: 1fr; }
    }
    
    /* ìºë¦­í„° íŒ¨ë„ */
    .char-panel {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 15px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .char-panel.ally { border-color: rgba(231,76,60,0.3); }
    .char-panel.enemy { border-color: rgba(52,152,219,0.3); }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .panel-header h2 {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.1rem;
    }
    
    .panel-header.ally h2 { color: #e74c3c; }
    .panel-header.enemy h2 { color: #3498db; }
    
    .char-name {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .char-name.ally { color: #e74c3c; }
    .char-name.enemy { color: #3498db; }
    
    .char-config {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .config-item label {
      display: block;
      font-size: 0.7rem;
      color: #888;
      margin-bottom: 2px;
    }
    
    .config-item select, .config-item input {
      width: 100%;
      padding: 5px 8px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 4px;
      color: #fff;
      font-size: 0.8rem;
    }
    
    /* ìš´ê¸° ê²Œì´ì§€ - í•µì‹¬ UI */
    .ungi-section {
      background: rgba(0,0,0,0.4);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .ungi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .ungi-label {
      font-size: 0.85rem;
      color: #ffd700;
      font-weight: bold;
    }
    
    .ungi-value {
      font-size: 1.2rem;
      font-weight: bold;
      font-family: 'D2Coding', monospace;
    }
    
    .ungi-value.ready { color: #2ecc71; }
    .ungi-value.charging { color: #f39c12; }
    .ungi-value.low { color: #e74c3c; }
    
    .ungi-bar-container {
      position: relative;
      height: 24px;
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .ungi-bar {
      height: 100%;
      border-radius: 12px;
      transition: width 0.05s linear;
      position: relative;
    }
    
    .ungi-bar.ally {
      background: linear-gradient(90deg, #c0392b 0%, #e74c3c 50%, #f39c12 100%);
    }
    
    .ungi-bar.enemy {
      background: linear-gradient(90deg, #2980b9 0%, #3498db 50%, #1abc9c 100%);
    }
    
    .ungi-bar.ready {
      box-shadow: 0 0 15px rgba(46,204,113,0.8);
    }
    
    /* 80% ê¸°ì¤€ì„  */
    .ungi-threshold {
      position: absolute;
      left: 80%;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #2ecc71;
      z-index: 10;
    }
    
    .ungi-threshold::after {
      content: '80%';
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      color: #2ecc71;
    }
    
    .ungi-status {
      text-align: center;
      margin-top: 6px;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .ungi-status.ready { color: #2ecc71; }
    .ungi-status.charging { color: #f39c12; }
    
    /* ìŠ¤íƒ¯ ë°” */
    .stat-bars {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .stat-bar {
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
      padding: 6px 8px;
    }
    
    .stat-bar .label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      margin-bottom: 4px;
    }
    
    .stat-bar .track {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .stat-bar .fill { height: 100%; transition: width 0.3s; }
    .stat-bar .fill.hp { background: linear-gradient(90deg, #c0392b, #e74c3c); }
    .stat-bar .fill.ng { background: linear-gradient(90deg, #2980b9, #3498db); }
    
    .char-info {
      margin-top: 10px;
      padding: 8px;
      background: rgba(155,89,182,0.1);
      border-radius: 6px;
      font-size: 0.7rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
    }
    
    .info-item span:first-child { color: #888; }
    .info-item span:last-child { color: #fff; font-weight: bold; }
    
    /* ì¤‘ì•™ ì „íˆ¬ ì˜ì—­ */
    .battle-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .battle-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .btn {
      padding: 10px 20px;
      font-size: 0.9rem;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover { transform: scale(1.03); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-start { background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; }
    .btn-stop { background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; }
    .btn-reset { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #aaa; }
    
    .speed-control {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      font-size: 0.8rem;
    }
    
    .speed-control label { color: #888; }
    .speed-control select {
      padding: 4px 8px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: #fff;
    }
    
    /* ì „íˆ¬ ë¡œê·¸ */
    .battle-log-container {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      height: 450px;
    }
    
    .log-header {
      padding: 10px 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .log-header h3 {
      color: #ffd700;
      font-family: 'Noto Serif KR', serif;
      font-size: 1rem;
    }
    
    .log-stats {
      display: flex;
      gap: 10px;
      font-size: 0.75rem;
    }
    
    .log-stats span {
      padding: 3px 8px;
      border-radius: 4px;
    }
    
    .log-stats .time { background: rgba(155,89,182,0.2); color: #9b59b6; }
    .log-stats .round { background: rgba(255,215,0,0.2); color: #ffd700; }
    
    .log-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      font-family: 'D2Coding', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
    }
    
    .log-line { margin-bottom: 2px; color: #bbb; }
    .log-line.attack { color: #e74c3c; }
    .log-line.defend { color: #3498db; }
    .log-line.damage { color: #f39c12; }
    .log-line.naesang { color: #9b59b6; }
    .log-line.ready { color: #2ecc71; font-weight: bold; }
    .log-line.info { color: #888; font-style: italic; }
    .log-line.critical { color: #e74c3c; font-weight: bold; background: rgba(231,76,60,0.1); padding: 2px 4px; border-radius: 3px; }
    
    .battle-result {
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }
    
    .result-text {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.2rem;
      color: #ffd700;
    }
    
    /* ì „íˆ¬ ì‹œê°í™” */
    .battle-visual {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
    }
    
    .visual-title {
      text-align: center;
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 10px;
    }
    
    .clash-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }
    
    .fighter {
      flex: 1;
      text-align: center;
    }
    
    .fighter-icon {
      font-size: 2rem;
      margin-bottom: 5px;
    }
    
    .fighter-name {
      font-size: 0.85rem;
      font-weight: bold;
    }
    
    .fighter-name.ally { color: #e74c3c; }
    .fighter-name.enemy { color: #3498db; }
    
    .vs-icon {
      font-size: 1.5rem;
      color: #ffd700;
      font-weight: bold;
    }
    
    .action-indicator {
      margin-top: 5px;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .action-indicator.attacking {
      background: rgba(231,76,60,0.3);
      color: #e74c3c;
      animation: pulse 0.5s infinite;
    }
    
    .action-indicator.defending {
      background: rgba(52,152,219,0.3);
      color: #3498db;
    }
    
    .action-indicator.charging {
      background: rgba(243,156,18,0.3);
      color: #f39c12;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    footer {
      text-align: center;
      margin-top: 15px;
      color: #555;
      font-size: 0.7rem;
    }
    
    .highlight-red { color: #e74c3c; }
    .highlight-blue { color: #3498db; }
    .highlight-gold { color: #ffd700; }
    .highlight-green { color: #2ecc71; }
    .highlight-purple { color: #9b59b6; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>S-Engine æˆ°é¬ª è©¦æ¼”å™¨</h1>
      <p class="subtitle">v5.0 - ì‹¤ì‹œê°„ ìš´ê¸° ì‹œìŠ¤í…œ | ìš´ê¸° 80% ì´ìƒì‹œ ê³µê²© ê°€ëŠ¥</p>
    </header>
    
    <div class="main-layout">
      <!-- ì•„êµ° íŒ¨ë„ -->
      <div class="char-panel ally">
        <div class="panel-header ally">
          <h2>âš”ï¸ ì•„êµ°</h2>
          <span class="char-status" id="ally-status">ëŒ€ê¸°</span>
        </div>
        
        <div class="char-name ally" id="ally-name">ê²€í˜¸</div>
        
        <div class="char-config">
          <div class="config-item">
            <label>ê²½ì§€</label>
            <select id="ally-gyeongji" onchange="updateChar('ally')">
              <option value="ì‚¼ë¥˜">ì‚¼ë¥˜ (âˆš1)</option>
              <option value="ì´ë¥˜">ì´ë¥˜ (âˆš2)</option>
              <option value="ì¼ë¥˜">ì¼ë¥˜ (âˆš3)</option>
              <option value="ì ˆì •" selected>ì ˆì • (âˆš4)</option>
              <option value="ì´ˆì ˆì •">ì´ˆì ˆì • (âˆš5)</option>
              <option value="í™”ê²½">í™”ê²½ (âˆš6)</option>
              <option value="í˜„ê²½">í˜„ê²½ (âˆš7)</option>
              <option value="ìƒì‚¬ê²½">ìƒì‚¬ê²½ (âˆš8)</option>
              <option value="ìì—°ê²½">ìì—°ê²½ (âˆš9)</option>
            </select>
          </div>
          <div class="config-item">
            <label>ì‹¬ë²•</label>
            <select id="ally-simbeop" onchange="updateChar('ally')">
              <option value="ì‚¼ì¬ì‹¬ë²•">ì‚¼ì¬ (10/90)</option>
              <option value="ê¸°ì´ˆì‹¬ë²•">ê¸°ì´ˆ (20/80)</option>
              <option value="ê¸°ë³¸ì‹¬ë²•" selected>ê¸°ë³¸ (30/70)</option>
              <option value="ì‹¬í™”ì‹¬ë²•">ì‹¬í™” (40/70)</option>
              <option value="ë¹„ì „ì‹¬ë²•">ë¹„ì „ (70/60)</option>
              <option value="ëª…ìš´ì‹¬ë²•">ëª…ìš´ (110/80)</option>
              <option value="ì²œë§ˆì‹¬ê³µ">ì²œë§ˆ (130/70)</option>
            </select>
          </div>
        </div>
        
        <!-- ìš´ê¸° ê²Œì´ì§€ -->
        <div class="ungi-section">
          <div class="ungi-header">
            <span class="ungi-label">ğŸŒ€ ìš´ê¸° ì§„í–‰ë„</span>
            <span class="ungi-value charging" id="ally-ungi-value">0%</span>
          </div>
          <div class="ungi-bar-container">
            <div class="ungi-threshold"></div>
            <div class="ungi-bar ally" id="ally-ungi-bar" style="width: 0%"></div>
          </div>
          <div class="ungi-status charging" id="ally-ungi-status">ìš´ê¸° ì¶©ì „ ì¤‘...</div>
        </div>
        
        <div class="stat-bars">
          <div class="stat-bar">
            <div class="label">
              <span>ì²´ë ¥</span>
              <span class="highlight-red" id="ally-hp">100.0</span>
            </div>
            <div class="track">
              <div class="fill hp" id="ally-hp-bar" style="width: 100%"></div>
            </div>
          </div>
          <div class="stat-bar">
            <div class="label">
              <span>ë‚´ê³µ</span>
              <span class="highlight-blue" id="ally-ng">100.0</span>
            </div>
            <div class="track">
              <div class="fill ng" id="ally-ng-bar" style="width: 100%"></div>
            </div>
          </div>
        </div>
        
        <div class="char-info">
          <div class="info-item"><span>ê³µê²©ì†ë„:</span> <span id="ally-atkspd">1.50ì´ˆ</span></div>
          <div class="info-item"><span>ìš´ê¸°ê²½ë¡œ:</span> <span id="ally-ungi-path">âˆš30</span></div>
          <div class="info-item"><span>ìš´ê¸°ìœ„í—˜:</span> <span id="ally-danger">0.12</span></div>
          <div class="info-item"><span>íŒŒê´´ë ¥:</span> <span id="ally-power">5.48</span></div>
        </div>
      </div>
      
      <!-- ì¤‘ì•™ ì „íˆ¬ ì˜ì—­ -->
      <div class="battle-area">
        <div class="battle-visual">
          <div class="visual-title">âš”ï¸ ì „íˆ¬ ìƒí™©</div>
          <div class="clash-display">
            <div class="fighter">
              <div class="fighter-icon">ğŸ—¡ï¸</div>
              <div class="fighter-name ally">ê²€í˜¸</div>
              <div class="action-indicator charging" id="ally-action">ìš´ê¸° ì¤‘</div>
            </div>
            <div class="vs-icon">âš”ï¸</div>
            <div class="fighter">
              <div class="fighter-icon">ğŸ›¡ï¸</div>
              <div class="fighter-name enemy">ë„ì </div>
              <div class="action-indicator charging" id="enemy-action">ìš´ê¸° ì¤‘</div>
            </div>
          </div>
        </div>
        
        <div class="battle-controls">
          <button class="btn btn-start" id="btn-start" onclick="startBattle()">â–¶ï¸ ì „íˆ¬ ì‹œì‘</button>
          <button class="btn btn-stop" id="btn-stop" onclick="stopBattle()" style="display:none;">â¹ï¸ ì¤‘ì§€</button>
          <button class="btn btn-reset" onclick="resetBattle()">â†º ì´ˆê¸°í™”</button>
        </div>
        
        <div class="speed-control">
          <label>â±ï¸ ì‹œë®¬ ì†ë„:</label>
          <select id="sim-speed">
            <option value="0.5">0.5x (ëŠë¦¼)</option>
            <option value="1" selected>1x (ì‹¤ì‹œê°„)</option>
            <option value="2">2x (ë¹ ë¦„)</option>
            <option value="5">5x (ê³ ì†)</option>
          </select>
        </div>
        
        <div class="battle-log-container">
          <div class="log-header">
            <h3>ğŸ“œ ì „íˆ¬ ê¸°ë¡</h3>
            <div class="log-stats">
              <span class="time">â±ï¸ <span id="battle-time">0.0</span>ì´ˆ</span>
              <span class="round">ğŸ’¥ <span id="attack-count">0</span>íšŒ êµì „</span>
            </div>
          </div>
          <div class="log-content" id="log-content">
            <div class="log-line info">ì „íˆ¬ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‹¤ì‹œê°„ ìš´ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</div>
            <div class="log-line info">ìš´ê¸° 80% ì´ìƒì´ ë˜ë©´ ê³µê²©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
            <div class="log-line info">ìƒëŒ€ë³´ë‹¤ ë¨¼ì € 80%ì— ë„ë‹¬í•˜ë©´ ì„ ê³µ!</div>
          </div>
          <div class="battle-result" id="battle-result" style="display: none;">
            <div class="result-text" id="result-text"></div>
          </div>
        </div>
      </div>
      
      <!-- ì êµ° íŒ¨ë„ -->
      <div class="char-panel enemy">
        <div class="panel-header enemy">
          <h2>ğŸ›¡ï¸ ì êµ°</h2>
          <span class="char-status" id="enemy-status">ëŒ€ê¸°</span>
        </div>
        
        <div class="char-name enemy" id="enemy-name">ë„ì </div>
        
        <div class="char-config">
          <div class="config-item">
            <label>ê²½ì§€</label>
            <select id="enemy-gyeongji" onchange="updateChar('enemy')">
              <option value="ì‚¼ë¥˜">ì‚¼ë¥˜ (âˆš1)</option>
              <option value="ì´ë¥˜">ì´ë¥˜ (âˆš2)</option>
              <option value="ì¼ë¥˜" selected>ì¼ë¥˜ (âˆš3)</option>
              <option value="ì ˆì •">ì ˆì • (âˆš4)</option>
              <option value="ì´ˆì ˆì •">ì´ˆì ˆì • (âˆš5)</option>
              <option value="í™”ê²½">í™”ê²½ (âˆš6)</option>
              <option value="í˜„ê²½">í˜„ê²½ (âˆš7)</option>
              <option value="ìƒì‚¬ê²½">ìƒì‚¬ê²½ (âˆš8)</option>
              <option value="ìì—°ê²½">ìì—°ê²½ (âˆš9)</option>
            </select>
          </div>
          <div class="config-item">
            <label>ì‹¬ë²•</label>
            <select id="enemy-simbeop" onchange="updateChar('enemy')">
              <option value="ì‚¼ì¬ì‹¬ë²•">ì‚¼ì¬ (10/90)</option>
              <option value="ê¸°ì´ˆì‹¬ë²•" selected>ê¸°ì´ˆ (20/80)</option>
              <option value="ê¸°ë³¸ì‹¬ë²•">ê¸°ë³¸ (30/70)</option>
              <option value="ì‹¬í™”ì‹¬ë²•">ì‹¬í™” (40/70)</option>
              <option value="ë¹„ì „ì‹¬ë²•">ë¹„ì „ (70/60)</option>
              <option value="ëª…ìš´ì‹¬ë²•">ëª…ìš´ (110/80)</option>
              <option value="ì²œë§ˆì‹¬ê³µ">ì²œë§ˆ (130/70)</option>
            </select>
          </div>
        </div>
        
        <!-- ìš´ê¸° ê²Œì´ì§€ -->
        <div class="ungi-section">
          <div class="ungi-header">
            <span class="ungi-label">ğŸŒ€ ìš´ê¸° ì§„í–‰ë„</span>
            <span class="ungi-value charging" id="enemy-ungi-value">0%</span>
          </div>
          <div class="ungi-bar-container">
            <div class="ungi-threshold"></div>
            <div class="ungi-bar enemy" id="enemy-ungi-bar" style="width: 0%"></div>
          </div>
          <div class="ungi-status charging" id="enemy-ungi-status">ìš´ê¸° ì¶©ì „ ì¤‘...</div>
        </div>
        
        <div class="stat-bars">
          <div class="stat-bar">
            <div class="label">
              <span>ì²´ë ¥</span>
              <span class="highlight-red" id="enemy-hp">100.0</span>
            </div>
            <div class="track">
              <div class="fill hp" id="enemy-hp-bar" style="width: 100%"></div>
            </div>
          </div>
          <div class="stat-bar">
            <div class="label">
              <span>ë‚´ê³µ</span>
              <span class="highlight-blue" id="enemy-ng">100.0</span>
            </div>
            <div class="track">
              <div class="fill ng" id="enemy-ng-bar" style="width: 100%"></div>
            </div>
          </div>
        </div>
        
        <div class="char-info">
          <div class="info-item"><span>ê³µê²©ì†ë„:</span> <span id="enemy-atkspd">1.73ì´ˆ</span></div>
          <div class="info-item"><span>ìš´ê¸°ê²½ë¡œ:</span> <span id="enemy-ungi-path">âˆš20</span></div>
          <div class="info-item"><span>ìš´ê¸°ìœ„í—˜:</span> <span id="enemy-danger">0.11</span></div>
          <div class="info-item"><span>íŒŒê´´ë ¥:</span> <span id="enemy-power">4.47</span></div>
        </div>
      </div>
    </div>
    
    <footer>
      S-Engine Combat Simulator v5.0 by ShadowK | ì‹¤ì‹œê°„ ìš´ê¸° ì‹œìŠ¤í…œ | 80% ì´ìƒ ê³µê²© ê°€ëŠ¥
    </footer>
  </div>
  
  <script>
    // ===== ë°ì´í„° =====
    const GYEONGJI = {
      'ì‚¼ë¥˜': { level: 1, speed: Math.sqrt(1) },
      'ì´ë¥˜': { level: 2, speed: Math.sqrt(2) },
      'ì¼ë¥˜': { level: 3, speed: Math.sqrt(3) },
      'ì ˆì •': { level: 4, speed: Math.sqrt(4) },
      'ì´ˆì ˆì •': { level: 5, speed: Math.sqrt(5) },
      'í™”ê²½': { level: 6, speed: Math.sqrt(6) },
      'í˜„ê²½': { level: 7, speed: Math.sqrt(7) },
      'ìƒì‚¬ê²½': { level: 8, speed: Math.sqrt(8) },
      'ìì—°ê²½': { level: 9, speed: Math.sqrt(9) }
    };
    
    const SIMBEOP = {
      'ì‚¼ì¬ì‹¬ë²•': { chukgi: 10, stab: 90, type: 'ê¸°ë³¸' },
      'ê¸°ì´ˆì‹¬ë²•': { chukgi: 20, stab: 80, type: 'ê¸°ì´ˆ' },
      'ê¸°ë³¸ì‹¬ë²•': { chukgi: 30, stab: 70, type: 'ê¸°ë³¸' },
      'ì‹¬í™”ì‹¬ë²•': { chukgi: 40, stab: 70, type: 'ì‹¬í™”' },
      'ë¹„ì „ì‹¬ë²•': { chukgi: 70, stab: 60, type: 'ë¹„ì „' },
      'ëª…ìš´ì‹¬ë²•': { chukgi: 110, stab: 80, type: 'ì‹ ê³µLv1' },
      'ì²œë§ˆì‹¬ê³µ': { chukgi: 130, stab: 70, type: 'ì‹ ê³µLv2' }
    };
    
    const THRESHOLD = { 'ê¸°ì´ˆ': 40, 'ê¸°ë³¸': 40, 'ì‹¬í™”': 40, 'ë¹„ì „': 35, 'ì‹ ê³µLv1': 30, 'ì‹ ê³µLv2': 25 };
    
    // ===== ê²Œì„ ìƒíƒœ =====
    let state = {
      running: false,
      time: 0,
      attackCount: 0,
      winner: null,
      animFrame: null,
      lastTime: 0,
      
      ally: {
        gyeongji: 'ì ˆì •',
        simbeop: 'ê¸°ë³¸ì‹¬ë²•',
        hp: 100,
        neigong: 100,
        ungi: 0,  // ì‹¤ì‹œê°„ ìš´ê¸° ì§„í–‰ë„ (0~100)
        canAttack: false
      },
      
      enemy: {
        gyeongji: 'ì¼ë¥˜',
        simbeop: 'ê¸°ì´ˆì‹¬ë²•',
        hp: 100,
        neigong: 100,
        ungi: 0,
        canAttack: false
      }
    };
    
    // ===== ê³„ì‚° í•¨ìˆ˜ =====
    function getCharStats(side) {
      const char = state[side];
      const g = GYEONGJI[char.gyeongji];
      const s = SIMBEOP[char.simbeop];
      
      // ê³µê²© ì‹œê°„ (âˆš1 = 3ì´ˆ ê¸°ì¤€)
      const atkTime = 3 / g.speed;
      
      // ìš´ê¸°ê²½ë¡œ = âˆšì¶•ê¸°ì†ë„
      const ungiPath = Math.sqrt(s.chukgi);
      
      // ìš´ê¸°ìœ„í—˜ì„± = 1 / âˆšì•ˆì •ì„±
      const danger = 1 / Math.sqrt(s.stab);
      
      // ìš´ê¸° ì¶©ì „ ì†ë„ (100% ì±„ìš°ëŠ”ë° ê±¸ë¦¬ëŠ” ì‹œê°„ = ê³µê²©ì‹œê°„)
      // ì´ˆë‹¹ ìš´ê¸° ì¦ê°€ëŸ‰ = 100 / atkTime
      const ungiPerSec = 100 / atkTime;
      
      // íŒŒê´´ë ¥ = ìš´ê¸°ê²½ë¡œ Ã— (ìš´ê¸°ì§„í–‰ë„/100)
      const power = ungiPath * (char.ungi / 100);
      
      // ì „íˆ¬ë¶ˆëŠ¥ ê¸°ì¤€
      const threshold = THRESHOLD[s.type];
      const isDead = char.neigong <= threshold || char.hp <= 0;
      
      return { g, s, atkTime, ungiPath, danger, ungiPerSec, power, threshold, isDead };
    }
    
    // ===== UI ì—…ë°ì´íŠ¸ =====
    function updateUI() {
      ['ally', 'enemy'].forEach(side => {
        const char = state[side];
        const stats = getCharStats(side);
        
        // ìš´ê¸° ê²Œì´ì§€
        const ungiBar = document.getElementById(`${side}-ungi-bar`);
        const ungiValue = document.getElementById(`${side}-ungi-value`);
        const ungiStatus = document.getElementById(`${side}-ungi-status`);
        
        ungiBar.style.width = `${Math.min(100, char.ungi)}%`;
        ungiValue.textContent = `${char.ungi.toFixed(1)}%`;
        
        if (char.ungi >= 80) {
          ungiBar.classList.add('ready');
          ungiValue.className = 'ungi-value ready';
          ungiStatus.className = 'ungi-status ready';
          ungiStatus.textContent = 'âš”ï¸ ê³µê²© ê°€ëŠ¥!';
        } else {
          ungiBar.classList.remove('ready');
          ungiValue.className = 'ungi-value charging';
          ungiStatus.className = 'ungi-status charging';
          ungiStatus.textContent = `ìš´ê¸° ì¶©ì „ ì¤‘... (${(80 - char.ungi).toFixed(1)}% ë‚¨ìŒ)`;
        }
        
        // ì²´ë ¥/ë‚´ê³µ
        document.getElementById(`${side}-hp`).textContent = char.hp.toFixed(1);
        document.getElementById(`${side}-ng`).textContent = char.neigong.toFixed(1);
        document.getElementById(`${side}-hp-bar`).style.width = `${Math.max(0, char.hp)}%`;
        document.getElementById(`${side}-ng-bar`).style.width = `${Math.max(0, char.neigong)}%`;
        
        // ì •ë³´
        document.getElementById(`${side}-atkspd`).textContent = `${stats.atkTime.toFixed(2)}ì´ˆ`;
        document.getElementById(`${side}-ungi-path`).textContent = `âˆš${SIMBEOP[char.simbeop].chukgi}`;
        document.getElementById(`${side}-danger`).textContent = stats.danger.toFixed(3);
        document.getElementById(`${side}-power`).textContent = stats.power.toFixed(2);
        
        // ì•¡ì…˜ ì¸ë””ì¼€ì´í„°
        const action = document.getElementById(`${side}-action`);
        if (stats.isDead) {
          action.className = 'action-indicator';
          action.textContent = 'ì „íˆ¬ë¶ˆëŠ¥';
          action.style.background = 'rgba(231,76,60,0.3)';
          action.style.color = '#e74c3c';
        } else if (char.ungi >= 80) {
          action.className = 'action-indicator attacking';
          action.textContent = 'ê³µê²© ì¤€ë¹„!';
        } else {
          action.className = 'action-indicator charging';
          action.textContent = `ìš´ê¸° ${char.ungi.toFixed(0)}%`;
        }
      });
      
      // ì‹œê°„/êµì „ íšŸìˆ˜
      document.getElementById('battle-time').textContent = state.time.toFixed(1);
      document.getElementById('attack-count').textContent = state.attackCount;
    }
    
    function updateChar(side) {
      state[side].gyeongji = document.getElementById(`${side}-gyeongji`).value;
      state[side].simbeop = document.getElementById(`${side}-simbeop`).value;
      updateUI();
    }
    
    // ===== ë¡œê·¸ =====
    function addLog(text, cls = '') {
      const el = document.getElementById('log-content');
      const line = document.createElement('div');
      line.className = `log-line ${cls}`;
      line.textContent = `[${state.time.toFixed(2)}ì´ˆ] ${text}`;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }
    
    // ===== ì „íˆ¬ ë¡œì§ =====
    function processAttack(attacker, defender) {
      const atkStats = getCharStats(attacker);
      const defStats = getCharStats(defender);
      const atkChar = state[attacker];
      const defChar = state[defender];
      
      const atkName = attacker === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      const defName = defender === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      
      state.attackCount++;
      
      // ê³µê²©ì ìš´ê¸° ì§„í–‰ë„
      const atkUngi = atkChar.ungi;
      const atkRemain = 100 - atkUngi;
      
      // ë°©ì–´ì ìš´ê¸° ì§„í–‰ë„ (í”¼ê²© ì‹œì )
      const defUngi = defChar.ungi;
      const defRemain = 100 - defUngi;
      
      addLog(`â”â”â” ì œ ${state.attackCount}í•© â”â”â”`, 'ready');
      addLog(`${atkName} ìš´ê¸° ${atkUngi.toFixed(1)}%ë¡œ ê³µê²©!`, 'attack');
      addLog(`${defName} ìš´ê¸° ${defUngi.toFixed(1)}%ì—ì„œ í”¼ê²©!`, 'defend');
      
      // ê³µê²©ì ë‚´ìƒ (100% ë¯¸ë‹¬ ì‹œ)
      if (atkUngi < 100) {
        const atkNaesang = atkRemain * atkStats.danger;
        atkChar.hp -= atkNaesang * 0.1;
        atkChar.neigong -= atkNaesang * 0.9;
        if (atkNaesang > 0.5) {
          addLog(`  ${atkName} ìš´ê¸° ë¯¸ì™„ì„± ë‚´ìƒ: -${atkNaesang.toFixed(2)}`, 'naesang');
        }
      }
      
      // ë°©ì–´ì ë‚´ìƒ (í”¼ê²©ìœ¼ë¡œ ìš´ê¸° ëŠê¹€)
      const defNaesang = defRemain * defStats.danger;
      defChar.hp -= defNaesang * 0.1;
      defChar.neigong -= defNaesang * 0.9;
      if (defNaesang > 0.5) {
        addLog(`  ${defName} ìš´ê¸° ëŠê¹€ ë‚´ìƒ: -${defNaesang.toFixed(2)}`, 'naesang');
      }
      
      // ê²½ì§€ ì°¨ì´ ë³´ì •
      const levelDiff = atkStats.g.level - defStats.g.level;
      let modifier = 1;
      if (levelDiff < 0) {
        modifier = 1 + (levelDiff * 0.03);  // í•˜ìœ„ê°€ ê³µê²© ì‹œ í˜ë„í‹°
      }
      
      // í”¼í•´ ê³„ì‚°
      const damage = atkStats.power * 10 * modifier;
      const hpDmg = damage * 0.2;
      const ngDmg = damage * 0.8;
      
      defChar.hp -= hpDmg;
      defChar.neigong -= ngDmg;
      
      addLog(`  í”¼í•´: ì²´ë ¥ -${hpDmg.toFixed(1)}, ë‚´ê³µ -${ngDmg.toFixed(1)}`, 'damage');
      
      // ìµœì†Œê°’ ë³´ì •
      atkChar.hp = Math.max(0, atkChar.hp);
      atkChar.neigong = Math.max(0, atkChar.neigong);
      defChar.hp = Math.max(0, defChar.hp);
      defChar.neigong = Math.max(0, defChar.neigong);
      
      // ìš´ê¸° ë¦¬ì…‹
      atkChar.ungi = 0;
      defChar.ungi = 0;
      
      // ì „íˆ¬ë¶ˆëŠ¥ ì²´í¬
      const newDefStats = getCharStats(defender);
      if (newDefStats.isDead) {
        addLog(`ğŸ’€ ${defName} ì „íˆ¬ë¶ˆëŠ¥!`, 'critical');
        state.winner = attacker;
      }
      
      const newAtkStats = getCharStats(attacker);
      if (newAtkStats.isDead && !state.winner) {
        addLog(`ğŸ’€ ${atkName} ì „íˆ¬ë¶ˆëŠ¥! (ë‚´ìƒ)`, 'critical');
        state.winner = defender;
      }
    }
    
    // ===== ë©”ì¸ ë£¨í”„ =====
    function gameLoop(timestamp) {
      if (!state.running) return;
      
      const speed = parseFloat(document.getElementById('sim-speed').value);
      
      if (state.lastTime === 0) {
        state.lastTime = timestamp;
      }
      
      const delta = (timestamp - state.lastTime) / 1000 * speed;  // ì´ˆ ë‹¨ìœ„
      state.lastTime = timestamp;
      state.time += delta;
      
      // ìš´ê¸° ì¶©ì „
      const allyStats = getCharStats('ally');
      const enemyStats = getCharStats('enemy');
      
      if (!allyStats.isDead) {
        state.ally.ungi += allyStats.ungiPerSec * delta;
        state.ally.ungi = Math.min(100, state.ally.ungi);
      }
      
      if (!enemyStats.isDead) {
        state.enemy.ungi += enemyStats.ungiPerSec * delta;
        state.enemy.ungi = Math.min(100, state.enemy.ungi);
      }
      
      // ê³µê²© ì²´í¬ (80% ì´ìƒì´ë©´ ê³µê²© ê°€ëŠ¥)
      const allyCanAttack = state.ally.ungi >= 80 && !allyStats.isDead;
      const enemyCanAttack = state.enemy.ungi >= 80 && !enemyStats.isDead;
      
      // ë‘˜ ë‹¤ ê³µê²© ê°€ëŠ¥í•˜ë©´ ë¨¼ì € 80% ë„ë‹¬í•œ ìª½ì´ ì„ ê³µ
      // (ì‹¤ì œë¡œëŠ” ìš´ê¸° ì§„í–‰ë„ê°€ ë†’ì€ ìª½ì´ ì„ ê³µ)
      if (allyCanAttack && enemyCanAttack) {
        if (state.ally.ungi >= state.enemy.ungi) {
          processAttack('ally', 'enemy');
        } else {
          processAttack('enemy', 'ally');
        }
      } else if (allyCanAttack && !enemyCanAttack) {
        processAttack('ally', 'enemy');
      } else if (enemyCanAttack && !allyCanAttack) {
        processAttack('enemy', 'ally');
      }
      
      updateUI();
      
      // ìŠ¹íŒ¨ ì²´í¬
      if (state.winner) {
        endBattle();
        return;
      }
      
      state.animFrame = requestAnimationFrame(gameLoop);
    }
    
    // ===== ì „íˆ¬ ì»¨íŠ¸ë¡¤ =====
    function startBattle() {
      if (state.running) return;
      
      state.running = true;
      state.lastTime = 0;
      
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-stop').style.display = 'inline-block';
      
      // ì„¤ì • ì ê¸ˆ
      document.querySelectorAll('.char-config select').forEach(el => el.disabled = true);
      
      if (state.time === 0) {
        document.getElementById('log-content').innerHTML = '';
        addLog('ì „íˆ¬ ì‹œì‘! ìš´ê¸°ë¥¼ ëª¨ì•„ ê³µê²©í•˜ë¼!', 'ready');
      }
      
      state.animFrame = requestAnimationFrame(gameLoop);
    }
    
    function stopBattle() {
      state.running = false;
      state.lastTime = 0;
      
      if (state.animFrame) {
        cancelAnimationFrame(state.animFrame);
      }
      
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-stop').style.display = 'none';
      
      addLog('ì „íˆ¬ ì¼ì‹œì •ì§€', 'info');
    }
    
    function endBattle() {
      state.running = false;
      
      if (state.animFrame) {
        cancelAnimationFrame(state.animFrame);
      }
      
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-stop').style.display = 'none';
      
      const winnerName = state.winner === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      const resultText = `ğŸ† ${winnerName} ìŠ¹ë¦¬! (${state.time.toFixed(1)}ì´ˆ, ${state.attackCount}í•©)`;
      
      document.getElementById('battle-result').style.display = 'block';
      document.getElementById('result-text').textContent = resultText;
      
      addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '');
      addLog(resultText, 'ready');
    }
    
    function resetBattle() {
      stopBattle();
      
      state.time = 0;
      state.attackCount = 0;
      state.winner = null;
      
      state.ally.hp = 100;
      state.ally.neigong = 100;
      state.ally.ungi = 0;
      
      state.enemy.hp = 100;
      state.enemy.neigong = 100;
      state.enemy.ungi = 0;
      
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-stop').style.display = 'none';
      document.getElementById('battle-result').style.display = 'none';
      
      // ì„¤ì • ì ê¸ˆ í•´ì œ
      document.querySelectorAll('.char-config select').forEach(el => el.disabled = false);
      
      document.getElementById('log-content').innerHTML = `
        <div class="log-line info">ì „íˆ¬ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‹¤ì‹œê°„ ìš´ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</div>
        <div class="log-line info">ìš´ê¸° 80% ì´ìƒì´ ë˜ë©´ ê³µê²©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        <div class="log-line info">ìƒëŒ€ë³´ë‹¤ ë¨¼ì € 80%ì— ë„ë‹¬í•˜ë©´ ì„ ê³µ!</div>
      `;
      
      updateUI();
    }
    
    // ===== ì´ˆê¸°í™” =====
    updateUI();
  </script>
</body>
</html>
