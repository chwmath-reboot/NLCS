<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S-Engine æˆ°é¬ª è©¦æ¼”å™¨ v5.1 - ë³´ë²• + ì‹¤ì‹œê°„ ìš´ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
      color: #e0e0e0;
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      padding: 15px 10px;
      font-size: 14px;
    }
    
    .container { max-width: 1500px; margin: 0 auto; }
    
    header { text-align: center; margin-bottom: 15px; }
    
    h1 {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.8rem;
      background: linear-gradient(135deg, #ffd700 0%, #ff6b35 50%, #ffd700 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle { color: #888; font-size: 0.8rem; }
    
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 480px 1fr;
      gap: 15px;
      align-items: start;
    }
    
    @media (max-width: 1300px) {
      .main-layout { grid-template-columns: 1fr; }
    }
    
    /* ìºë¦­í„° íŒ¨ë„ */
    .char-panel {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 15px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .char-panel.ally { border-color: rgba(231,76,60,0.3); }
    .char-panel.enemy { border-color: rgba(52,152,219,0.3); }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .panel-header h2 {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.1rem;
    }
    
    .panel-header.ally h2 { color: #e74c3c; }
    .panel-header.enemy h2 { color: #3498db; }
    
    .char-name {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .char-name.ally { color: #e74c3c; }
    .char-name.enemy { color: #3498db; }
    
    .char-config {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .config-item label {
      display: block;
      font-size: 0.65rem;
      color: #888;
      margin-bottom: 2px;
    }
    
    .config-item select {
      width: 100%;
      padding: 5px 6px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 4px;
      color: #fff;
      font-size: 0.75rem;
    }
    
    /* ìš´ê¸° ê²Œì´ì§€ */
    .ungi-section {
      background: rgba(0,0,0,0.4);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
    }
    
    .ungi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .ungi-label {
      font-size: 0.8rem;
      color: #ffd700;
      font-weight: bold;
    }
    
    .ungi-value {
      font-size: 1.1rem;
      font-weight: bold;
      font-family: 'D2Coding', monospace;
    }
    
    .ungi-value.ready { color: #2ecc71; }
    .ungi-value.charging { color: #f39c12; }
    
    .ungi-bar-container {
      position: relative;
      height: 20px;
      background: rgba(0,0,0,0.5);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .ungi-bar {
      height: 100%;
      border-radius: 10px;
      transition: width 0.05s linear;
    }
    
    .ungi-bar.ally { background: linear-gradient(90deg, #c0392b, #e74c3c, #f39c12); }
    .ungi-bar.enemy { background: linear-gradient(90deg, #2980b9, #3498db, #1abc9c); }
    .ungi-bar.ready { box-shadow: 0 0 12px rgba(46,204,113,0.8); }
    
    .ungi-threshold {
      position: absolute;
      left: 80%;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #2ecc71;
      z-index: 10;
    }
    
    .ungi-status {
      text-align: center;
      margin-top: 4px;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .ungi-status.ready { color: #2ecc71; }
    .ungi-status.charging { color: #f39c12; }
    
    /* ìŠ¤íƒ¯ ë°” */
    .stat-bars {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    
    .stat-bar {
      background: rgba(0,0,0,0.3);
      border-radius: 5px;
      padding: 5px 7px;
    }
    
    .stat-bar .label {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      margin-bottom: 3px;
    }
    
    .stat-bar .track {
      height: 5px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .stat-bar .fill { height: 100%; transition: width 0.3s; }
    .stat-bar .fill.hp { background: linear-gradient(90deg, #c0392b, #e74c3c); }
    .stat-bar .fill.ng { background: linear-gradient(90deg, #2980b9, #3498db); }
    
    .char-info {
      margin-top: 8px;
      padding: 6px 8px;
      background: rgba(155,89,182,0.1);
      border-radius: 5px;
      font-size: 0.65rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3px;
    }
    
    .info-item span:first-child { color: #888; }
    .info-item span:last-child { color: #fff; font-weight: bold; }
    
    /* í˜„ì¬ ë™ì‘ í‘œì‹œ */
    .action-display {
      margin-top: 8px;
      padding: 8px;
      background: rgba(0,0,0,0.4);
      border-radius: 6px;
      text-align: center;
    }
    
    .action-label {
      font-size: 0.65rem;
      color: #888;
      margin-bottom: 4px;
    }
    
    .action-text {
      font-size: 0.85rem;
      font-weight: bold;
      min-height: 20px;
    }
    
    .action-text.move { color: #f39c12; }
    .action-text.attack { color: #e74c3c; }
    .action-text.defend { color: #3498db; }
    
    /* ì¤‘ì•™ ì „íˆ¬ ì˜ì—­ */
    .battle-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .battle-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .btn {
      padding: 10px 20px;
      font-size: 0.9rem;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover { transform: scale(1.03); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-start { background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; }
    .btn-stop { background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; }
    .btn-reset { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #aaa; }
    
    .speed-control {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 5px;
      font-size: 0.75rem;
    }
    
    .speed-control label { color: #888; }
    .speed-control select {
      padding: 3px 6px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: #fff;
      font-size: 0.75rem;
    }
    
    /* ì „íˆ¬ ì‹œê°í™” */
    .battle-visual {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 12px;
    }
    
    .visual-title {
      text-align: center;
      font-size: 0.75rem;
      color: #888;
      margin-bottom: 8px;
    }
    
    .arena {
      position: relative;
      height: 100px;
      background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(50,50,80,0.2) 100%);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      overflow: hidden;
    }
    
    .fighter-token {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      text-align: center;
      transition: left 0.3s ease;
    }
    
    .fighter-token.ally { left: 15%; }
    .fighter-token.enemy { left: 75%; }
    
    .fighter-token.approaching.ally { left: 35%; }
    .fighter-token.approaching.enemy { left: 55%; }
    
    .fighter-icon { font-size: 2rem; }
    .fighter-label { font-size: 0.7rem; font-weight: bold; margin-top: 2px; }
    .fighter-label.ally { color: #e74c3c; }
    .fighter-label.enemy { color: #3498db; }
    
    .clash-effect {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .clash-effect.active {
      opacity: 1;
      animation: clashPulse 0.3s ease;
    }
    
    @keyframes clashPulse {
      0% { transform: translate(-50%, -50%) scale(0.5); }
      50% { transform: translate(-50%, -50%) scale(1.3); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    
    .combo-display {
      text-align: center;
      margin-top: 8px;
      font-size: 0.8rem;
    }
    
    .combo-count {
      font-weight: bold;
      color: #ffd700;
    }
    
    /* ì „íˆ¬ ë¡œê·¸ */
    .battle-log-container {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      height: 380px;
    }
    
    .log-header {
      padding: 8px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .log-header h3 {
      color: #ffd700;
      font-family: 'Noto Serif KR', serif;
      font-size: 0.95rem;
    }
    
    .log-stats {
      display: flex;
      gap: 8px;
      font-size: 0.7rem;
    }
    
    .log-stats span {
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .log-stats .time { background: rgba(155,89,182,0.2); color: #9b59b6; }
    .log-stats .round { background: rgba(255,215,0,0.2); color: #ffd700; }
    
    .log-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      font-family: 'D2Coding', monospace;
      font-size: 0.72rem;
      line-height: 1.5;
    }
    
    .log-line { margin-bottom: 2px; color: #bbb; }
    .log-line.move { color: #f39c12; }
    .log-line.attack { color: #e74c3c; font-weight: bold; }
    .log-line.defend { color: #3498db; }
    .log-line.damage { color: #ff6b6b; }
    .log-line.naesang { color: #9b59b6; font-style: italic; }
    .log-line.combo { color: #ffd700; font-weight: bold; }
    .log-line.ready { color: #2ecc71; font-weight: bold; }
    .log-line.info { color: #888; font-style: italic; }
    .log-line.critical { color: #e74c3c; font-weight: bold; background: rgba(231,76,60,0.15); padding: 2px 5px; border-radius: 3px; }
    .log-line.divider { color: #555; text-align: center; }
    
    .battle-result {
      padding: 10px;
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }
    
    .result-text {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.1rem;
      color: #ffd700;
    }
    
    footer {
      text-align: center;
      margin-top: 15px;
      color: #555;
      font-size: 0.7rem;
    }
    
    .highlight-red { color: #e74c3c; }
    .highlight-blue { color: #3498db; }
    .highlight-gold { color: #ffd700; }
    .highlight-green { color: #2ecc71; }
    .highlight-purple { color: #9b59b6; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>S-Engine æˆ°é¬ª è©¦æ¼”å™¨</h1>
      <p class="subtitle">v5.1 - ì‹¤ì‹œê°„ ìš´ê¸° + ë³´ë²• + ê³µê²© ë‹¤ì–‘ì„±</p>
    </header>
    
    <div class="main-layout">
      <!-- ì•„êµ° íŒ¨ë„ -->
      <div class="char-panel ally">
        <div class="panel-header ally">
          <h2>âš”ï¸ ì•„êµ°</h2>
        </div>
        
        <div class="char-name ally">ê²€í˜¸</div>
        
        <div class="char-config">
          <div class="config-item">
            <label>ê²½ì§€</label>
            <select id="ally-gyeongji" onchange="updateChar('ally')">
              <option value="ì‚¼ë¥˜">ì‚¼ë¥˜</option>
              <option value="ì´ë¥˜">ì´ë¥˜</option>
              <option value="ì¼ë¥˜">ì¼ë¥˜</option>
              <option value="ì ˆì •" selected>ì ˆì •</option>
              <option value="ì´ˆì ˆì •">ì´ˆì ˆì •</option>
              <option value="í™”ê²½">í™”ê²½</option>
              <option value="í˜„ê²½">í˜„ê²½</option>
              <option value="ìƒì‚¬ê²½">ìƒì‚¬ê²½</option>
              <option value="ìì—°ê²½">ìì—°ê²½</option>
            </select>
          </div>
          <div class="config-item">
            <label>ì‹¬ë²•</label>
            <select id="ally-simbeop" onchange="updateChar('ally')">
              <option value="ì‚¼ì¬ì‹¬ë²•">ì‚¼ì¬</option>
              <option value="ê¸°ì´ˆì‹¬ë²•">ê¸°ì´ˆ</option>
              <option value="ê¸°ë³¸ì‹¬ë²•" selected>ê¸°ë³¸</option>
              <option value="ì‹¬í™”ì‹¬ë²•">ì‹¬í™”</option>
              <option value="ë¹„ì „ì‹¬ë²•">ë¹„ì „</option>
              <option value="ëª…ìš´ì‹¬ë²•">ëª…ìš´</option>
              <option value="ì²œë§ˆì‹¬ê³µ">ì²œë§ˆ</option>
            </select>
          </div>
          <div class="config-item">
            <label>ë³´ë²•</label>
            <select id="ally-bobeop" onchange="updateChar('ally')">
              <option value="0">ì—†ìŒ</option>
              <option value="1">Lv1 ê¸°ì´ˆ</option>
              <option value="2">Lv2 ê¸°ì´ˆ</option>
              <option value="3">Lv3 ê¸°ì´ˆ</option>
              <option value="4">Lv4 ê¸°ë³¸</option>
              <option value="5" selected>Lv5 ê¸°ë³¸</option>
              <option value="6">Lv6 ê¸°ë³¸</option>
              <option value="7">Lv7 ì‹¬í™”</option>
              <option value="8">Lv8 ì‹¬í™”</option>
              <option value="9">Lv9 ì‹¬í™”</option>
            </select>
          </div>
        </div>
        
        <div class="ungi-section">
          <div class="ungi-header">
            <span class="ungi-label">ğŸŒ€ ìš´ê¸°</span>
            <span class="ungi-value charging" id="ally-ungi-value">0%</span>
          </div>
          <div class="ungi-bar-container">
            <div class="ungi-threshold"></div>
            <div class="ungi-bar ally" id="ally-ungi-bar" style="width: 0%"></div>
          </div>
          <div class="ungi-status charging" id="ally-ungi-status">ìš´ê¸° ì¶©ì „ ì¤‘...</div>
        </div>
        
        <div class="stat-bars">
          <div class="stat-bar">
            <div class="label">
              <span>ì²´ë ¥</span>
              <span class="highlight-red" id="ally-hp">100.0</span>
            </div>
            <div class="track">
              <div class="fill hp" id="ally-hp-bar" style="width: 100%"></div>
            </div>
          </div>
          <div class="stat-bar">
            <div class="label">
              <span>ë‚´ê³µ</span>
              <span class="highlight-blue" id="ally-ng">100.0</span>
            </div>
            <div class="track">
              <div class="fill ng" id="ally-ng-bar" style="width: 100%"></div>
            </div>
          </div>
        </div>
        
        <div class="char-info">
          <div class="info-item"><span>ê³µì†:</span> <span id="ally-atkspd">1.50ì´ˆ</span></div>
          <div class="info-item"><span>ì´ì†:</span> <span id="ally-movspd">âˆš5</span></div>
          <div class="info-item"><span>íŒŒê´´ë ¥:</span> <span id="ally-power">5.48</span></div>
          <div class="info-item"><span>ë³´ë²•+:</span> <span id="ally-bobeop-bonus">+50%</span></div>
        </div>
        
        <div class="action-display">
          <div class="action-label">í˜„ì¬ ë™ì‘</div>
          <div class="action-text move" id="ally-action">ëŒ€ê¸° ì¤‘</div>
        </div>
      </div>
      
      <!-- ì¤‘ì•™ ì „íˆ¬ ì˜ì—­ -->
      <div class="battle-area">
        <div class="battle-visual">
          <div class="visual-title">âš”ï¸ ì „íˆ¬ ìƒí™©</div>
          <div class="arena">
            <div class="fighter-token ally" id="ally-token">
              <div class="fighter-icon">ğŸ—¡ï¸</div>
              <div class="fighter-label ally">ê²€í˜¸</div>
            </div>
            <div class="clash-effect" id="clash-effect">ğŸ’¥</div>
            <div class="fighter-token enemy" id="enemy-token">
              <div class="fighter-icon">ğŸ›¡ï¸</div>
              <div class="fighter-label enemy">ë„ì </div>
            </div>
          </div>
          <div class="combo-display">
            ì—°ì†íƒ€: <span class="combo-count" id="combo-count">0</span> | 
            ìŠ¬ë¡œëª¨ì…˜: <span id="slowmo-status">ëŒ€ê¸°</span>
          </div>
        </div>
        
        <div class="battle-controls">
          <button class="btn btn-start" id="btn-start" onclick="startBattle()">â–¶ï¸ ì „íˆ¬ ì‹œì‘</button>
          <button class="btn btn-stop" id="btn-stop" onclick="stopBattle()" style="display:none;">â¹ï¸ ì¤‘ì§€</button>
          <button class="btn btn-reset" onclick="resetBattle()">â†º ì´ˆê¸°í™”</button>
        </div>
        
        <div class="speed-control">
          <label>â±ï¸ ì†ë„:</label>
          <select id="sim-speed">
            <option value="0.5">0.5x</option>
            <option value="1" selected>1x</option>
            <option value="2">2x</option>
            <option value="5">5x</option>
          </select>
        </div>
        
        <div class="battle-log-container">
          <div class="log-header">
            <h3>ğŸ“œ ì „íˆ¬ ê¸°ë¡</h3>
            <div class="log-stats">
              <span class="time">â±ï¸ <span id="battle-time">0.0</span>ì´ˆ</span>
              <span class="round">ğŸ’¥ <span id="attack-count">0</span>í•©</span>
            </div>
          </div>
          <div class="log-content" id="log-content">
            <div class="log-line info">ì „íˆ¬ ì‹œì‘ì„ ëˆ„ë¥´ë©´ ì‹¤ì‹œê°„ ìš´ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</div>
            <div class="log-line info">ìš´ê¸° 80% ì´ìƒ â†’ ì ‘ê·¼ â†’ ê³µê²©!</div>
          </div>
          <div class="battle-result" id="battle-result" style="display: none;">
            <div class="result-text" id="result-text"></div>
          </div>
        </div>
      </div>
      
      <!-- ì êµ° íŒ¨ë„ -->
      <div class="char-panel enemy">
        <div class="panel-header enemy">
          <h2>ğŸ›¡ï¸ ì êµ°</h2>
        </div>
        
        <div class="char-name enemy">ë„ì </div>
        
        <div class="char-config">
          <div class="config-item">
            <label>ê²½ì§€</label>
            <select id="enemy-gyeongji" onchange="updateChar('enemy')">
              <option value="ì‚¼ë¥˜">ì‚¼ë¥˜</option>
              <option value="ì´ë¥˜">ì´ë¥˜</option>
              <option value="ì¼ë¥˜" selected>ì¼ë¥˜</option>
              <option value="ì ˆì •">ì ˆì •</option>
              <option value="ì´ˆì ˆì •">ì´ˆì ˆì •</option>
              <option value="í™”ê²½">í™”ê²½</option>
              <option value="í˜„ê²½">í˜„ê²½</option>
              <option value="ìƒì‚¬ê²½">ìƒì‚¬ê²½</option>
              <option value="ìì—°ê²½">ìì—°ê²½</option>
            </select>
          </div>
          <div class="config-item">
            <label>ì‹¬ë²•</label>
            <select id="enemy-simbeop" onchange="updateChar('enemy')">
              <option value="ì‚¼ì¬ì‹¬ë²•">ì‚¼ì¬</option>
              <option value="ê¸°ì´ˆì‹¬ë²•" selected>ê¸°ì´ˆ</option>
              <option value="ê¸°ë³¸ì‹¬ë²•">ê¸°ë³¸</option>
              <option value="ì‹¬í™”ì‹¬ë²•">ì‹¬í™”</option>
              <option value="ë¹„ì „ì‹¬ë²•">ë¹„ì „</option>
              <option value="ëª…ìš´ì‹¬ë²•">ëª…ìš´</option>
              <option value="ì²œë§ˆì‹¬ê³µ">ì²œë§ˆ</option>
            </select>
          </div>
          <div class="config-item">
            <label>ë³´ë²•</label>
            <select id="enemy-bobeop" onchange="updateChar('enemy')">
              <option value="0">ì—†ìŒ</option>
              <option value="1">Lv1 ê¸°ì´ˆ</option>
              <option value="2">Lv2 ê¸°ì´ˆ</option>
              <option value="3" selected>Lv3 ê¸°ì´ˆ</option>
              <option value="4">Lv4 ê¸°ë³¸</option>
              <option value="5">Lv5 ê¸°ë³¸</option>
              <option value="6">Lv6 ê¸°ë³¸</option>
              <option value="7">Lv7 ì‹¬í™”</option>
              <option value="8">Lv8 ì‹¬í™”</option>
              <option value="9">Lv9 ì‹¬í™”</option>
            </select>
          </div>
        </div>
        
        <div class="ungi-section">
          <div class="ungi-header">
            <span class="ungi-label">ğŸŒ€ ìš´ê¸°</span>
            <span class="ungi-value charging" id="enemy-ungi-value">0%</span>
          </div>
          <div class="ungi-bar-container">
            <div class="ungi-threshold"></div>
            <div class="ungi-bar enemy" id="enemy-ungi-bar" style="width: 0%"></div>
          </div>
          <div class="ungi-status charging" id="enemy-ungi-status">ìš´ê¸° ì¶©ì „ ì¤‘...</div>
        </div>
        
        <div class="stat-bars">
          <div class="stat-bar">
            <div class="label">
              <span>ì²´ë ¥</span>
              <span class="highlight-red" id="enemy-hp">100.0</span>
            </div>
            <div class="track">
              <div class="fill hp" id="enemy-hp-bar" style="width: 100%"></div>
            </div>
          </div>
          <div class="stat-bar">
            <div class="label">
              <span>ë‚´ê³µ</span>
              <span class="highlight-blue" id="enemy-ng">100.0</span>
            </div>
            <div class="track">
              <div class="fill ng" id="enemy-ng-bar" style="width: 100%"></div>
            </div>
          </div>
        </div>
        
        <div class="char-info">
          <div class="info-item"><span>ê³µì†:</span> <span id="enemy-atkspd">1.73ì´ˆ</span></div>
          <div class="info-item"><span>ì´ì†:</span> <span id="enemy-movspd">âˆš3</span></div>
          <div class="info-item"><span>íŒŒê´´ë ¥:</span> <span id="enemy-power">4.47</span></div>
          <div class="info-item"><span>ë³´ë²•+:</span> <span id="enemy-bobeop-bonus">+30%</span></div>
        </div>
        
        <div class="action-display">
          <div class="action-label">í˜„ì¬ ë™ì‘</div>
          <div class="action-text move" id="enemy-action">ëŒ€ê¸° ì¤‘</div>
        </div>
      </div>
    </div>
    
    <footer>
      S-Engine Combat Simulator v5.1 by ShadowK | ë³´ë²• + ì‹¤ì‹œê°„ ìš´ê¸° + ê³µê²© ë‹¤ì–‘ì„±
    </footer>
  </div>
  
  <script>
    // ===== ë°ì´í„° =====
    const GYEONGJI = {
      'ì‚¼ë¥˜': { level: 1, speed: Math.sqrt(1) },
      'ì´ë¥˜': { level: 2, speed: Math.sqrt(2) },
      'ì¼ë¥˜': { level: 3, speed: Math.sqrt(3) },
      'ì ˆì •': { level: 4, speed: Math.sqrt(4) },
      'ì´ˆì ˆì •': { level: 5, speed: Math.sqrt(5) },
      'í™”ê²½': { level: 6, speed: Math.sqrt(6) },
      'í˜„ê²½': { level: 7, speed: Math.sqrt(7) },
      'ìƒì‚¬ê²½': { level: 8, speed: Math.sqrt(8) },
      'ìì—°ê²½': { level: 9, speed: Math.sqrt(9) }
    };
    
    const SIMBEOP = {
      'ì‚¼ì¬ì‹¬ë²•': { chukgi: 10, stab: 90, type: 'ê¸°ë³¸' },
      'ê¸°ì´ˆì‹¬ë²•': { chukgi: 20, stab: 80, type: 'ê¸°ì´ˆ' },
      'ê¸°ë³¸ì‹¬ë²•': { chukgi: 30, stab: 70, type: 'ê¸°ë³¸' },
      'ì‹¬í™”ì‹¬ë²•': { chukgi: 40, stab: 70, type: 'ì‹¬í™”' },
      'ë¹„ì „ì‹¬ë²•': { chukgi: 70, stab: 60, type: 'ë¹„ì „' },
      'ëª…ìš´ì‹¬ë²•': { chukgi: 110, stab: 80, type: 'ì‹ ê³µLv1' },
      'ì²œë§ˆì‹¬ê³µ': { chukgi: 130, stab: 70, type: 'ì‹ ê³µLv2' }
    };
    
    const THRESHOLD = { 'ê¸°ì´ˆ': 40, 'ê¸°ë³¸': 40, 'ì‹¬í™”': 40, 'ë¹„ì „': 35, 'ì‹ ê³µLv1': 30, 'ì‹ ê³µLv2': 25 };
    
    // ì´ë™ ë°©í–¥
    const DIRECTIONS = ['ì „ì§„', 'ì „ì¢Œ', 'ì „ìš°', 'ì¢Œ', 'ìš°', 'í›„í‡´', 'í›„ì¢Œ', 'í›„ìš°'];
    const APPROACH_DIR = ['ì „ì§„', 'ì „ì¢Œ', 'ì „ìš°'];
    const RETREAT_DIR = ['í›„í‡´', 'í›„ì¢Œ', 'í›„ìš°'];
    
    // ê³µê²© ì¢…ë¥˜
    const ATTACK_TYPES = {
      ìƒë‹¨: ['ë¨¸ë¦¬ë¥¼ í–¥í•œ ê°€ë¡œë² ê¸°', 'ë‘ê°œê³¨ì„ ë…¸ë¦° ë‚´ë ¤ë² ê¸°', 'í„±ì„ ë…¸ë¦° ì˜¬ë ¤ë² ê¸°', 'ê´€ìë†€ì´ë¥¼ í–¥í•œ íš¡ë² ê¸°'],
      ì¤‘ë‹¨: ['ëª¸í†µì„ ê°€ë¥´ëŠ” ê°€ë¡œë² ê¸°', 'ì–´ê¹¨ì—ì„œ í—ˆë¦¬ë¡œ ë‚´ë ¤ë² ê¸°', 'ë³µë¶€ë¥¼ ë…¸ë¦° ì˜¬ë ¤ë² ê¸°', 'ì˜†êµ¬ë¦¬ë¥¼ íŒŒê³ ë“œëŠ” ì‚¬ì„ ë² ê¸°', 'ì‹¬ì¥ì„ í–¥í•œ ì°Œë¥´ê¸°', 'ëª…ì¹˜ë¥¼ ë…¸ë¦° ì§ì'],
      í•˜ë‹¨: ['í—ˆë²…ì§€ë¥¼ ë…¸ë¦° ê°€ë¡œë² ê¸°', 'ë¬´ë¦ì„ í–¥í•œ í•˜ë‹¨ë² ê¸°', 'ì¢…ì•„ë¦¬ë¥¼ ìŠ¤ì¹˜ëŠ” íš¡ë² ê¸°', 'ë°œëª©ì„ ë…¸ë¦° ì €ê²©']
    };
    
    const DEFEND_TYPES = ['ê²€ìœ¼ë¡œ í˜ë ¤ëƒ„', 'ëª¸ì„ í‹€ì–´ íšŒí”¼', 'ë³´ë²•ìœ¼ë¡œ ë¬¼ëŸ¬ë‚¨', 'ê²€ì‹ ìœ¼ë¡œ ë§‰ì•„ëƒ„', 'ê¸‰íˆ ì¸¡ë©´ ì´ë™'];
    
    // ìŠ¬ë¡œëª¨ì…˜ ì½¤ë³´
    const COMBO_BONUS = { 2: 0.05, 3: 0.10, 4: 0.15 };
    
    // ===== ê²Œì„ ìƒíƒœ =====
    let state = {
      running: false,
      time: 0,
      attackCount: 0,
      winner: null,
      animFrame: null,
      lastTime: 0,
      comboCount: 0,
      lastAttacker: null,
      phase: 'ready', // ready, approach, clash
      
      ally: {
        gyeongji: 'ì ˆì •',
        simbeop: 'ê¸°ë³¸ì‹¬ë²•',
        bobeop: 5,
        hp: 100,
        neigong: 100,
        ungi: 0,
        currentDir: null,
        currentAction: 'ëŒ€ê¸° ì¤‘'
      },
      
      enemy: {
        gyeongji: 'ì¼ë¥˜',
        simbeop: 'ê¸°ì´ˆì‹¬ë²•',
        bobeop: 3,
        hp: 100,
        neigong: 100,
        ungi: 0,
        currentDir: null,
        currentAction: 'ëŒ€ê¸° ì¤‘'
      }
    };
    
    // ===== ê³„ì‚° í•¨ìˆ˜ =====
    function getCharStats(side) {
      const char = state[side];
      const g = GYEONGJI[char.gyeongji];
      const s = SIMBEOP[char.simbeop];
      
      const atkTime = 3 / g.speed;
      const ungiPath = Math.sqrt(s.chukgi);
      const danger = 1 / Math.sqrt(s.stab);
      const ungiPerSec = 100 / atkTime;
      const power = ungiPath * (char.ungi / 100);
      
      // ë³´ë²• ë³´ë„ˆìŠ¤
      const bobeopBonus = char.bobeop * 0.1;
      const moveSpeed = char.bobeop > 0 ? Math.sqrt(char.bobeop) : 1;
      
      const threshold = THRESHOLD[s.type];
      const isDead = char.neigong <= threshold || char.hp <= 0;
      
      return { g, s, atkTime, ungiPath, danger, ungiPerSec, power, bobeopBonus, moveSpeed, threshold, isDead };
    }
    
    function randomPick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }
    
    function generateMoveDirection(isAttacker) {
      if (isAttacker) {
        // ê³µê²©ìëŠ” ì ‘ê·¼ ë°©í–¥ ìœ„ì£¼
        return Math.random() > 0.2 ? randomPick(APPROACH_DIR) : randomPick(['ì¢Œ', 'ìš°']);
      } else {
        // ë°©ì–´ìëŠ” ë‹¤ì–‘í•œ ë°©í–¥
        return randomPick(DIRECTIONS);
      }
    }
    
    function generateAttack() {
      const zone = randomPick(['ìƒë‹¨', 'ì¤‘ë‹¨', 'ì¤‘ë‹¨', 'í•˜ë‹¨']); // ì¤‘ë‹¨ ê°€ì¤‘ì¹˜
      const type = randomPick(ATTACK_TYPES[zone]);
      return { zone, type };
    }
    
    function calcDirectionBonus(atkDir, defDir) {
      // ì´ë™ë°©í–¥ ì¼ì¹˜/ë¶ˆì¼ì¹˜ ë³´ë„ˆìŠ¤
      let bonus = 0;
      let desc = '';
      
      if (APPROACH_DIR.includes(atkDir)) {
        if (atkDir === 'ì „ì§„') bonus += 0.10;
        else bonus += 0.08;
        desc = `ì ‘ê·¼(${atkDir})`;
      }
      
      // ë°©ì–´ì ë°©í–¥ì— ë”°ë¥¸ ì¶”ê°€
      if (RETREAT_DIR.includes(defDir)) {
        bonus += 0.10;
        desc += ` â†’ ì¶”ê²© ì„±ê³µ`;
      } else if (['ì¢Œ', 'ìš°'].includes(defDir)) {
        bonus += 0.05;
        desc += ` â†’ ì¸¡ë©´ í¬ì°©`;
      } else if (APPROACH_DIR.includes(defDir)) {
        bonus += 0.05;
        desc += ` â†’ ì •ë©´ ì¶©ëŒ`;
      }
      
      return { bonus, desc };
    }
    
    // ===== UI ì—…ë°ì´íŠ¸ =====
    function updateUI() {
      ['ally', 'enemy'].forEach(side => {
        const char = state[side];
        const stats = getCharStats(side);
        
        // ìš´ê¸° ê²Œì´ì§€
        const ungiBar = document.getElementById(`${side}-ungi-bar`);
        const ungiValue = document.getElementById(`${side}-ungi-value`);
        const ungiStatus = document.getElementById(`${side}-ungi-status`);
        
        ungiBar.style.width = `${Math.min(100, char.ungi)}%`;
        ungiValue.textContent = `${char.ungi.toFixed(1)}%`;
        
        if (char.ungi >= 80) {
          ungiBar.classList.add('ready');
          ungiValue.className = 'ungi-value ready';
          ungiStatus.className = 'ungi-status ready';
          ungiStatus.textContent = 'âš”ï¸ ê³µê²© ê°€ëŠ¥!';
        } else {
          ungiBar.classList.remove('ready');
          ungiValue.className = 'ungi-value charging';
          ungiStatus.className = 'ungi-status charging';
          ungiStatus.textContent = `ì¶©ì „ ì¤‘... ${(80 - char.ungi).toFixed(1)}%`;
        }
        
        // ì²´ë ¥/ë‚´ê³µ
        document.getElementById(`${side}-hp`).textContent = char.hp.toFixed(1);
        document.getElementById(`${side}-ng`).textContent = char.neigong.toFixed(1);
        document.getElementById(`${side}-hp-bar`).style.width = `${Math.max(0, char.hp)}%`;
        document.getElementById(`${side}-ng-bar`).style.width = `${Math.max(0, char.neigong)}%`;
        
        // ì •ë³´
        document.getElementById(`${side}-atkspd`).textContent = `${stats.atkTime.toFixed(2)}ì´ˆ`;
        document.getElementById(`${side}-movspd`).textContent = char.bobeop > 0 ? `âˆš${char.bobeop}` : '-';
        document.getElementById(`${side}-power`).textContent = stats.power.toFixed(2);
        document.getElementById(`${side}-bobeop-bonus`).textContent = `+${(stats.bobeopBonus * 100).toFixed(0)}%`;
        
        // í˜„ì¬ ë™ì‘
        const actionEl = document.getElementById(`${side}-action`);
        actionEl.textContent = char.currentAction;
        
        if (char.currentAction.includes('ê³µê²©') || char.currentAction.includes('ë² ê¸°') || char.currentAction.includes('ì°Œë¥´ê¸°')) {
          actionEl.className = 'action-text attack';
        } else if (char.currentAction.includes('ë°©ì–´') || char.currentAction.includes('íšŒí”¼') || char.currentAction.includes('ë§‰')) {
          actionEl.className = 'action-text defend';
        } else {
          actionEl.className = 'action-text move';
        }
      });
      
      // ì‹œê°„/êµì „
      document.getElementById('battle-time').textContent = state.time.toFixed(1);
      document.getElementById('attack-count').textContent = state.attackCount;
      document.getElementById('combo-count').textContent = state.comboCount;
      
      // ìŠ¬ë¡œëª¨ì…˜ ìƒíƒœ
      const slowmoEl = document.getElementById('slowmo-status');
      if (state.comboCount >= 4) {
        slowmoEl.textContent = '4ì—°íƒ€! +15%';
        slowmoEl.style.color = '#ffd700';
      } else if (state.comboCount >= 3) {
        slowmoEl.textContent = '3ì—°íƒ€! +10%';
        slowmoEl.style.color = '#f39c12';
      } else if (state.comboCount >= 2) {
        slowmoEl.textContent = '2ì—°íƒ€! +5%';
        slowmoEl.style.color = '#e67e22';
      } else {
        slowmoEl.textContent = 'ëŒ€ê¸°';
        slowmoEl.style.color = '#888';
      }
    }
    
    function updateChar(side) {
      state[side].gyeongji = document.getElementById(`${side}-gyeongji`).value;
      state[side].simbeop = document.getElementById(`${side}-simbeop`).value;
      state[side].bobeop = parseInt(document.getElementById(`${side}-bobeop`).value);
      updateUI();
    }
    
    function showClashEffect() {
      const effect = document.getElementById('clash-effect');
      effect.classList.add('active');
      setTimeout(() => effect.classList.remove('active'), 300);
    }
    
    function setApproaching(approaching) {
      const allyToken = document.getElementById('ally-token');
      const enemyToken = document.getElementById('enemy-token');
      
      if (approaching) {
        allyToken.classList.add('approaching');
        enemyToken.classList.add('approaching');
      } else {
        allyToken.classList.remove('approaching');
        enemyToken.classList.remove('approaching');
      }
    }
    
    // ===== ë¡œê·¸ =====
    function addLog(text, cls = '') {
      const el = document.getElementById('log-content');
      const line = document.createElement('div');
      line.className = `log-line ${cls}`;
      line.textContent = text;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }
    
    function addLogTime(text, cls = '') {
      addLog(`[${state.time.toFixed(2)}ì´ˆ] ${text}`, cls);
    }
    
    // ===== ì „íˆ¬ ë¡œì§ =====
    function processAttack(attacker, defender) {
      const atkStats = getCharStats(attacker);
      const defStats = getCharStats(defender);
      const atkChar = state[attacker];
      const defChar = state[defender];
      
      const atkName = attacker === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      const defName = defender === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      
      state.attackCount++;
      
      // ì½¤ë³´ ì²´í¬
      if (state.lastAttacker === attacker) {
        state.comboCount++;
      } else {
        state.comboCount = 1;
        state.lastAttacker = attacker;
      }
      
      // ì´ë™ ë°©í–¥ ìƒì„±
      const atkDir = generateMoveDirection(true);
      const defDir = generateMoveDirection(false);
      atkChar.currentDir = atkDir;
      defChar.currentDir = defDir;
      
      // ê³µê²© ìƒì„±
      const attack = generateAttack();
      const defend = randomPick(DEFEND_TYPES);
      
      // ë°©í–¥ ë³´ë„ˆìŠ¤
      const dirBonus = calcDirectionBonus(atkDir, defDir);
      
      // ì½¤ë³´ ë³´ë„ˆìŠ¤
      const comboBonus = COMBO_BONUS[Math.min(4, state.comboCount)] || 0;
      
      // ìš´ê¸°
      const atkUngi = atkChar.ungi;
      const defUngi = defChar.ungi;
      const atkRemain = 100 - atkUngi;
      const defRemain = 100 - defUngi;
      
      addLog(`â”â”â”â”â” ì œ ${state.attackCount}í•© â”â”â”â”â”`, 'divider');
      
      // ì´ë™ ë¬˜ì‚¬
      addLogTime(`${atkName}, ${atkDir}! ë³´ë²•ì„ ë°Ÿìœ¼ë©° ê±°ë¦¬ë¥¼ ì¢íŒë‹¤.`, 'move');
      state[attacker].currentAction = `${atkDir} ì ‘ê·¼`;
      
      if (RETREAT_DIR.includes(defDir)) {
        addLogTime(`${defName}, ${defDir}ìœ¼ë¡œ ê±°ë¦¬ë¥¼ ë²Œë¦¬ë ¤ í•œë‹¤!`, 'move');
      } else if (APPROACH_DIR.includes(defDir)) {
        addLogTime(`${defName}, ${defDir}! ë§ì„œ ëŒì§„í•œë‹¤!`, 'move');
      } else {
        addLogTime(`${defName}, ${defDir}ìœ¼ë¡œ ì¸¡ë©´ ì´ë™!`, 'move');
      }
      state[defender].currentAction = `${defDir} ì´ë™`;
      
      setApproaching(true);
      
      // ê³µê²© ë¬˜ì‚¬
      setTimeout(() => {
        addLogTime(`${atkName}ì˜ ê²€ì´ ${attack.zone}ì„ ë…¸ë¦°ë‹¤â”€`, 'attack');
        addLogTime(`  ã€Œ${attack.type}ã€!`, 'attack');
        state[attacker].currentAction = attack.type;
        
        showClashEffect();
        
        // ë°©ì–´ ë¬˜ì‚¬
        setTimeout(() => {
          if (defUngi >= 60) {
            addLogTime(`${defName}, ${defend}ìœ¼ë¡œ ëŒ€ì‘!`, 'defend');
          } else {
            addLogTime(`${defName}, ìš´ê¸° ë¶€ì¡±ìœ¼ë¡œ ì œëŒ€ë¡œ ë§‰ì§€ ëª»í•œë‹¤!`, 'damage');
          }
          state[defender].currentAction = defend;
          
          // í”¼í•´ ê³„ì‚°
          calculateDamage(attacker, defender, atkStats, defStats, atkUngi, defUngi, dirBonus, comboBonus);
          
          setApproaching(false);
        }, 100);
      }, 100);
    }
    
    function calculateDamage(attacker, defender, atkStats, defStats, atkUngi, defUngi, dirBonus, comboBonus) {
      const atkChar = state[attacker];
      const defChar = state[defender];
      const atkName = attacker === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      const defName = defender === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      
      const atkRemain = 100 - atkUngi;
      const defRemain = 100 - defUngi;
      
      // ê³µê²©ì ë‚´ìƒ
      if (atkUngi < 100) {
        const atkNaesang = atkRemain * atkStats.danger;
        atkChar.hp -= atkNaesang * 0.1;
        atkChar.neigong -= atkNaesang * 0.9;
        if (atkNaesang > 0.5) {
          addLogTime(`  ${atkName}, ìš´ê¸° ë¯¸ì™„ì„±ì˜ ë°˜ë™... (ë‚´ìƒ -${atkNaesang.toFixed(1)})`, 'naesang');
        }
      }
      
      // ë°©ì–´ì ë‚´ìƒ (ìš´ê¸° ëŠê¹€)
      const defNaesang = defRemain * defStats.danger;
      defChar.hp -= defNaesang * 0.1;
      defChar.neigong -= defNaesang * 0.9;
      if (defNaesang > 0.5) {
        addLogTime(`  ${defName}, ìš´ê¸°ê°€ ëŠê¸°ë©° ë‚´ìƒ! (-${defNaesang.toFixed(1)})`, 'naesang');
      }
      
      // ê²½ì§€ ë³´ì •
      const levelDiff = atkStats.g.level - defStats.g.level;
      let modifier = 1;
      if (levelDiff < 0) modifier = 1 + (levelDiff * 0.03);
      
      // ì´ ë³´ë„ˆìŠ¤ ê³„ì‚°
      const totalBonus = atkStats.bobeopBonus + dirBonus.bonus + comboBonus;
      
      // í”¼í•´ ê³„ì‚°
      const baseDamage = atkStats.power * 10 * modifier;
      const bonusDamage = baseDamage * totalBonus;
      const totalDamage = baseDamage + bonusDamage;
      
      const hpDmg = totalDamage * 0.2;
      const ngDmg = totalDamage * 0.8;
      
      defChar.hp -= hpDmg;
      defChar.neigong -= ngDmg;
      
      // ë³´ë„ˆìŠ¤ ë¡œê·¸
      let bonusDesc = [];
      if (atkStats.bobeopBonus > 0) bonusDesc.push(`ë³´ë²• +${(atkStats.bobeopBonus*100).toFixed(0)}%`);
      if (dirBonus.bonus > 0) bonusDesc.push(`${dirBonus.desc} +${(dirBonus.bonus*100).toFixed(0)}%`);
      if (comboBonus > 0) bonusDesc.push(`${state.comboCount}ì—°íƒ€ +${(comboBonus*100).toFixed(0)}%`);
      
      if (bonusDesc.length > 0) {
        addLogTime(`  [${bonusDesc.join(', ')}]`, 'combo');
      }
      
      addLogTime(`  âš”ï¸ í”¼í•´: ì²´ë ¥ -${hpDmg.toFixed(1)}, ë‚´ê³µ -${ngDmg.toFixed(1)}`, 'damage');
      
      // ìµœì†Œê°’ ë³´ì •
      atkChar.hp = Math.max(0, atkChar.hp);
      atkChar.neigong = Math.max(0, atkChar.neigong);
      defChar.hp = Math.max(0, defChar.hp);
      defChar.neigong = Math.max(0, defChar.neigong);
      
      // ìš´ê¸° ë¦¬ì…‹
      atkChar.ungi = 0;
      defChar.ungi = 0;
      atkChar.currentAction = 'ìš´ê¸° ì‹œì‘';
      defChar.currentAction = 'ì²´ì„¸ ì •ë¹„';
      
      // ì „íˆ¬ë¶ˆëŠ¥ ì²´í¬
      const newDefStats = getCharStats(defender);
      if (newDefStats.isDead) {
        addLog(``, '');
        addLogTime(`ğŸ’€ ${defName}, ë” ì´ìƒ ë²„í‹¸ ìˆ˜ ì—†ë‹¤... ì „íˆ¬ë¶ˆëŠ¥!`, 'critical');
        state.winner = attacker;
      }
      
      const newAtkStats = getCharStats(attacker);
      if (newAtkStats.isDead && !state.winner) {
        addLogTime(`ğŸ’€ ${atkName}, ë‚´ìƒì˜ ë°˜ë™ìœ¼ë¡œ ì“°ëŸ¬ì§„ë‹¤!`, 'critical');
        state.winner = defender;
      }
      
      updateUI();
    }
    
    // ===== ë©”ì¸ ë£¨í”„ =====
    function gameLoop(timestamp) {
      if (!state.running) return;
      
      const speed = parseFloat(document.getElementById('sim-speed').value);
      
      if (state.lastTime === 0) state.lastTime = timestamp;
      
      const delta = (timestamp - state.lastTime) / 1000 * speed;
      state.lastTime = timestamp;
      state.time += delta;
      
      // ìš´ê¸° ì¶©ì „
      const allyStats = getCharStats('ally');
      const enemyStats = getCharStats('enemy');
      
      if (!allyStats.isDead) {
        state.ally.ungi += allyStats.ungiPerSec * delta;
        state.ally.ungi = Math.min(100, state.ally.ungi);
        if (state.ally.ungi < 80) {
          state.ally.currentAction = `ìš´ê¸° ${state.ally.ungi.toFixed(0)}%`;
        }
      }
      
      if (!enemyStats.isDead) {
        state.enemy.ungi += enemyStats.ungiPerSec * delta;
        state.enemy.ungi = Math.min(100, state.enemy.ungi);
        if (state.enemy.ungi < 80) {
          state.enemy.currentAction = `ìš´ê¸° ${state.enemy.ungi.toFixed(0)}%`;
        }
      }
      
      // ê³µê²© ì²´í¬
      const allyCanAttack = state.ally.ungi >= 80 && !allyStats.isDead;
      const enemyCanAttack = state.enemy.ungi >= 80 && !enemyStats.isDead;
      
      if (allyCanAttack || enemyCanAttack) {
        if (allyCanAttack && enemyCanAttack) {
          // ì´ë™ì†ë„ë¡œ ì„ ê³µ ê²°ì •
          if (allyStats.moveSpeed >= enemyStats.moveSpeed) {
            processAttack('ally', 'enemy');
          } else {
            processAttack('enemy', 'ally');
          }
        } else if (allyCanAttack) {
          processAttack('ally', 'enemy');
        } else {
          processAttack('enemy', 'ally');
        }
      }
      
      updateUI();
      
      if (state.winner) {
        endBattle();
        return;
      }
      
      state.animFrame = requestAnimationFrame(gameLoop);
    }
    
    // ===== ì „íˆ¬ ì»¨íŠ¸ë¡¤ =====
    function startBattle() {
      if (state.running) return;
      
      state.running = true;
      state.lastTime = 0;
      
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-stop').style.display = 'inline-block';
      document.querySelectorAll('.char-config select').forEach(el => el.disabled = true);
      
      if (state.time === 0) {
        document.getElementById('log-content').innerHTML = '';
        addLog('â”â”â”â”â” ì „íˆ¬ ê°œì‹œ â”â”â”â”â”', 'divider');
        addLogTime('ì–‘ì¸¡ì´ ì„œë¡œë¥¼ ë…¸ë ¤ë³¸ë‹¤...', 'info');
        addLogTime('ìš´ê¸°ë¥¼ ì‹œì‘í•œë‹¤!', 'ready');
      }
      
      state.animFrame = requestAnimationFrame(gameLoop);
    }
    
    function stopBattle() {
      state.running = false;
      state.lastTime = 0;
      if (state.animFrame) cancelAnimationFrame(state.animFrame);
      
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-stop').style.display = 'none';
      
      addLogTime('ì „íˆ¬ ì¼ì‹œì •ì§€', 'info');
    }
    
    function endBattle() {
      state.running = false;
      if (state.animFrame) cancelAnimationFrame(state.animFrame);
      
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-stop').style.display = 'none';
      
      const winnerName = state.winner === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      const resultText = `ğŸ† ${winnerName} ìŠ¹ë¦¬! (${state.time.toFixed(1)}ì´ˆ, ${state.attackCount}í•©)`;
      
      document.getElementById('battle-result').style.display = 'block';
      document.getElementById('result-text').textContent = resultText;
      
      addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'divider');
      addLog(resultText, 'ready');
    }
    
    function resetBattle() {
      stopBattle();
      
      state.time = 0;
      state.attackCount = 0;
      state.winner = null;
      state.comboCount = 0;
      state.lastAttacker = null;
      
      ['ally', 'enemy'].forEach(side => {
        state[side].hp = 100;
        state[side].neigong = 100;
        state[side].ungi = 0;
        state[side].currentDir = null;
        state[side].currentAction = 'ëŒ€ê¸° ì¤‘';
      });
      
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-stop').style.display = 'none';
      document.getElementById('battle-result').style.display = 'none';
      document.querySelectorAll('.char-config select').forEach(el => el.disabled = false);
      
      setApproaching(false);
      
      document.getElementById('log-content').innerHTML = `
        <div class="log-line info">ì „íˆ¬ ì‹œì‘ì„ ëˆ„ë¥´ë©´ ì‹¤ì‹œê°„ ìš´ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</div>
        <div class="log-line info">ìš´ê¸° 80% ì´ìƒ â†’ ì ‘ê·¼ â†’ ê³µê²©!</div>
      `;
      
      updateUI();
    }
    
    // ===== ì´ˆê¸°í™” =====
    updateUI();
  </script>
</body>
</html>
