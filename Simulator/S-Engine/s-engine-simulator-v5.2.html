<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S-Engine æˆ°é¬ª è©¦æ¼”å™¨ v5.2 - å®Œæˆç‰ˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
      color: #e0e0e0;
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      padding: 12px 8px;
      font-size: 13px;
    }
    
    .container { max-width: 1600px; margin: 0 auto; }
    
    header { text-align: center; margin-bottom: 12px; }
    
    h1 {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.6rem;
      background: linear-gradient(135deg, #ffd700 0%, #ff6b35 50%, #ffd700 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle { color: #888; font-size: 0.75rem; }
    
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 420px 1fr;
      gap: 12px;
      align-items: start;
    }
    
    @media (max-width: 1400px) {
      .main-layout { grid-template-columns: 1fr; }
    }
    
    /* ìºë¦­í„° íŒ¨ë„ */
    .char-panel {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .char-panel.ally { border-color: rgba(231,76,60,0.3); }
    .char-panel.enemy { border-color: rgba(52,152,219,0.3); }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .panel-header h2 {
      font-family: 'Noto Serif KR', serif;
      font-size: 1rem;
    }
    
    .panel-header.ally h2 { color: #e74c3c; }
    .panel-header.enemy h2 { color: #3498db; }
    
    .char-name { font-size: 0.95rem; font-weight: bold; margin-bottom: 8px; }
    .char-name.ally { color: #e74c3c; }
    .char-name.enemy { color: #3498db; }
    
    /* ì„¤ì • ê·¸ë¦¬ë“œ */
    .config-section {
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
    }
    
    .config-title {
      font-size: 0.7rem;
      color: #888;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .config-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    
    .config-grid.two-col { grid-template-columns: repeat(2, 1fr); }
    
    .config-item label {
      display: block;
      font-size: 0.6rem;
      color: #777;
      margin-bottom: 2px;
    }
    
    .config-item select, .config-item input {
      width: 100%;
      padding: 4px 5px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 3px;
      color: #fff;
      font-size: 0.7rem;
    }
    
    .config-item input[type="number"] {
      width: 45px;
    }
    
    /* ìš´ê¸° ê²Œì´ì§€ */
    .ungi-section {
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
    }
    
    .ungi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .ungi-label { font-size: 0.75rem; color: #ffd700; font-weight: bold; }
    .ungi-value { font-size: 1rem; font-weight: bold; font-family: monospace; }
    .ungi-value.ready { color: #2ecc71; }
    .ungi-value.charging { color: #f39c12; }
    
    .ungi-bar-container {
      position: relative;
      height: 18px;
      background: rgba(0,0,0,0.5);
      border-radius: 9px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .ungi-bar {
      height: 100%;
      border-radius: 9px;
      transition: width 0.05s linear;
    }
    
    .ungi-bar.ally { background: linear-gradient(90deg, #c0392b, #e74c3c, #f39c12); }
    .ungi-bar.enemy { background: linear-gradient(90deg, #2980b9, #3498db, #1abc9c); }
    .ungi-bar.ready { box-shadow: 0 0 10px rgba(46,204,113,0.7); }
    
    .ungi-threshold {
      position: absolute;
      left: 80%;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #2ecc71;
      z-index: 10;
    }
    
    .ungi-status {
      text-align: center;
      margin-top: 3px;
      font-size: 0.65rem;
      font-weight: bold;
    }
    
    .ungi-status.ready { color: #2ecc71; }
    .ungi-status.charging { color: #f39c12; }
    
    /* ìŠ¤íƒ¯ ë°” */
    .stat-bars {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
      margin-bottom: 8px;
    }
    
    .stat-bar {
      background: rgba(0,0,0,0.25);
      border-radius: 4px;
      padding: 4px 6px;
    }
    
    .stat-bar .label {
      display: flex;
      justify-content: space-between;
      font-size: 0.6rem;
      margin-bottom: 2px;
    }
    
    .stat-bar .track {
      height: 5px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .stat-bar .fill { height: 100%; transition: width 0.3s; }
    .stat-bar .fill.hp { background: linear-gradient(90deg, #c0392b, #e74c3c); }
    .stat-bar .fill.ng { background: linear-gradient(90deg, #2980b9, #3498db); }
    
    /* ë¬¼ì•½ ì„¹ì…˜ */
    .potion-section {
      background: rgba(46,204,113,0.08);
      border: 1px solid rgba(46,204,113,0.2);
      border-radius: 6px;
      padding: 6px 8px;
      margin-bottom: 8px;
    }
    
    .potion-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    
    .potion-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.65rem;
    }
    
    .potion-item label { color: #aaa; min-width: 28px; }
    
    .potion-count {
      padding: 1px 5px;
      background: rgba(46,204,113,0.2);
      border-radius: 3px;
      color: #2ecc71;
      font-size: 0.65rem;
      min-width: 18px;
      text-align: center;
    }
    
    .potion-count.empty { background: rgba(231,76,60,0.2); color: #e74c3c; }
    
    /* í˜„ì¬ ìƒíƒœ */
    .status-display {
      background: rgba(155,89,182,0.1);
      border-radius: 5px;
      padding: 6px;
      font-size: 0.65rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3px;
    }
    
    .status-item span:first-child { color: #888; }
    .status-item span:last-child { color: #fff; font-weight: bold; }
    
    .action-display {
      margin-top: 6px;
      padding: 6px;
      background: rgba(0,0,0,0.3);
      border-radius: 5px;
      text-align: center;
    }
    
    .action-label { font-size: 0.6rem; color: #888; margin-bottom: 2px; }
    .action-text { font-size: 0.8rem; font-weight: bold; min-height: 18px; }
    .action-text.move { color: #f39c12; }
    .action-text.attack { color: #e74c3c; }
    .action-text.defend { color: #3498db; }
    .action-text.potion { color: #2ecc71; }
    
    /* ì¤‘ì•™ ì „íˆ¬ ì˜ì—­ */
    .battle-area { display: flex; flex-direction: column; gap: 8px; }
    
    .battle-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .btn {
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover { transform: scale(1.03); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-start { background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; }
    .btn-stop { background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; }
    .btn-reset { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #aaa; }
    
    .options-row {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .option-box {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 4px 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      font-size: 0.7rem;
    }
    
    .option-box label { color: #888; }
    .option-box select {
      padding: 2px 4px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 3px;
      color: #fff;
      font-size: 0.7rem;
    }
    
    /* ì „íˆ¬ ì‹œê°í™” */
    .battle-visual {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 10px;
    }
    
    .arena {
      position: relative;
      height: 80px;
      background: linear-gradient(180deg, rgba(0,0,0,0.3), rgba(50,50,80,0.2));
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.1);
      overflow: hidden;
    }
    
    .fighter-token {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      text-align: center;
      transition: left 0.3s ease;
    }
    
    .fighter-token.ally { left: 15%; }
    .fighter-token.enemy { left: 75%; }
    .fighter-token.approaching.ally { left: 35%; }
    .fighter-token.approaching.enemy { left: 55%; }
    
    .fighter-icon { font-size: 1.8rem; }
    .fighter-label { font-size: 0.65rem; font-weight: bold; }
    .fighter-label.ally { color: #e74c3c; }
    .fighter-label.enemy { color: #3498db; }
    
    .clash-effect {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.8rem;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .clash-effect.active {
      opacity: 1;
      animation: clashPulse 0.3s ease;
    }
    
    @keyframes clashPulse {
      0% { transform: translate(-50%, -50%) scale(0.5); }
      50% { transform: translate(-50%, -50%) scale(1.3); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    
    .combo-display {
      text-align: center;
      margin-top: 6px;
      font-size: 0.7rem;
    }
    
    .combo-count { font-weight: bold; color: #ffd700; }
    
    /* ì „íˆ¬ ë¡œê·¸ */
    .battle-log-container {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      height: 340px;
    }
    
    .log-header {
      padding: 6px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .log-header h3 {
      color: #ffd700;
      font-family: 'Noto Serif KR', serif;
      font-size: 0.85rem;
    }
    
    .log-stats {
      display: flex;
      gap: 6px;
      font-size: 0.65rem;
    }
    
    .log-stats span { padding: 2px 5px; border-radius: 3px; }
    .log-stats .time { background: rgba(155,89,182,0.2); color: #9b59b6; }
    .log-stats .round { background: rgba(255,215,0,0.2); color: #ffd700; }
    .log-stats .potion { background: rgba(46,204,113,0.2); color: #2ecc71; }
    
    .log-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      font-family: 'D2Coding', monospace;
      font-size: 0.68rem;
      line-height: 1.45;
    }
    
    .log-line { margin-bottom: 1px; color: #bbb; }
    .log-line.move { color: #f39c12; }
    .log-line.attack { color: #e74c3c; font-weight: bold; }
    .log-line.defend { color: #3498db; }
    .log-line.damage { color: #ff6b6b; }
    .log-line.naesang { color: #9b59b6; font-style: italic; }
    .log-line.combo { color: #ffd700; font-weight: bold; }
    .log-line.ready { color: #2ecc71; font-weight: bold; }
    .log-line.info { color: #888; font-style: italic; }
    .log-line.potion { color: #2ecc71; }
    .log-line.critical { color: #e74c3c; font-weight: bold; background: rgba(231,76,60,0.12); padding: 1px 4px; border-radius: 2px; }
    .log-line.divider { color: #555; text-align: center; }
    .log-line.mugong { color: #9b59b6; font-weight: bold; }
    
    .battle-result {
      padding: 8px;
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }
    
    .result-text {
      font-family: 'Noto Serif KR', serif;
      font-size: 1rem;
      color: #ffd700;
    }
    
    footer {
      text-align: center;
      margin-top: 12px;
      color: #555;
      font-size: 0.65rem;
    }
    
    .highlight-red { color: #e74c3c; }
    .highlight-blue { color: #3498db; }
    .highlight-gold { color: #ffd700; }
    .highlight-green { color: #2ecc71; }
    .highlight-purple { color: #9b59b6; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>S-Engine æˆ°é¬ª è©¦æ¼”å™¨</h1>
      <p class="subtitle">v5.2 å®Œæˆç‰ˆ - ì‹¤ì‹œê°„ ìš´ê¸° + ë¬´ê³µ + ë³´ë²• + ë¬¼ì•½</p>
    </header>
    
    <div class="main-layout">
      <!-- ì•„êµ° íŒ¨ë„ -->
      <div class="char-panel ally">
        <div class="panel-header ally">
          <h2>âš”ï¸ ì•„êµ°</h2>
        </div>
        <div class="char-name ally">ê²€í˜¸</div>
        
        <!-- ê¸°ë³¸ ì„¤ì • -->
        <div class="config-section">
          <div class="config-title">âš™ï¸ ê¸°ë³¸ ì„¤ì •</div>
          <div class="config-grid">
            <div class="config-item">
              <label>ê²½ì§€</label>
              <select id="ally-gyeongji" onchange="updateChar('ally')">
                <option value="ì‚¼ë¥˜">ì‚¼ë¥˜</option>
                <option value="ì´ë¥˜">ì´ë¥˜</option>
                <option value="ì¼ë¥˜">ì¼ë¥˜</option>
                <option value="ì ˆì •" selected>ì ˆì •</option>
                <option value="ì´ˆì ˆì •">ì´ˆì ˆì •</option>
                <option value="í™”ê²½">í™”ê²½</option>
                <option value="í˜„ê²½">í˜„ê²½</option>
                <option value="ìƒì‚¬ê²½">ìƒì‚¬ê²½</option>
                <option value="ìì—°ê²½">ìì—°ê²½</option>
              </select>
            </div>
            <div class="config-item">
              <label>ì‹¬ë²•</label>
              <select id="ally-simbeop" onchange="updateChar('ally')">
                <option value="ì‚¼ì¬ì‹¬ë²•">ì‚¼ì¬</option>
                <option value="ê¸°ì´ˆì‹¬ë²•">ê¸°ì´ˆ</option>
                <option value="ê¸°ë³¸ì‹¬ë²•" selected>ê¸°ë³¸</option>
                <option value="ì‹¬í™”ì‹¬ë²•">ì‹¬í™”</option>
                <option value="ë¹„ì „ì‹¬ë²•">ë¹„ì „</option>
                <option value="ëª…ìš´ì‹¬ë²•">ëª…ìš´</option>
                <option value="ì²œë§ˆì‹¬ê³µ">ì²œë§ˆ</option>
              </select>
            </div>
            <div class="config-item">
              <label>ë³´ë²•</label>
              <select id="ally-bobeop" onchange="updateChar('ally')">
                <option value="0">ì—†ìŒ</option>
                <option value="1">Lv1</option>
                <option value="2">Lv2</option>
                <option value="3">Lv3</option>
                <option value="4">Lv4</option>
                <option value="5" selected>Lv5</option>
                <option value="6">Lv6</option>
                <option value="7">Lv7</option>
                <option value="8">Lv8</option>
                <option value="9">Lv9</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- ë¬´ê³µ ì„¤ì • -->
        <div class="config-section">
          <div class="config-title">ğŸ—¡ï¸ ë¬´ê³µ ì„¤ì •</div>
          <div class="config-grid two-col">
            <div class="config-item">
              <label>ë‚´ê³µë¬´ê³µ</label>
              <select id="ally-mugong" onchange="updateChar('ally')">
                <option value="ê²€ê¸°">ê²€ê¸°</option>
                <option value="ê²€ì‚¬">ê²€ì‚¬</option>
                <option value="ê²€ê°•" selected>ê²€ê°•</option>
              </select>
            </div>
            <div class="config-item">
              <label>ìˆ™ë ¨ë„</label>
              <select id="ally-mugongLv" onchange="updateChar('ally')">
                <option value="1">ä¸‹ (ì…ë¬¸)</option>
                <option value="2">ä¸­ (ìµìˆ™)</option>
                <option value="3" selected>ä¸Šä¸‹ (ëŠ¥ìˆ™)</option>
                <option value="4">ä¸Šä¸­ (ìˆ™ë ¨)</option>
                <option value="5">ä¸Šä¸Š (ì™„ìˆ™)</option>
              </select>
            </div>
            <div class="config-item">
              <label>ë°œì¶œê¸°</label>
              <select id="ally-balchul" onchange="updateChar('ally')">
                <option value="ì—†ìŒ">ì—†ìŒ</option>
                <option value="ê²€ê¸°ë°œì¶œ">ê²€ê¸°ë°œì¶œ</option>
                <option value="ê²€ê¸°ì¦‰ì‹œë°œì¶œ">ê²€ê¸°ì¦‰ì‹œë°œì¶œ</option>
                <option value="ê²€ê°•ë°œì¶œ">ê²€ê°•ë°œì¶œ</option>
                <option value="ê²€ê°•ì¦‰ì‹œë°œì¶œ">ê²€ê°•ì¦‰ì‹œë°œì¶œ</option>
              </select>
            </div>
            <div class="config-item">
              <label>ë°œì¶œ ìˆ™ë ¨</label>
              <select id="ally-balchulLv" onchange="updateChar('ally')">
                <option value="1">ä¸‹</option>
                <option value="2">ä¸­</option>
                <option value="3" selected>ä¸Šä¸‹</option>
                <option value="4">ä¸Šä¸­</option>
                <option value="5">ä¸Šä¸Š</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- ìš´ê¸° ê²Œì´ì§€ -->
        <div class="ungi-section">
          <div class="ungi-header">
            <span class="ungi-label">ğŸŒ€ ìš´ê¸°</span>
            <span class="ungi-value charging" id="ally-ungi-value">0%</span>
          </div>
          <div class="ungi-bar-container">
            <div class="ungi-threshold"></div>
            <div class="ungi-bar ally" id="ally-ungi-bar" style="width: 0%"></div>
          </div>
          <div class="ungi-status charging" id="ally-ungi-status">ì¶©ì „ ì¤‘...</div>
        </div>
        
        <!-- ì²´ë ¥/ë‚´ê³µ -->
        <div class="stat-bars">
          <div class="stat-bar">
            <div class="label">
              <span>ì²´ë ¥</span>
              <span class="highlight-red" id="ally-hp">100.0</span>
            </div>
            <div class="track"><div class="fill hp" id="ally-hp-bar" style="width: 100%"></div></div>
          </div>
          <div class="stat-bar">
            <div class="label">
              <span>ë‚´ê³µ</span>
              <span class="highlight-blue" id="ally-ng">100.0</span>
            </div>
            <div class="track"><div class="fill ng" id="ally-ng-bar" style="width: 100%"></div></div>
          </div>
        </div>
        
        <!-- ë¬¼ì•½ ì„¤ì • -->
        <div class="potion-section">
          <div class="config-title">ğŸ’Š ë¬¼ì•½ (ìë™ì‚¬ìš©)</div>
          <div class="potion-grid">
            <div class="potion-item">
              <label>â¤ï¸</label>
              <span class="potion-count" id="ally-hp-pot">5</span>
              <input type="number" id="ally-hp-pot-input" value="5" min="0" max="99" onchange="updatePotion('ally','hp',this.value)">
              <select id="ally-hp-threshold" style="width:55px">
                <option value="50" selected>50%â†“</option>
                <option value="40">40%â†“</option>
                <option value="30">30%â†“</option>
              </select>
            </div>
            <div class="potion-item">
              <label>ğŸ’™</label>
              <span class="potion-count" id="ally-ng-pot">5</span>
              <input type="number" id="ally-ng-pot-input" value="5" min="0" max="99" onchange="updatePotion('ally','ng',this.value)">
              <select id="ally-ng-threshold" style="width:55px">
                <option value="60" selected>60%â†“</option>
                <option value="50">50%â†“</option>
                <option value="40">40%â†“</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- ìƒíƒœ ì •ë³´ -->
        <div class="status-display">
          <div class="status-item"><span>ê³µì†:</span> <span id="ally-atkspd">1.50s</span></div>
          <div class="status-item"><span>ì´ì†:</span> <span id="ally-movspd">âˆš5</span></div>
          <div class="status-item"><span>íŒŒê´´ë ¥:</span> <span id="ally-power">5.48</span></div>
          <div class="status-item"><span>ë¬´ê³µ+:</span> <span id="ally-mugong-bonus">+23%</span></div>
        </div>
        
        <div class="action-display">
          <div class="action-label">í˜„ì¬ ë™ì‘</div>
          <div class="action-text move" id="ally-action">ëŒ€ê¸° ì¤‘</div>
        </div>
      </div>
      
      <!-- ì¤‘ì•™ ì „íˆ¬ ì˜ì—­ -->
      <div class="battle-area">
        <div class="battle-visual">
          <div class="arena">
            <div class="fighter-token ally" id="ally-token">
              <div class="fighter-icon">ğŸ—¡ï¸</div>
              <div class="fighter-label ally">ê²€í˜¸</div>
            </div>
            <div class="clash-effect" id="clash-effect">ğŸ’¥</div>
            <div class="fighter-token enemy" id="enemy-token">
              <div class="fighter-icon">ğŸ›¡ï¸</div>
              <div class="fighter-label enemy">ë„ì </div>
            </div>
          </div>
          <div class="combo-display">
            ì—°ì†íƒ€: <span class="combo-count" id="combo-count">0</span> |
            ìŠ¬ë¡œëª¨ì…˜: <span id="slowmo-status">ëŒ€ê¸°</span>
          </div>
        </div>
        
        <div class="battle-controls">
          <button class="btn btn-start" id="btn-start" onclick="startBattle()">â–¶ï¸ ì „íˆ¬ ì‹œì‘</button>
          <button class="btn btn-stop" id="btn-stop" onclick="stopBattle()" style="display:none;">â¹ï¸ ì¤‘ì§€</button>
          <button class="btn btn-reset" onclick="resetBattle()">â†º ì´ˆê¸°í™”</button>
        </div>
        
        <div class="options-row">
          <div class="option-box">
            <label>â±ï¸</label>
            <select id="sim-speed">
              <option value="0.5">0.5x</option>
              <option value="1" selected>1x</option>
              <option value="2">2x</option>
              <option value="5">5x</option>
            </select>
          </div>
          <div class="option-box">
            <label>ğŸ’Š íšŒë³µëŸ‰</label>
            <select id="potion-heal">
              <option value="10">10%</option>
              <option value="15" selected>15%</option>
              <option value="20">20%</option>
            </select>
          </div>
        </div>
        
        <div class="battle-log-container">
          <div class="log-header">
            <h3>ğŸ“œ ì „íˆ¬ ê¸°ë¡</h3>
            <div class="log-stats">
              <span class="time">â±ï¸ <span id="battle-time">0.0</span>s</span>
              <span class="round">ğŸ’¥ <span id="attack-count">0</span>í•©</span>
              <span class="potion">ğŸ’Š <span id="potion-used">0</span></span>
            </div>
          </div>
          <div class="log-content" id="log-content">
            <div class="log-line info">ì „íˆ¬ ì‹œì‘ì„ ëˆ„ë¥´ë©´ ì‹¤ì‹œê°„ ìš´ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</div>
          </div>
          <div class="battle-result" id="battle-result" style="display: none;">
            <div class="result-text" id="result-text"></div>
          </div>
        </div>
      </div>
      
      <!-- ì êµ° íŒ¨ë„ -->
      <div class="char-panel enemy">
        <div class="panel-header enemy">
          <h2>ğŸ›¡ï¸ ì êµ°</h2>
        </div>
        <div class="char-name enemy">ë„ì </div>
        
        <div class="config-section">
          <div class="config-title">âš™ï¸ ê¸°ë³¸ ì„¤ì •</div>
          <div class="config-grid">
            <div class="config-item">
              <label>ê²½ì§€</label>
              <select id="enemy-gyeongji" onchange="updateChar('enemy')">
                <option value="ì‚¼ë¥˜">ì‚¼ë¥˜</option>
                <option value="ì´ë¥˜">ì´ë¥˜</option>
                <option value="ì¼ë¥˜" selected>ì¼ë¥˜</option>
                <option value="ì ˆì •">ì ˆì •</option>
                <option value="ì´ˆì ˆì •">ì´ˆì ˆì •</option>
                <option value="í™”ê²½">í™”ê²½</option>
                <option value="í˜„ê²½">í˜„ê²½</option>
                <option value="ìƒì‚¬ê²½">ìƒì‚¬ê²½</option>
                <option value="ìì—°ê²½">ìì—°ê²½</option>
              </select>
            </div>
            <div class="config-item">
              <label>ì‹¬ë²•</label>
              <select id="enemy-simbeop" onchange="updateChar('enemy')">
                <option value="ì‚¼ì¬ì‹¬ë²•">ì‚¼ì¬</option>
                <option value="ê¸°ì´ˆì‹¬ë²•" selected>ê¸°ì´ˆ</option>
                <option value="ê¸°ë³¸ì‹¬ë²•">ê¸°ë³¸</option>
                <option value="ì‹¬í™”ì‹¬ë²•">ì‹¬í™”</option>
                <option value="ë¹„ì „ì‹¬ë²•">ë¹„ì „</option>
                <option value="ëª…ìš´ì‹¬ë²•">ëª…ìš´</option>
                <option value="ì²œë§ˆì‹¬ê³µ">ì²œë§ˆ</option>
              </select>
            </div>
            <div class="config-item">
              <label>ë³´ë²•</label>
              <select id="enemy-bobeop" onchange="updateChar('enemy')">
                <option value="0">ì—†ìŒ</option>
                <option value="1">Lv1</option>
                <option value="2">Lv2</option>
                <option value="3" selected>Lv3</option>
                <option value="4">Lv4</option>
                <option value="5">Lv5</option>
                <option value="6">Lv6</option>
                <option value="7">Lv7</option>
                <option value="8">Lv8</option>
                <option value="9">Lv9</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="config-section">
          <div class="config-title">ğŸ—¡ï¸ ë¬´ê³µ ì„¤ì •</div>
          <div class="config-grid two-col">
            <div class="config-item">
              <label>ë‚´ê³µë¬´ê³µ</label>
              <select id="enemy-mugong" onchange="updateChar('enemy')">
                <option value="ê²€ê¸°">ê²€ê¸°</option>
                <option value="ê²€ì‚¬" selected>ê²€ì‚¬</option>
                <option value="ê²€ê°•">ê²€ê°•</option>
              </select>
            </div>
            <div class="config-item">
              <label>ìˆ™ë ¨ë„</label>
              <select id="enemy-mugongLv" onchange="updateChar('enemy')">
                <option value="1">ä¸‹</option>
                <option value="2" selected>ä¸­</option>
                <option value="3">ä¸Šä¸‹</option>
                <option value="4">ä¸Šä¸­</option>
                <option value="5">ä¸Šä¸Š</option>
              </select>
            </div>
            <div class="config-item">
              <label>ë°œì¶œê¸°</label>
              <select id="enemy-balchul" onchange="updateChar('enemy')">
                <option value="ì—†ìŒ" selected>ì—†ìŒ</option>
                <option value="ê²€ê¸°ë°œì¶œ">ê²€ê¸°ë°œì¶œ</option>
                <option value="ê²€ê¸°ì¦‰ì‹œë°œì¶œ">ê²€ê¸°ì¦‰ì‹œë°œì¶œ</option>
                <option value="ê²€ê°•ë°œì¶œ">ê²€ê°•ë°œì¶œ</option>
                <option value="ê²€ê°•ì¦‰ì‹œë°œì¶œ">ê²€ê°•ì¦‰ì‹œë°œì¶œ</option>
              </select>
            </div>
            <div class="config-item">
              <label>ë°œì¶œ ìˆ™ë ¨</label>
              <select id="enemy-balchulLv" onchange="updateChar('enemy')">
                <option value="1" selected>ä¸‹</option>
                <option value="2">ä¸­</option>
                <option value="3">ä¸Šä¸‹</option>
                <option value="4">ä¸Šä¸­</option>
                <option value="5">ä¸Šä¸Š</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="ungi-section">
          <div class="ungi-header">
            <span class="ungi-label">ğŸŒ€ ìš´ê¸°</span>
            <span class="ungi-value charging" id="enemy-ungi-value">0%</span>
          </div>
          <div class="ungi-bar-container">
            <div class="ungi-threshold"></div>
            <div class="ungi-bar enemy" id="enemy-ungi-bar" style="width: 0%"></div>
          </div>
          <div class="ungi-status charging" id="enemy-ungi-status">ì¶©ì „ ì¤‘...</div>
        </div>
        
        <div class="stat-bars">
          <div class="stat-bar">
            <div class="label">
              <span>ì²´ë ¥</span>
              <span class="highlight-red" id="enemy-hp">100.0</span>
            </div>
            <div class="track"><div class="fill hp" id="enemy-hp-bar" style="width: 100%"></div></div>
          </div>
          <div class="stat-bar">
            <div class="label">
              <span>ë‚´ê³µ</span>
              <span class="highlight-blue" id="enemy-ng">100.0</span>
            </div>
            <div class="track"><div class="fill ng" id="enemy-ng-bar" style="width: 100%"></div></div>
          </div>
        </div>
        
        <div class="potion-section">
          <div class="config-title">ğŸ’Š ë¬¼ì•½ (ìë™ì‚¬ìš©)</div>
          <div class="potion-grid">
            <div class="potion-item">
              <label>â¤ï¸</label>
              <span class="potion-count" id="enemy-hp-pot">3</span>
              <input type="number" id="enemy-hp-pot-input" value="3" min="0" max="99" onchange="updatePotion('enemy','hp',this.value)">
              <select id="enemy-hp-threshold" style="width:55px">
                <option value="50" selected>50%â†“</option>
                <option value="40">40%â†“</option>
                <option value="30">30%â†“</option>
              </select>
            </div>
            <div class="potion-item">
              <label>ğŸ’™</label>
              <span class="potion-count" id="enemy-ng-pot">3</span>
              <input type="number" id="enemy-ng-pot-input" value="3" min="0" max="99" onchange="updatePotion('enemy','ng',this.value)">
              <select id="enemy-ng-threshold" style="width:55px">
                <option value="60" selected>60%â†“</option>
                <option value="50">50%â†“</option>
                <option value="40">40%â†“</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="status-display">
          <div class="status-item"><span>ê³µì†:</span> <span id="enemy-atkspd">1.73s</span></div>
          <div class="status-item"><span>ì´ì†:</span> <span id="enemy-movspd">âˆš3</span></div>
          <div class="status-item"><span>íŒŒê´´ë ¥:</span> <span id="enemy-power">4.47</span></div>
          <div class="status-item"><span>ë¬´ê³µ+:</span> <span id="enemy-mugong-bonus">+9%</span></div>
        </div>
        
        <div class="action-display">
          <div class="action-label">í˜„ì¬ ë™ì‘</div>
          <div class="action-text move" id="enemy-action">ëŒ€ê¸° ì¤‘</div>
        </div>
      </div>
    </div>
    
    <footer>
      S-Engine Combat Simulator v5.2 å®Œæˆç‰ˆ by ShadowK
    </footer>
  </div>
  
  <script>
    // ===== ë°ì´í„° =====
    const GYEONGJI = {
      'ì‚¼ë¥˜': { level: 1, speed: Math.sqrt(1) },
      'ì´ë¥˜': { level: 2, speed: Math.sqrt(2) },
      'ì¼ë¥˜': { level: 3, speed: Math.sqrt(3) },
      'ì ˆì •': { level: 4, speed: Math.sqrt(4) },
      'ì´ˆì ˆì •': { level: 5, speed: Math.sqrt(5) },
      'í™”ê²½': { level: 6, speed: Math.sqrt(6) },
      'í˜„ê²½': { level: 7, speed: Math.sqrt(7) },
      'ìƒì‚¬ê²½': { level: 8, speed: Math.sqrt(8) },
      'ìì—°ê²½': { level: 9, speed: Math.sqrt(9) }
    };
    
    const SIMBEOP = {
      'ì‚¼ì¬ì‹¬ë²•': { chukgi: 10, stab: 90, type: 'ê¸°ë³¸' },
      'ê¸°ì´ˆì‹¬ë²•': { chukgi: 20, stab: 80, type: 'ê¸°ì´ˆ' },
      'ê¸°ë³¸ì‹¬ë²•': { chukgi: 30, stab: 70, type: 'ê¸°ë³¸' },
      'ì‹¬í™”ì‹¬ë²•': { chukgi: 40, stab: 70, type: 'ì‹¬í™”' },
      'ë¹„ì „ì‹¬ë²•': { chukgi: 70, stab: 60, type: 'ë¹„ì „' },
      'ëª…ìš´ì‹¬ë²•': { chukgi: 110, stab: 80, type: 'ì‹ ê³µLv1' },
      'ì²œë§ˆì‹¬ê³µ': { chukgi: 130, stab: 70, type: 'ì‹ ê³µLv2' }
    };
    
    const THRESHOLD = { 'ê¸°ì´ˆ': 40, 'ê¸°ë³¸': 40, 'ì‹¬í™”': 40, 'ë¹„ì „': 35, 'ì‹ ê³µLv1': 30, 'ì‹ ê³µLv2': 25 };
    
    // ë¬´ê³µ ë°ì´í„° [ê³µë°©ë³´ì •%, ë‚´ê³µì†Œë¹„]
    const MUGONG = {
      'ê²€ê¸°': { 1: [2,1], 2: [4,1], 3: [6,1], 4: [8,1], 5: [10,1] },
      'ê²€ì‚¬': { 1: [6,2], 2: [9,2], 3: [12,2], 4: [15,2], 5: [18,2] },
      'ê²€ê°•': { 1: [15,3], 2: [19,3], 3: [23,3], 4: [28,3], 5: [33,3] }
    };
    
    // ë°œì¶œê¸° ë°ì´í„°
    const BALCHUL = {
      'ì—†ìŒ': { bonus: 0, cost: 0, range: 'ê·¼ì ‘' },
      'ê²€ê¸°ë°œì¶œ': { bonus: 8, cost: 2, range: 'ì¤‘ê±°ë¦¬' },
      'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': { bonus: 12, cost: 3, range: 'ì¤‘ê±°ë¦¬' },
      'ê²€ê°•ë°œì¶œ': { bonus: 18, cost: 4, range: 'ì›ê±°ë¦¬' },
      'ê²€ê°•ì¦‰ì‹œë°œì¶œ': { bonus: 25, cost: 5, range: 'ì›ê±°ë¦¬' }
    };
    
    const LEVEL_NAME = ['', 'ä¸‹', 'ä¸­', 'ä¸Šä¸‹', 'ä¸Šä¸­', 'ä¸Šä¸Š'];
    
    // ì´ë™/ê³µê²© ë°ì´í„°
    const DIRECTIONS = ['ì „ì§„', 'ì „ì¢Œ', 'ì „ìš°', 'ì¢Œ', 'ìš°', 'í›„í‡´', 'í›„ì¢Œ', 'í›„ìš°'];
    const APPROACH_DIR = ['ì „ì§„', 'ì „ì¢Œ', 'ì „ìš°'];
    const RETREAT_DIR = ['í›„í‡´', 'í›„ì¢Œ', 'í›„ìš°'];
    
    const ATTACK_TYPES = {
      ê²€ê¸°: ['ê²€ê¸°ë¥¼ ì‹¤ì€ ì§ì„ ë² ê¸°', 'ê²€ê¸°ë¥¼ ë‘ë¥¸ íš¡ë² ê¸°', 'ê²€ê¸°ë¥¼ ì‘ì¶•í•œ ì°Œë¥´ê¸°'],
      ê²€ì‚¬: ['ê²€ì‚¬ê°€ ë²ˆëœ©ì´ëŠ” ì„¬ê´‘ë² ê¸°', 'ê²€ì‚¬ë¥¼ ë¿œì–´ë‚´ëŠ” íšŒì „ì°¸', 'ê³µê°„ì„ ê°€ë¥´ëŠ” ê²€ì‚¬ê²©'],
      ê²€ê°•: ['ê²€ê°•ì´ ì‘ë ¬í•˜ëŠ” íŒŒì²œê²©', 'ëŒ€ê¸°ë¥¼ ê°€ë¥´ëŠ” ê²€ê°•ì¼ì„¬', 'ë¬´í˜•ì˜ ê²€ê°•ì´ í­ë°œí•œë‹¤']
    };
    
    const BALCHUL_DESC = {
      'ê²€ê¸°ë°œì¶œ': ['ê²€ê¸°ê°€ ê²€ì‹ ì„ ë²—ì–´ë‚˜ ë‚ ì•„ê°„ë‹¤!', 'í—ˆê³µì„ ê°€ë¥´ëŠ” ê²€ê¸° ì¼ì„¬!'],
      'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': ['ì°°ë‚˜ì— ê²€ê¸°ê°€ ë°œì¶œëœë‹¤!', 'ë²ˆê°œì²˜ëŸ¼ ë¹ ë¥¸ ê²€ê¸° ì†ì‚¬!'],
      'ê²€ê°•ë°œì¶œ': ['ì¥ëŒ€í•œ ê²€ê°•ì´ í—ˆê³µì„ ê°€ë¥¸ë‹¤!', 'íŒŒë©¸ì ì¸ ê²€ê°•ì´ ìŸì•„ì§„ë‹¤!'],
      'ê²€ê°•ì¦‰ì‹œë°œì¶œ': ['ì¼ìˆœê°„, ê²€ê°•ì´ ì„¸ê³„ë¥¼ ë² ì—ˆë‹¤!', 'ì‹ ì†í•œ ê²€ê°•, í”¼í•  í‹ˆì´ ì—†ë‹¤!']
    };
    
    const DEFEND_TYPES = ['ê²€ìœ¼ë¡œ í˜ë ¤ëƒ„', 'ëª¸ì„ ë¹„í‹€ì–´ íšŒí”¼', 'ë³´ë²•ìœ¼ë¡œ ê±°ë¦¬ë¥¼ ë²Œë¦¼', 'ê²€ì‹ ìœ¼ë¡œ ë§‰ì•„ëƒ„'];
    const COMBO_BONUS = { 2: 0.05, 3: 0.10, 4: 0.15 };
    
    // ===== ìƒíƒœ =====
    let state = {
      running: false,
      time: 0,
      attackCount: 0,
      winner: null,
      animFrame: null,
      lastTime: 0,
      comboCount: 0,
      lastAttacker: null,
      totalPotionsUsed: 0,
      
      ally: {
        gyeongji: 'ì ˆì •', simbeop: 'ê¸°ë³¸ì‹¬ë²•', bobeop: 5,
        mugong: 'ê²€ê°•', mugongLv: 3, balchul: 'ì—†ìŒ', balchulLv: 3,
        hp: 100, neigong: 100, ungi: 0,
        hpPotions: 5, ngPotions: 5,
        currentAction: 'ëŒ€ê¸° ì¤‘'
      },
      
      enemy: {
        gyeongji: 'ì¼ë¥˜', simbeop: 'ê¸°ì´ˆì‹¬ë²•', bobeop: 3,
        mugong: 'ê²€ì‚¬', mugongLv: 2, balchul: 'ì—†ìŒ', balchulLv: 1,
        hp: 100, neigong: 100, ungi: 0,
        hpPotions: 3, ngPotions: 3,
        currentAction: 'ëŒ€ê¸° ì¤‘'
      }
    };
    
    // ===== ê³„ì‚° =====
    function getCharStats(side) {
      const char = state[side];
      const g = GYEONGJI[char.gyeongji];
      const s = SIMBEOP[char.simbeop];
      const m = MUGONG[char.mugong]?.[char.mugongLv] || [0, 0];
      const b = BALCHUL[char.balchul] || { bonus: 0, cost: 0 };
      
      const atkTime = 3 / g.speed;
      const ungiPath = Math.sqrt(s.chukgi);
      const danger = 1 / Math.sqrt(s.stab);
      const ungiPerSec = 100 / atkTime;
      const power = ungiPath * (char.ungi / 100);
      
      const bobeopBonus = char.bobeop * 0.1;
      const moveSpeed = char.bobeop > 0 ? Math.sqrt(char.bobeop) : 1;
      
      const mugongBonus = m[0] / 100;
      const mugongCost = m[1];
      const balchulBonus = (b.bonus * char.balchulLv / 5) / 100;
      const balchulCost = b.cost;
      
      const threshold = THRESHOLD[s.type];
      const isDead = char.neigong <= threshold || char.hp <= 0;
      
      return {
        g, s, atkTime, ungiPath, danger, ungiPerSec, power,
        bobeopBonus, moveSpeed, mugongBonus, mugongCost, balchulBonus, balchulCost,
        threshold, isDead
      };
    }
    
    function randomPick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    
    function generateMoveDirection(isAttacker) {
      return isAttacker
        ? (Math.random() > 0.2 ? randomPick(APPROACH_DIR) : randomPick(['ì¢Œ', 'ìš°']))
        : randomPick(DIRECTIONS);
    }
    
    function calcDirectionBonus(atkDir, defDir) {
      let bonus = 0, desc = '';
      if (APPROACH_DIR.includes(atkDir)) {
        bonus += atkDir === 'ì „ì§„' ? 0.10 : 0.08;
        desc = `ì ‘ê·¼(${atkDir})`;
      }
      if (RETREAT_DIR.includes(defDir)) {
        bonus += 0.10;
        desc += ' â†’ ì¶”ê²©';
      } else if (['ì¢Œ', 'ìš°'].includes(defDir)) {
        bonus += 0.05;
        desc += ' â†’ ì¸¡ë©´';
      }
      return { bonus, desc };
    }
    
    // ===== UI =====
    function updateUI() {
      ['ally', 'enemy'].forEach(side => {
        const char = state[side];
        const stats = getCharStats(side);
        
        // ìš´ê¸°
        const ungiBar = document.getElementById(`${side}-ungi-bar`);
        const ungiValue = document.getElementById(`${side}-ungi-value`);
        const ungiStatus = document.getElementById(`${side}-ungi-status`);
        
        ungiBar.style.width = `${Math.min(100, char.ungi)}%`;
        ungiValue.textContent = `${char.ungi.toFixed(1)}%`;
        
        if (char.ungi >= 80) {
          ungiBar.classList.add('ready');
          ungiValue.className = 'ungi-value ready';
          ungiStatus.className = 'ungi-status ready';
          ungiStatus.textContent = 'âš”ï¸ ê³µê²© ê°€ëŠ¥!';
        } else {
          ungiBar.classList.remove('ready');
          ungiValue.className = 'ungi-value charging';
          ungiStatus.className = 'ungi-status charging';
          ungiStatus.textContent = `ì¶©ì „ ì¤‘... ${(80 - char.ungi).toFixed(1)}%`;
        }
        
        // ìŠ¤íƒ¯
        document.getElementById(`${side}-hp`).textContent = char.hp.toFixed(1);
        document.getElementById(`${side}-ng`).textContent = char.neigong.toFixed(1);
        document.getElementById(`${side}-hp-bar`).style.width = `${Math.max(0, char.hp)}%`;
        document.getElementById(`${side}-ng-bar`).style.width = `${Math.max(0, char.neigong)}%`;
        
        // ë¬¼ì•½
        const hpPotEl = document.getElementById(`${side}-hp-pot`);
        const ngPotEl = document.getElementById(`${side}-ng-pot`);
        hpPotEl.textContent = char.hpPotions;
        ngPotEl.textContent = char.ngPotions;
        hpPotEl.className = char.hpPotions === 0 ? 'potion-count empty' : 'potion-count';
        ngPotEl.className = char.ngPotions === 0 ? 'potion-count empty' : 'potion-count';
        
        // ì •ë³´
        document.getElementById(`${side}-atkspd`).textContent = `${stats.atkTime.toFixed(2)}s`;
        document.getElementById(`${side}-movspd`).textContent = char.bobeop > 0 ? `âˆš${char.bobeop}` : '-';
        document.getElementById(`${side}-power`).textContent = stats.power.toFixed(2);
        document.getElementById(`${side}-mugong-bonus`).textContent = `+${((stats.mugongBonus + stats.balchulBonus) * 100).toFixed(0)}%`;
        
        // ë™ì‘
        const actionEl = document.getElementById(`${side}-action`);
        actionEl.textContent = char.currentAction;
        if (char.currentAction.includes('ë¬¼ì•½')) actionEl.className = 'action-text potion';
        else if (char.currentAction.includes('ê²€') || char.currentAction.includes('ë°œì¶œ')) actionEl.className = 'action-text attack';
        else if (char.currentAction.includes('ë°©ì–´') || char.currentAction.includes('íšŒí”¼')) actionEl.className = 'action-text defend';
        else actionEl.className = 'action-text move';
      });
      
      document.getElementById('battle-time').textContent = state.time.toFixed(1);
      document.getElementById('attack-count').textContent = state.attackCount;
      document.getElementById('combo-count').textContent = state.comboCount;
      document.getElementById('potion-used').textContent = state.totalPotionsUsed;
      
      const slowmoEl = document.getElementById('slowmo-status');
      if (state.comboCount >= 4) { slowmoEl.textContent = '4ì—°íƒ€! +15%'; slowmoEl.style.color = '#ffd700'; }
      else if (state.comboCount >= 3) { slowmoEl.textContent = '3ì—°íƒ€! +10%'; slowmoEl.style.color = '#f39c12'; }
      else if (state.comboCount >= 2) { slowmoEl.textContent = '2ì—°íƒ€! +5%'; slowmoEl.style.color = '#e67e22'; }
      else { slowmoEl.textContent = 'ëŒ€ê¸°'; slowmoEl.style.color = '#888'; }
    }
    
    function updateChar(side) {
      const char = state[side];
      char.gyeongji = document.getElementById(`${side}-gyeongji`).value;
      char.simbeop = document.getElementById(`${side}-simbeop`).value;
      char.bobeop = parseInt(document.getElementById(`${side}-bobeop`).value);
      char.mugong = document.getElementById(`${side}-mugong`).value;
      char.mugongLv = parseInt(document.getElementById(`${side}-mugongLv`).value);
      char.balchul = document.getElementById(`${side}-balchul`).value;
      char.balchulLv = parseInt(document.getElementById(`${side}-balchulLv`).value);
      updateUI();
    }
    
    function updatePotion(side, type, value) {
      state[side][type === 'hp' ? 'hpPotions' : 'ngPotions'] = parseInt(value) || 0;
      updateUI();
    }
    
    function showClashEffect() {
      const effect = document.getElementById('clash-effect');
      effect.classList.add('active');
      setTimeout(() => effect.classList.remove('active'), 300);
    }
    
    function setApproaching(approaching) {
      ['ally', 'enemy'].forEach(side => {
        const token = document.getElementById(`${side}-token`);
        approaching ? token.classList.add('approaching') : token.classList.remove('approaching');
      });
    }
    
    // ===== ë¡œê·¸ =====
    function addLog(text, cls = '') {
      const el = document.getElementById('log-content');
      const line = document.createElement('div');
      line.className = `log-line ${cls}`;
      line.textContent = text;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }
    
    function addLogTime(text, cls = '') {
      addLog(`[${state.time.toFixed(2)}s] ${text}`, cls);
    }
    
    // ===== ë¬¼ì•½ =====
    function usePotion(side) {
      const char = state[side];
      const stats = getCharStats(side);
      if (stats.isDead) return false;
      
      const healAmount = parseInt(document.getElementById('potion-heal').value);
      const hpThreshold = parseInt(document.getElementById(`${side}-hp-threshold`).value);
      const ngThreshold = parseInt(document.getElementById(`${side}-ng-threshold`).value);
      const name = side === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      let used = false;
      
      if (char.hp <= hpThreshold && char.hpPotions > 0) {
        const heal = Math.min(healAmount, 100 - char.hp);
        char.hp += heal;
        char.hpPotions--;
        state.totalPotionsUsed++;
        addLogTime(`ğŸ’Š ${name} ì²´ë ¥ ë¬¼ì•½! (+${heal.toFixed(1)}%) [ë‚¨ì€: ${char.hpPotions}]`, 'potion');
        char.currentAction = 'ì²´ë ¥ ë¬¼ì•½ ë³µìš©';
        used = true;
      }
      
      if (char.neigong <= ngThreshold && char.ngPotions > 0) {
        const heal = Math.min(healAmount, 100 - char.neigong);
        char.neigong += heal;
        char.ngPotions--;
        state.totalPotionsUsed++;
        addLogTime(`ğŸ’Š ${name} ë‚´ê³µ ë¬¼ì•½! (+${heal.toFixed(1)}%) [ë‚¨ì€: ${char.ngPotions}]`, 'potion');
        char.currentAction = 'ë‚´ê³µ ë¬¼ì•½ ë³µìš©';
        used = true;
      }
      
      return used;
    }
    
    // ===== ì „íˆ¬ =====
    function processAttack(attacker, defender) {
      const atkStats = getCharStats(attacker);
      const defStats = getCharStats(defender);
      const atkChar = state[attacker];
      const defChar = state[defender];
      
      const atkName = attacker === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      const defName = defender === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      
      state.attackCount++;
      
      // ì½¤ë³´
      if (state.lastAttacker === attacker) state.comboCount++;
      else { state.comboCount = 1; state.lastAttacker = attacker; }
      
      // ë‚´ê³µ ì†Œë¹„ ì²´í¬
      const totalCost = atkStats.mugongCost + atkStats.balchulCost;
      if (atkChar.neigong < totalCost + atkStats.threshold) {
        addLogTime(`${atkName}: ë‚´ê³µ ë¶€ì¡±! ê³µê²© ë¶ˆê°€!`, 'critical');
        atkChar.ungi = 0;
        return;
      }
      atkChar.neigong -= totalCost;
      
      // ë°©í–¥
      const atkDir = generateMoveDirection(true);
      const defDir = generateMoveDirection(false);
      const dirBonus = calcDirectionBonus(atkDir, defDir);
      const comboBonus = COMBO_BONUS[Math.min(4, state.comboCount)] || 0;
      
      // ìš´ê¸°
      const atkUngi = atkChar.ungi;
      const defUngi = defChar.ungi;
      const atkRemain = 100 - atkUngi;
      const defRemain = 100 - defUngi;
      
      addLog(`â”â”â” ì œ ${state.attackCount}í•© â”â”â”`, 'divider');
      
      // ì´ë™
      addLogTime(`${atkName}, ${atkDir}! ë³´ë²•ì„ ë°Ÿìœ¼ë©° ì ‘ê·¼!`, 'move');
      atkChar.currentAction = `${atkDir} ì ‘ê·¼`;
      
      if (RETREAT_DIR.includes(defDir)) addLogTime(`${defName}, ${defDir}ìœ¼ë¡œ ê±°ë¦¬ë¥¼ ë²Œë¦°ë‹¤!`, 'move');
      else addLogTime(`${defName}, ${defDir}ìœ¼ë¡œ ëŒ€ì‘!`, 'move');
      defChar.currentAction = `${defDir} ì´ë™`;
      
      setApproaching(true);
      
      // ë¬´ê³µ/ë°œì¶œ ì„ íƒ
      const usesBalchul = atkChar.balchul !== 'ì—†ìŒ' && Math.random() > 0.5;
      
      setTimeout(() => {
        if (usesBalchul) {
          const desc = randomPick(BALCHUL_DESC[atkChar.balchul] || ['ë°œì¶œ!']);
          addLogTime(`${atkName}ì˜ ${atkChar.balchul}â”€`, 'mugong');
          addLogTime(`  ã€Œ${desc}ã€`, 'attack');
          atkChar.currentAction = atkChar.balchul;
        } else {
          const atkType = randomPick(ATTACK_TYPES[atkChar.mugong] || ['ê³µê²©!']);
          addLogTime(`${atkName}ì˜ ${atkChar.mugong} ${LEVEL_NAME[atkChar.mugongLv]}â”€`, 'mugong');
          addLogTime(`  ã€Œ${atkType}ã€`, 'attack');
          atkChar.currentAction = atkType;
        }
        
        showClashEffect();
        
        setTimeout(() => {
          const defend = randomPick(DEFEND_TYPES);
          if (defUngi >= 60) addLogTime(`${defName}, ${defend}!`, 'defend');
          else addLogTime(`${defName}, ìš´ê¸° ë¶€ì¡±ìœ¼ë¡œ ì œëŒ€ë¡œ ë§‰ì§€ ëª»í•œë‹¤!`, 'damage');
          defChar.currentAction = defend;
          
          calculateDamage(attacker, defender, atkStats, defStats, atkUngi, defUngi, dirBonus, comboBonus, usesBalchul);
          setApproaching(false);
        }, 80);
      }, 80);
    }
    
    function calculateDamage(attacker, defender, atkStats, defStats, atkUngi, defUngi, dirBonus, comboBonus, usesBalchul) {
      const atkChar = state[attacker];
      const defChar = state[defender];
      const atkName = attacker === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      const defName = defender === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      
      const atkRemain = 100 - atkUngi;
      const defRemain = 100 - defUngi;
      
      // ë‚´ìƒ
      if (atkUngi < 100) {
        const atkNaesang = atkRemain * atkStats.danger;
        atkChar.hp -= atkNaesang * 0.1;
        atkChar.neigong -= atkNaesang * 0.9;
        if (atkNaesang > 0.5) addLogTime(`  ${atkName}, ìš´ê¸° ë¯¸ì™„ì„± ë°˜ë™ (-${atkNaesang.toFixed(1)})`, 'naesang');
      }
      
      const defNaesang = defRemain * defStats.danger;
      defChar.hp -= defNaesang * 0.1;
      defChar.neigong -= defNaesang * 0.9;
      if (defNaesang > 0.5) addLogTime(`  ${defName}, ìš´ê¸° ëŠê¹€ ë‚´ìƒ (-${defNaesang.toFixed(1)})`, 'naesang');
      
      // ë³´ì •
      const levelDiff = atkStats.g.level - defStats.g.level;
      let modifier = levelDiff < 0 ? 1 + (levelDiff * 0.03) : 1;
      
      // ì´ ë³´ë„ˆìŠ¤
      const mugongBonus = usesBalchul ? atkStats.balchulBonus : atkStats.mugongBonus;
      const totalBonus = atkStats.bobeopBonus + mugongBonus + dirBonus.bonus + comboBonus;
      
      // í”¼í•´
      const baseDamage = atkStats.power * 10 * modifier;
      const totalDamage = baseDamage * (1 + totalBonus);
      const hpDmg = totalDamage * 0.2;
      const ngDmg = totalDamage * 0.8;
      
      defChar.hp -= hpDmg;
      defChar.neigong -= ngDmg;
      
      // ë³´ë„ˆìŠ¤ ë¡œê·¸
      let bonusDesc = [];
      if (atkStats.bobeopBonus > 0) bonusDesc.push(`ë³´ë²•+${(atkStats.bobeopBonus*100).toFixed(0)}%`);
      if (mugongBonus > 0) bonusDesc.push(`ë¬´ê³µ+${(mugongBonus*100).toFixed(0)}%`);
      if (dirBonus.bonus > 0) bonusDesc.push(`${dirBonus.desc}+${(dirBonus.bonus*100).toFixed(0)}%`);
      if (comboBonus > 0) bonusDesc.push(`${state.comboCount}ì—°íƒ€+${(comboBonus*100).toFixed(0)}%`);
      
      if (bonusDesc.length > 0) addLogTime(`  [${bonusDesc.join(', ')}]`, 'combo');
      addLogTime(`  âš”ï¸ í”¼í•´: ì²´ë ¥-${hpDmg.toFixed(1)}, ë‚´ê³µ-${ngDmg.toFixed(1)}`, 'damage');
      
      // ì •ë¦¬
      atkChar.hp = Math.max(0, atkChar.hp);
      atkChar.neigong = Math.max(0, atkChar.neigong);
      defChar.hp = Math.max(0, defChar.hp);
      defChar.neigong = Math.max(0, defChar.neigong);
      
      atkChar.ungi = 0;
      defChar.ungi = 0;
      atkChar.currentAction = 'ìš´ê¸° ì‹œì‘';
      defChar.currentAction = 'ì²´ì„¸ ì •ë¹„';
      
      // ì „íˆ¬ë¶ˆëŠ¥
      if (getCharStats(defender).isDead) {
        addLogTime(`ğŸ’€ ${defName}, ì „íˆ¬ë¶ˆëŠ¥!`, 'critical');
        state.winner = attacker;
      }
      if (getCharStats(attacker).isDead && !state.winner) {
        addLogTime(`ğŸ’€ ${atkName}, ë‚´ìƒìœ¼ë¡œ ì“°ëŸ¬ì§„ë‹¤!`, 'critical');
        state.winner = defender;
      }
      
      updateUI();
    }
    
    // ===== ê²Œì„ ë£¨í”„ =====
    function gameLoop(timestamp) {
      if (!state.running) return;
      
      const speed = parseFloat(document.getElementById('sim-speed').value);
      if (state.lastTime === 0) state.lastTime = timestamp;
      
      const delta = (timestamp - state.lastTime) / 1000 * speed;
      state.lastTime = timestamp;
      state.time += delta;
      
      // ìš´ê¸° ì¶©ì „
      ['ally', 'enemy'].forEach(side => {
        const stats = getCharStats(side);
        if (!stats.isDead) {
          state[side].ungi += stats.ungiPerSec * delta;
          state[side].ungi = Math.min(100, state[side].ungi);
          if (state[side].ungi < 80) state[side].currentAction = `ìš´ê¸° ${state[side].ungi.toFixed(0)}%`;
        }
      });
      
      // ë¬¼ì•½ ì²´í¬
      usePotion('ally');
      usePotion('enemy');
      
      // ê³µê²© ì²´í¬
      const allyStats = getCharStats('ally');
      const enemyStats = getCharStats('enemy');
      const allyCanAttack = state.ally.ungi >= 80 && !allyStats.isDead;
      const enemyCanAttack = state.enemy.ungi >= 80 && !enemyStats.isDead;
      
      if (allyCanAttack || enemyCanAttack) {
        if (allyCanAttack && enemyCanAttack) {
          if (allyStats.moveSpeed >= enemyStats.moveSpeed) processAttack('ally', 'enemy');
          else processAttack('enemy', 'ally');
        } else if (allyCanAttack) processAttack('ally', 'enemy');
        else processAttack('enemy', 'ally');
      }
      
      updateUI();
      
      if (state.winner) { endBattle(); return; }
      state.animFrame = requestAnimationFrame(gameLoop);
    }
    
    // ===== ì»¨íŠ¸ë¡¤ =====
    function startBattle() {
      if (state.running) return;
      state.running = true;
      state.lastTime = 0;
      
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-stop').style.display = 'inline-block';
      document.querySelectorAll('.config-section select, .config-section input').forEach(el => el.disabled = true);
      document.querySelectorAll('.potion-section select, .potion-section input').forEach(el => el.disabled = true);
      
      if (state.time === 0) {
        document.getElementById('log-content').innerHTML = '';
        addLog('â”â”â” ì „íˆ¬ ê°œì‹œ â”â”â”', 'divider');
        addLogTime('ì–‘ì¸¡ì´ ì„œë¡œë¥¼ ë…¸ë ¤ë³¸ë‹¤...', 'info');
        addLogTime('ìš´ê¸°ë¥¼ ì‹œì‘í•œë‹¤!', 'ready');
      }
      
      state.animFrame = requestAnimationFrame(gameLoop);
    }
    
    function stopBattle() {
      state.running = false;
      state.lastTime = 0;
      if (state.animFrame) cancelAnimationFrame(state.animFrame);
      
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-stop').style.display = 'none';
      addLogTime('ì „íˆ¬ ì¼ì‹œì •ì§€', 'info');
    }
    
    function endBattle() {
      state.running = false;
      if (state.animFrame) cancelAnimationFrame(state.animFrame);
      
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-stop').style.display = 'none';
      
      const winnerName = state.winner === 'ally' ? 'ê²€í˜¸' : 'ë„ì ';
      const resultText = `ğŸ† ${winnerName} ìŠ¹ë¦¬! (${state.time.toFixed(1)}ì´ˆ, ${state.attackCount}í•©, ğŸ’Š${state.totalPotionsUsed})`;
      
      document.getElementById('battle-result').style.display = 'block';
      document.getElementById('result-text').textContent = resultText;
      addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'divider');
      addLog(resultText, 'ready');
    }
    
    function resetBattle() {
      stopBattle();
      
      state.time = 0;
      state.attackCount = 0;
      state.winner = null;
      state.comboCount = 0;
      state.lastAttacker = null;
      state.totalPotionsUsed = 0;
      
      ['ally', 'enemy'].forEach(side => {
        state[side].hp = 100;
        state[side].neigong = 100;
        state[side].ungi = 0;
        state[side].currentAction = 'ëŒ€ê¸° ì¤‘';
        state[side].hpPotions = parseInt(document.getElementById(`${side}-hp-pot-input`).value) || 0;
        state[side].ngPotions = parseInt(document.getElementById(`${side}-ng-pot-input`).value) || 0;
      });
      
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-stop').style.display = 'none';
      document.getElementById('battle-result').style.display = 'none';
      document.querySelectorAll('.config-section select, .config-section input').forEach(el => el.disabled = false);
      document.querySelectorAll('.potion-section select, .potion-section input').forEach(el => el.disabled = false);
      
      setApproaching(false);
      
      document.getElementById('log-content').innerHTML = '<div class="log-line info">ì „íˆ¬ ì‹œì‘ì„ ëˆ„ë¥´ë©´ ì‹¤ì‹œê°„ ìš´ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</div>';
      updateUI();
    }
    
    // ===== ì´ˆê¸°í™” =====
    updateUI();
  </script>
</body>
</html>
