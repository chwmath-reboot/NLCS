<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S-Engine æˆ°é¬ª è©¦æ¼”å™¨ v8.4</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
      color: #e0e0e0;
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      padding: 10px 8px;
      font-size: 12px;
    }
    
    .container { max-width: 1700px; margin: 0 auto; }
    
    header { text-align: center; margin-bottom: 10px; }
    
    h1 {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.5rem;
      background: linear-gradient(135deg, #ffd700 0%, #ff6b35 50%, #ffd700 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle { color: #888; font-size: 0.7rem; }
    
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 380px 1fr;
      gap: 10px;
      align-items: start;
    }
    
    @media (max-width: 1500px) {
      .main-layout { grid-template-columns: 1fr; }
      .team { flex-direction: row !important; flex-wrap: wrap; justify-content: center; }
      .char-card { width: 280px; }
    }
    
    /* íŒ€ ì˜ì—­ */
    .team {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .team-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      border-radius: 6px;
    }
    
    .team-header.ally { background: rgba(231,76,60,0.12); border: 1px solid rgba(231,76,60,0.25); }
    .team-header.enemy { background: rgba(52,152,219,0.12); border: 1px solid rgba(52,152,219,0.25); }
    
    .team-header h2 { font-family: 'Noto Serif KR', serif; font-size: 0.95rem; }
    .team-header.ally h2 { color: #e74c3c; }
    .team-header.enemy h2 { color: #3498db; }
    
    .btn-add {
      padding: 3px 10px;
      font-size: 0.7rem;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 4px;
      color: #aaa;
      cursor: pointer;
    }
    .btn-add:hover { background: rgba(255,255,255,0.15); }
    .btn-add:disabled { opacity: 0.3; cursor: not-allowed; }
    
    /* ìºë¦­í„° ì¹´ë“œ */
    .char-card {
      background: rgba(0,0,0,0.25);
      border-radius: 8px;
      padding: 8px;
      position: relative;
      border: 1px solid rgba(255,255,255,0.08);
    }
    
    .char-card.ally { border-left: 3px solid rgba(231,76,60,0.5); }
    .char-card.enemy { border-left: 3px solid rgba(52,152,219,0.5); }
    .char-card.dead { opacity: 0.35; filter: grayscale(0.7); }
    .char-card.active { box-shadow: 0 0 12px rgba(255,215,0,0.4); }
    
    .btn-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 16px;
      height: 16px;
      padding: 0;
      font-size: 11px;
      line-height: 14px;
      background: rgba(255,0,0,0.15);
      border: 1px solid rgba(255,0,0,0.25);
      border-radius: 50%;
      color: #e74c3c;
      cursor: pointer;
    }
    
    .char-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }
    
    .char-header input {
      flex: 1;
      padding: 3px 6px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 3px;
      color: #fff;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .char-status {
      font-size: 0.6rem;
      padding: 2px 5px;
      border-radius: 3px;
    }
    
    .char-status.alive { background: rgba(46,204,113,0.2); color: #2ecc71; }
    .char-status.dead { background: rgba(231,76,60,0.2); color: #e74c3c; }
    
    /* ì„¤ì • ê·¸ë¦¬ë“œ */
    .config-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-bottom: 5px;
    }
    
    .config-row.three-col { grid-template-columns: repeat(3, 1fr); }
    
    .config-item label {
      display: block;
      font-size: 0.55rem;
      color: #777;
      margin-bottom: 1px;
    }
    
    .config-item select {
      width: 100%;
      padding: 2px 3px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 2px;
      color: #fff;
      font-size: 0.65rem;
    }
    
    /* ìš´ê¸° ê²Œì´ì§€ */
    .ungi-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 5px;
    }
    
    .ungi-label { font-size: 0.65rem; color: #ffd700; min-width: 22px; }
    
    .ungi-bar-wrap {
      flex: 1;
      position: relative;
      height: 12px;
      background: rgba(0,0,0,0.4);
      border-radius: 6px;
      overflow: hidden;
    }
    
    .ungi-bar {
      height: 100%;
      border-radius: 6px;
      transition: width 0.05s linear;
    }
    
    .ungi-bar.ally { background: linear-gradient(90deg, #c0392b, #e74c3c, #f39c12); }
    .ungi-bar.enemy { background: linear-gradient(90deg, #2980b9, #3498db, #1abc9c); }
    .ungi-bar.ready { box-shadow: 0 0 8px rgba(46,204,113,0.7); }
    
    .ungi-threshold {
      position: absolute;
      left: 80%;
      top: 0;
      bottom: 0;
      width: 1px;
      background: #2ecc71;
    }
    
    .ungi-value {
      font-size: 0.65rem;
      font-weight: bold;
      min-width: 32px;
      text-align: right;
    }
    
    .ungi-value.ready { color: #2ecc71; }
    .ungi-value.charging { color: #f39c12; }
    
    /* ìŠ¤íƒ¯ ë°” */
    .stat-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      margin-bottom: 5px;
    }
    
    .stat-item {
      background: rgba(0,0,0,0.2);
      border-radius: 3px;
      padding: 3px 5px;
    }
    
    .stat-item .label {
      display: flex;
      justify-content: space-between;
      font-size: 0.55rem;
      margin-bottom: 2px;
    }
    
    .stat-item .track {
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .stat-item .fill { height: 100%; }
    .stat-item .fill.hp { background: linear-gradient(90deg, #c0392b, #e74c3c); }
    .stat-item .fill.ng { background: linear-gradient(90deg, #2980b9, #3498db); }
    
    /* ë¬¼ì•½ */
    .potion-row {
      display: flex;
      gap: 8px;
      font-size: 0.6rem;
      margin-bottom: 4px;
    }
    
    .potion-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    
    .potion-count {
      padding: 1px 4px;
      background: rgba(46,204,113,0.2);
      border-radius: 2px;
      color: #2ecc71;
      min-width: 14px;
      text-align: center;
    }
    
    .potion-count.empty { background: rgba(231,76,60,0.2); color: #e74c3c; }
    
    .potion-input {
      width: 30px;
      padding: 1px 2px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 2px;
      color: #fff;
      font-size: 0.6rem;
    }
    
    /* í˜„ì¬ ë™ì‘ */
    .action-row {
      padding: 4px;
      background: rgba(155,89,182,0.1);
      border-radius: 3px;
      font-size: 0.6rem;
      text-align: center;
      min-height: 18px;
    }
    
    .action-row.attack { color: #e74c3c; font-weight: bold; }
    .action-row.defend { color: #3498db; }
    .action-row.move { color: #f39c12; }
    .action-row.potion { color: #2ecc71; }
    
    /* ì¤‘ì•™ ì „íˆ¬ ì˜ì—­ */
    .battle-area { display: flex; flex-direction: column; gap: 8px; }
    
    .battle-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .btn {
      padding: 8px 16px;
      font-size: 0.8rem;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover { transform: scale(1.03); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-start { background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; }
    .btn-stop { background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; }
    .btn-reset { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #aaa; }
    
    .options-row {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .settings-section {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 6px;
      padding: 6px 10px;
      margin-bottom: 8px;
    }
    
    .section-label {
      font-size: 0.7rem;
      color: #ffd700;
      font-weight: bold;
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(255,215,0,0.2);
    }
    
    .option-box {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      font-size: 0.65rem;
    }
    
    .option-box label { color: #888; }
    .option-box select {
      padding: 2px 4px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 3px;
      color: #fff;
      font-size: 0.65rem;
    }
    
    /* ì „íˆ¬ ë¡œê·¸ */
    .battle-log-container {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      height: 420px;
    }
    
    .log-header {
      padding: 6px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .log-header h3 {
      color: #ffd700;
      font-family: 'Noto Serif KR', serif;
      font-size: 0.85rem;
    }
    
    .log-stats {
      display: flex;
      gap: 6px;
      font-size: 0.6rem;
    }
    
    .log-stats span { padding: 2px 5px; border-radius: 3px; }
    .log-stats .time { background: rgba(155,89,182,0.2); color: #9b59b6; }
    .log-stats .round { background: rgba(255,215,0,0.2); color: #ffd700; }
    .log-stats .potion { background: rgba(46,204,113,0.2); color: #2ecc71; }
    
    .log-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      font-family: 'D2Coding', monospace;
      font-size: 0.65rem;
      line-height: 1.4;
    }
    
    .log-line { margin-bottom: 1px; color: #bbb; }
    .log-line.move { color: #f39c12; }
    .log-line.stun { color: #e67e22; font-style: italic; }
    .log-line.attack { color: #e74c3c; font-weight: bold; }
    .log-line.defend { color: #3498db; }
    .log-line.damage { color: #ff6b6b; }
    .log-line.naesang { color: #9b59b6; font-style: italic; }
    .log-line.combo { color: #ffd700; }
    .log-line.ready { color: #2ecc71; font-weight: bold; }
    .log-line.info { color: #888; font-style: italic; }
    .log-line.potion { color: #2ecc71; }
    .log-line.critical { color: #e74c3c; font-weight: bold; background: rgba(231,76,60,0.1); padding: 1px 3px; border-radius: 2px; }
    .log-line.divider { color: #555; text-align: center; }
    .log-line.mugong { color: #9b59b6; font-weight: bold; }
    
    .battle-result {
      padding: 8px;
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }
    
    .result-text {
      font-family: 'Noto Serif KR', serif;
      font-size: 1rem;
      color: #ffd700;
    }
    
    footer {
      text-align: center;
      margin-top: 10px;
      color: #555;
      font-size: 0.6rem;
    }
    
    .highlight-red { color: #e74c3c; }
    .highlight-blue { color: #3498db; }
    .highlight-gold { color: #ffd700; }
    .highlight-green { color: #2ecc71; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>S-Engine æˆ°é¬ª è©¦æ¼”å™¨</h1>
      <p class="subtitle">v8.4 - ì„¤ì • íŒ¨ë„ ê°œì„  (ì„¹ì…˜ ë¶„ë¦¬, íšŒë³µëŸ‰ ë¶„ë¦¬, ê°ì†Œìœ¨ ì„¸ë¶„í™”)</p>
    </header>
    
    <div class="main-layout">
      <!-- ì•„êµ° íŒ€ -->
      <div class="team" id="ally-team">
        <div class="team-header ally">
          <h2>âš”ï¸ ì•„êµ°</h2>
          <button class="btn-add" id="ally-add-btn" onclick="addCharacter('ally')">+ ì¶”ê°€</button>
        </div>
        <div id="ally-chars"></div>
      </div>
      
      <!-- ì¤‘ì•™ ì „íˆ¬ ì˜ì—­ -->
      <div class="battle-area">
        <div class="battle-controls">
          <button class="btn btn-start" id="btn-start" onclick="startBattle()">â–¶ï¸ ì „íˆ¬ ì‹œì‘</button>
          <button class="btn btn-stop" id="btn-stop" onclick="stopBattle()" style="display:none;">â¹ï¸ ì¤‘ì§€</button>
          <button class="btn btn-reset" onclick="resetBattle()">â†º ì´ˆê¸°í™”</button>
        </div>
        
        <!-- [ê¸°ë³¸ ì„¤ì •] -->
        <div class="settings-section">
          <div class="section-label">âš™ï¸ ê¸°ë³¸ ì„¤ì •</div>
          <div class="options-row">
            <div class="option-box">
              <label>â±ï¸ ì‹œë®¬ ì†ë„</label>
              <select id="sim-speed">
                <option value="1" selected>1ë°°</option>
                <option value="2">2ë°°</option>
                <option value="3">3ë°°</option>
                <option value="4">4ë°°</option>
                <option value="5">5ë°°</option>
                <option value="6">6ë°°</option>
                <option value="7">7ë°°</option>
                <option value="8">8ë°°</option>
                <option value="9">9ë°°</option>
                <option value="10">10ë°°</option>
              </select>
            </div>
            <div class="option-box">
              <label>âš”ï¸ ì „íˆ¬ë°©ì‹</label>
              <select id="battle-mode">
                <option value="simultaneous">ë™ì‹œì „íˆ¬</option>
                <option value="sequential">ìˆœì°¨ì „íˆ¬</option>
              </select>
            </div>
            <div class="option-box">
              <label>ğŸ¯ íƒ€ê²Ÿ ìš°ì„ </label>
              <select id="targeting-mode">
                <option value="weakest">ì•½í•œì </option>
                <option value="strongest">ê°•í•œì </option>
                <option value="random">ë¬´ì‘ìœ„</option>
              </select>
            </div>
            <div class="option-box">
              <label>âš”ï¸ ë¬´ê³µëŒ€ì‘</label>
              <select id="mugong-response">
                <option value="max">ìµœê³ </option>
                <option value="match" selected>ëŒ€ì‘</option>
                <option value="save">ì ˆì•½</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- [íšŒë³µì•½ ì„¤ì •] -->
        <div class="settings-section">
          <div class="section-label">ğŸ’Š íšŒë³µì•½ ì„¤ì •</div>
          <div class="options-row">
            <div class="option-box">
              <label>â¤ï¸ ì²´ë ¥íšŒë³µëŸ‰</label>
              <select id="potion-heal-hp">
                <option value="10">10%</option>
                <option value="15" selected>15%</option>
                <option value="20">20%</option>
                <option value="25">25%</option>
                <option value="30">30%</option>
              </select>
            </div>
            <div class="option-box">
              <label>ğŸ’™ ë‚´ê³µíšŒë³µëŸ‰</label>
              <select id="potion-heal-ng">
                <option value="10">10%</option>
                <option value="15" selected>15%</option>
                <option value="20">20%</option>
                <option value="25">25%</option>
                <option value="30">30%</option>
              </select>
            </div>
            <div class="option-box">
              <label>â¤ï¸ ì²´ë ¥ ìë™</label>
              <select id="hp-threshold">
                <option value="60">60%</option>
                <option value="65">65%</option>
                <option value="70">70%</option>
                <option value="75" selected>75%</option>
                <option value="80">80%</option>
              </select>
            </div>
            <div class="option-box">
              <label>ğŸ’™ ë‚´ê³µ ìë™</label>
              <select id="ng-threshold">
                <option value="60">60%</option>
                <option value="65">65%</option>
                <option value="70">70%</option>
                <option value="75" selected>75%</option>
                <option value="80">80%</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- [ì „íˆ¬ ë¶ˆëŠ¥ íŒì • / ëª…ì¤‘ë¥  í•˜ë½] -->
        <div class="settings-section">
          <div class="section-label">ğŸ’€ ì „íˆ¬ ë¶ˆëŠ¥ íŒì • / ëª…ì¤‘ë¥  í•˜ë½</div>
          <div class="options-row">
            <div class="option-box">
              <label>â¤ï¸ ì²´ë ¥ë¶ˆê°€</label>
              <select id="hp-dead-threshold">
                <option value="20">20%</option>
                <option value="25">25%</option>
                <option value="30" selected>30%</option>
                <option value="35">35%</option>
                <option value="40">40%</option>
                <option value="45">45%</option>
                <option value="50">50%</option>
              </select>
            </div>
            <div class="option-box">
              <label>ğŸ’™ ë‚´ê³µë¶ˆê°€</label>
              <select id="ng-dead-threshold">
                <option value="20">20%</option>
                <option value="25">25%</option>
                <option value="30" selected>30%</option>
                <option value="35">35%</option>
                <option value="40">40%</option>
                <option value="45">45%</option>
                <option value="50">50%</option>
              </select>
            </div>
            <div class="option-box">
              <label>ğŸ’™ ë‚´ê³µ ëª…ì¤‘</label>
              <select id="miss-ng-threshold">
                <option value="40">40%</option>
                <option value="50" selected>50%</option>
                <option value="60">60%</option>
              </select>
            </div>
            <div class="option-box">
              <label>â¤ï¸ ì²´ë ¥ ëª…ì¤‘</label>
              <select id="hp-penalty-threshold">
                <option value="70">70%</option>
                <option value="80" selected>80%</option>
                <option value="90">90%</option>
              </select>
            </div>
            <div class="option-box">
              <label>ğŸ“‰ ê°ì†Œìœ¨(ìµœì´ˆ)</label>
              <select id="hp-penalty-init">
                <option value="1">1%</option>
                <option value="2">2%</option>
                <option value="3" selected>3%</option>
                <option value="4">4%</option>
                <option value="5">5%</option>
                <option value="6">6%</option>
                <option value="7">7%</option>
                <option value="8">8%</option>
                <option value="9">9%</option>
                <option value="10">10%</option>
              </select>
            </div>
            <div class="option-box">
              <label>ğŸ“‰ ê°ì†Œìœ¨(1%ë‹¹)</label>
              <select id="hp-penalty-rate">
                <option value="1" selected>1%</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- [ë‚´ê³µ ê²½ì§€ë¡œ ê° ìŠ¤íƒ¯ ì¡°ì ˆ] -->
        <div class="settings-section">
          <div class="section-label">ğŸ“Š ë‚´ê³µ ê²½ì§€ë¡œ ê° ìŠ¤íƒ¯ ì¡°ì ˆ</div>
          <div class="options-row">
            <div class="option-box">
              <label>ğŸ’™ ë‚´ê³µ</label>
              <select id="mult-neigong">
                <option value="50">50ë°°</option>
                <option value="100" selected>100ë°°</option>
                <option value="150">150ë°°</option>
                <option value="200">200ë°°</option>
              </select>
            </div>
            <div class="option-box">
              <label>â¤ï¸ ì²´ë ¥</label>
              <select id="mult-hp">
                <option value="30">30ë°°</option>
                <option value="50" selected>50ë°°</option>
                <option value="70">70ë°°</option>
                <option value="100">100ë°°</option>
              </select>
            </div>
            <div class="option-box">
              <label>âš”ï¸ ë¬´ê³µì†Œëª¨</label>
              <select id="mult-skill">
                <option value="10">10ë°°</option>
                <option value="20">20ë°°</option>
                <option value="30" selected>30ë°°</option>
                <option value="50">50ë°°</option>
              </select>
            </div>
            <div class="option-box">
              <label>ğŸ’¥ í”¼í•´ë¶„ë°°</label>
              <select id="damage-split">
                <option value="10-90">ë‚´ê³µ10/ì²´ë ¥90</option>
                <option value="20-80">ë‚´ê³µ20/ì²´ë ¥80</option>
                <option value="30-70">ë‚´ê³µ30/ì²´ë ¥70</option>
                <option value="40-60">ë‚´ê³µ40/ì²´ë ¥60</option>
                <option value="50-50">ë‚´ê³µ50/ì²´ë ¥50</option>
                <option value="60-40">ë‚´ê³µ60/ì²´ë ¥40</option>
                <option value="70-30">ë‚´ê³µ70/ì²´ë ¥30</option>
                <option value="80-20">ë‚´ê³µ80/ì²´ë ¥20</option>
                <option value="90-10" selected>ë‚´ê³µ90/ì²´ë ¥10</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="battle-log-container">
          <div class="log-header">
            <h3>ğŸ“œ ì „íˆ¬ ê¸°ë¡</h3>
            <div class="log-stats">
              <span class="time">â±ï¸ <span id="battle-time">0.0</span>s</span>
              <span class="round">ğŸ’¥ <span id="attack-count">0</span>í•©</span>
              <span class="potion">ğŸ’Š <span id="potion-used">0</span></span>
            </div>
          </div>
          <div class="log-content" id="log-content">
            <div class="log-line info">ì–‘ íŒ€ì— ìºë¦­í„°ë¥¼ ë°°ì¹˜í•˜ê³  ì „íˆ¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</div>
            <div class="log-line info">ìµœëŒ€ 3 vs 3 ì „íˆ¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
          </div>
          <div class="battle-result" id="battle-result" style="display: none;">
            <div class="result-text" id="result-text"></div>
          </div>
        </div>
      </div>
      
      <!-- ì êµ° íŒ€ -->
      <div class="team" id="enemy-team">
        <div class="team-header enemy">
          <h2>ğŸ›¡ï¸ ì êµ°</h2>
          <button class="btn-add" id="enemy-add-btn" onclick="addCharacter('enemy')">+ ì¶”ê°€</button>
        </div>
        <div id="enemy-chars"></div>
      </div>
    </div>
    
    <footer>
      S-Engine Combat Simulator v6.2 æœ€çµ‚å®Œæˆç‰ˆ by ShadowK | 10ì¼ê°„ì˜ ì—¬ì •, ì™„ì„±!
    </footer>
  </div>
  
  <script>
    // ===== ë°ì´í„° =====
    const GYEONGJI = {
      'ì‚¼ë¥˜': { level: 1, speed: Math.sqrt(1), neigong: 5 },      // 5ë…„
      'ì´ë¥˜': { level: 2, speed: Math.sqrt(2), neigong: 10 },     // 10ë…„
      'ì¼ë¥˜': { level: 3, speed: Math.sqrt(3), neigong: 30 },     // 30ë…„
      'ì ˆì •': { level: 4, speed: Math.sqrt(4), neigong: 60 },     // 60ë…„ (ì¼ê°‘ì)
      'ì´ˆì ˆì •': { level: 5, speed: Math.sqrt(5), neigong: 120 },  // 120ë…„ (ì´ê°‘ì)
      'í™”ê²½': { level: 6, speed: Math.sqrt(6), neigong: 180 },    // 180ë…„ (ì‚¼ê°‘ì)
      'í˜„ê²½': { level: 7, speed: Math.sqrt(7), neigong: 240 },    // 240ë…„ (ì‚¬ê°‘ì)
      'ìƒì‚¬ê²½': { level: 8, speed: Math.sqrt(8), neigong: 300 },  // 300ë…„
      'ìì—°ê²½': { level: 9, speed: Math.sqrt(9), neigong: 360 }   // 360ë…„
    };
    
    const SIMBEOP = {
      'ì‚¼ì¬ì‹¬ë²•': { chukgi: 10, stab: 90, type: 'ì‚¼ì¬', tier: 0 },
      'ê¸°ì´ˆì‹¬ë²•': { chukgi: 20, stab: 80, type: 'ê¸°ì´ˆ', tier: 1 },
      'ê¸°ë³¸ì‹¬ë²•': { chukgi: 30, stab: 70, type: 'ê¸°ë³¸', tier: 2 },
      'ì‹¬í™”ì‹¬ë²•': { chukgi: 40, stab: 70, type: 'ì‹¬í™”', tier: 3 },
      'ë¹„ì „ì‹¬ë²•': { chukgi: 70, stab: 60, type: 'ë¹„ì „', tier: 4 },
      'ëª…ìš´ì‹¬ë²•': { chukgi: 110, stab: 80, type: 'ì‹ ê³µLv1', tier: 5 },
      'ì²œë§ˆì‹¬ê³µ': { chukgi: 130, stab: 70, type: 'ì‹ ê³µLv2', tier: 5 },
      'ë‹¬ë§ˆì‹¬ê³µ': { chukgi: 120, stab: 80, type: 'ì‹ ê³µLv2', tier: 5 }
    };
    
    const THRESHOLD = { 'ì‚¼ì¬': 50, 'ê¸°ì´ˆ': 50, 'ê¸°ë³¸': 45, 'ì‹¬í™”': 40, 'ë¹„ì „': 35, 'ì‹ ê³µLv1': 30, 'ì‹ ê³µLv2': 25 };
    
    const MUGONG = {
      'ê²€ê¸°': { 1: [2,1], 2: [4,1], 3: [6,1], 4: [8,1], 5: [10,1] },
      'ê²€ì‚¬': { 1: [6,2], 2: [9,2], 3: [12,2], 4: [15,2], 5: [18,2] },
      'ê²€ê°•': { 1: [15,3], 2: [19,3], 3: [23,3], 4: [28,3], 5: [33,3] }
    };
    
    const BALCHUL = {
      'ì—†ìŒ': { bonus: 0, cost: 0 },
      'ê²€ê¸°ë°œì¶œ': { bonus: 8, cost: 2 },
      'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': { bonus: 12, cost: 3 },
      'ê²€ê°•ë°œì¶œ': { bonus: 18, cost: 4 },
      'ê²€ê°•ì¦‰ì‹œë°œì¶œ': { bonus: 25, cost: 5 }
    };
    
    // ê²½ì§€ë³„ ìŠµë“ ê°€ëŠ¥ ë¬´ê³µ/ë°œì¶œ ì œí•œ
    const MUGONG_LIMIT = {
      'ì‚¼ë¥˜':   { ê²€ê¸°: 1, ê²€ì‚¬: 0, ê²€ê°•: 0 },
      'ì´ë¥˜':   { ê²€ê¸°: 2, ê²€ì‚¬: 1, ê²€ê°•: 0 },
      'ì¼ë¥˜':   { ê²€ê¸°: 3, ê²€ì‚¬: 2, ê²€ê°•: 0 },
      'ì ˆì •':   { ê²€ê¸°: 4, ê²€ì‚¬: 3, ê²€ê°•: 1 },
      'ì´ˆì ˆì •': { ê²€ê¸°: 5, ê²€ì‚¬: 4, ê²€ê°•: 2 },
      'í™”ê²½':   { ê²€ê¸°: 5, ê²€ì‚¬: 5, ê²€ê°•: 3 },
      'í˜„ê²½':   { ê²€ê¸°: 5, ê²€ì‚¬: 5, ê²€ê°•: 4 },
      'ìƒì‚¬ê²½': { ê²€ê¸°: 5, ê²€ì‚¬: 5, ê²€ê°•: 5 },
      'ìì—°ê²½': { ê²€ê¸°: 5, ê²€ì‚¬: 5, ê²€ê°•: 5 }
    };
    
    const BALCHUL_LIMIT = {
      'ì‚¼ë¥˜':   { 'ì—†ìŒ': true, 'ê²€ê¸°ë°œì¶œ': false, 'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': false, 'ê²€ê°•ë°œì¶œ': false, 'ê²€ê°•ì¦‰ì‹œë°œì¶œ': false },
      'ì´ë¥˜':   { 'ì—†ìŒ': true, 'ê²€ê¸°ë°œì¶œ': false, 'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': false, 'ê²€ê°•ë°œì¶œ': false, 'ê²€ê°•ì¦‰ì‹œë°œì¶œ': false },
      'ì¼ë¥˜':   { 'ì—†ìŒ': true, 'ê²€ê¸°ë°œì¶œ': 1, 'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': false, 'ê²€ê°•ë°œì¶œ': false, 'ê²€ê°•ì¦‰ì‹œë°œì¶œ': false },
      'ì ˆì •':   { 'ì—†ìŒ': true, 'ê²€ê¸°ë°œì¶œ': 2, 'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': 1, 'ê²€ê°•ë°œì¶œ': false, 'ê²€ê°•ì¦‰ì‹œë°œì¶œ': false },
      'ì´ˆì ˆì •': { 'ì—†ìŒ': true, 'ê²€ê¸°ë°œì¶œ': 3, 'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': 3, 'ê²€ê°•ë°œì¶œ': 1, 'ê²€ê°•ì¦‰ì‹œë°œì¶œ': false },
      'í™”ê²½':   { 'ì—†ìŒ': true, 'ê²€ê¸°ë°œì¶œ': 5, 'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': 4, 'ê²€ê°•ë°œì¶œ': 2, 'ê²€ê°•ì¦‰ì‹œë°œì¶œ': 1 },
      'í˜„ê²½':   { 'ì—†ìŒ': true, 'ê²€ê¸°ë°œì¶œ': 5, 'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': 5, 'ê²€ê°•ë°œì¶œ': 3, 'ê²€ê°•ì¦‰ì‹œë°œì¶œ': 2 },
      'ìƒì‚¬ê²½': { 'ì—†ìŒ': true, 'ê²€ê¸°ë°œì¶œ': 5, 'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': 5, 'ê²€ê°•ë°œì¶œ': 4, 'ê²€ê°•ì¦‰ì‹œë°œì¶œ': 4 },
      'ìì—°ê²½': { 'ì—†ìŒ': true, 'ê²€ê¸°ë°œì¶œ': 5, 'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': 5, 'ê²€ê°•ë°œì¶œ': 5, 'ê²€ê°•ì¦‰ì‹œë°œì¶œ': 5 }
    };
    
    // ê²½ì§€ë³„ ì‹¬ë²• ì œí•œ
    const SIMBEOP_LIMIT = {
      'ì‚¼ë¥˜':   ['ì‚¼ì¬ì‹¬ë²•', 'ê¸°ì´ˆì‹¬ë²•'],
      'ì´ë¥˜':   ['ì‚¼ì¬ì‹¬ë²•', 'ê¸°ì´ˆì‹¬ë²•', 'ê¸°ë³¸ì‹¬ë²•'],
      'ì¼ë¥˜':   ['ì‚¼ì¬ì‹¬ë²•', 'ê¸°ì´ˆì‹¬ë²•', 'ê¸°ë³¸ì‹¬ë²•', 'ì‹¬í™”ì‹¬ë²•'],
      'ì ˆì •':   ['ì‚¼ì¬ì‹¬ë²•', 'ê¸°ì´ˆì‹¬ë²•', 'ê¸°ë³¸ì‹¬ë²•', 'ì‹¬í™”ì‹¬ë²•'],
      'ì´ˆì ˆì •': ['ì‚¼ì¬ì‹¬ë²•', 'ê¸°ì´ˆì‹¬ë²•', 'ê¸°ë³¸ì‹¬ë²•', 'ì‹¬í™”ì‹¬ë²•', 'ë¹„ì „ì‹¬ë²•'],
      'í™”ê²½':   ['ì‚¼ì¬ì‹¬ë²•', 'ê¸°ì´ˆì‹¬ë²•', 'ê¸°ë³¸ì‹¬ë²•', 'ì‹¬í™”ì‹¬ë²•', 'ë¹„ì „ì‹¬ë²•', 'ëª…ìš´ì‹¬ë²•', 'ì²œë§ˆì‹¬ê³µ', 'ë‹¬ë§ˆì‹¬ê³µ'],
      'í˜„ê²½':   ['ì‚¼ì¬ì‹¬ë²•', 'ê¸°ì´ˆì‹¬ë²•', 'ê¸°ë³¸ì‹¬ë²•', 'ì‹¬í™”ì‹¬ë²•', 'ë¹„ì „ì‹¬ë²•', 'ëª…ìš´ì‹¬ë²•', 'ì²œë§ˆì‹¬ê³µ', 'ë‹¬ë§ˆì‹¬ê³µ'],
      'ìƒì‚¬ê²½': ['ì‚¼ì¬ì‹¬ë²•', 'ê¸°ì´ˆì‹¬ë²•', 'ê¸°ë³¸ì‹¬ë²•', 'ì‹¬í™”ì‹¬ë²•', 'ë¹„ì „ì‹¬ë²•', 'ëª…ìš´ì‹¬ë²•', 'ì²œë§ˆì‹¬ê³µ', 'ë‹¬ë§ˆì‹¬ê³µ'],
      'ìì—°ê²½': ['ì‚¼ì¬ì‹¬ë²•', 'ê¸°ì´ˆì‹¬ë²•', 'ê¸°ë³¸ì‹¬ë²•', 'ì‹¬í™”ì‹¬ë²•', 'ë¹„ì „ì‹¬ë²•', 'ëª…ìš´ì‹¬ë²•', 'ì²œë§ˆì‹¬ê³µ', 'ë‹¬ë§ˆì‹¬ê³µ']
    };
    
    // ê²½ì§€ë³„ ë³´ë²• ìµœëŒ€ ë ˆë²¨
    const BOBEOP_LIMIT = {
      'ì‚¼ë¥˜': 2, 'ì´ë¥˜': 3, 'ì¼ë¥˜': 4, 'ì ˆì •': 5, 'ì´ˆì ˆì •': 6,
      'í™”ê²½': 7, 'í˜„ê²½': 8, 'ìƒì‚¬ê²½': 9, 'ìì—°ê²½': 10
    };
    
    // ê²½ì§€ë³„ ê¸°ë³¸ ì‹¬ë²• (ìµœê³ ê¸‰)
    const DEFAULT_SIMBEOP = {
      'ì‚¼ë¥˜': 'ê¸°ì´ˆì‹¬ë²•', 'ì´ë¥˜': 'ê¸°ë³¸ì‹¬ë²•', 'ì¼ë¥˜': 'ì‹¬í™”ì‹¬ë²•', 'ì ˆì •': 'ì‹¬í™”ì‹¬ë²•',
      'ì´ˆì ˆì •': 'ë¹„ì „ì‹¬ë²•', 'í™”ê²½': 'ë¹„ì „ì‹¬ë²•', 'í˜„ê²½': 'ëª…ìš´ì‹¬ë²•', 'ìƒì‚¬ê²½': 'ì²œë§ˆì‹¬ê³µ', 'ìì—°ê²½': 'ì²œë§ˆì‹¬ê³µ'
    };
    
    // ë¬´ê³µ/ë°œì¶œ ì„ íƒ ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬
    function getAvailableMugong(gyeongji) {
      const limit = MUGONG_LIMIT[gyeongji];
      const result = [];
      for (const [name, maxLv] of Object.entries(limit)) {
        if (maxLv > 0) result.push({ name, maxLv });
      }
      return result;
    }
    
    function getAvailableBalchul(gyeongji) {
      const limit = BALCHUL_LIMIT[gyeongji];
      const result = [];
      for (const [name, maxLv] of Object.entries(limit)) {
        if (maxLv !== false) result.push({ name, maxLv: maxLv === true ? 0 : maxLv });
      }
      return result;
    }
    
    // ê²½ì§€ ë³€ê²½ ì‹œ ë¬´ê³µ/ë°œì¶œ/ì‹¬ë²•/ë³´ë²• ìµœê³  ë ˆë²¨ë¡œ ìë™ ì ìš©
    function adjustMugongForGyeongji(char) {
      const mugongLimit = MUGONG_LIMIT[char.gyeongji];
      const balchulLimit = BALCHUL_LIMIT[char.gyeongji];
      
      // ë¬´ê³µ: ìµœê³  ê°€ëŠ¥ ë¬´ê³µ + ìµœê³  ë ˆë²¨ë¡œ ë³€ê²½
      if (mugongLimit['ê²€ê°•'] > 0) { char.mugong = 'ê²€ê°•'; char.mugongLv = mugongLimit['ê²€ê°•']; }
      else if (mugongLimit['ê²€ì‚¬'] > 0) { char.mugong = 'ê²€ì‚¬'; char.mugongLv = mugongLimit['ê²€ì‚¬']; }
      else { char.mugong = 'ê²€ê¸°'; char.mugongLv = mugongLimit['ê²€ê¸°']; }
      
      // ë°œì¶œ: ìµœê³  ê°€ëŠ¥ ë°œì¶œ + ìµœê³  ë ˆë²¨ë¡œ ë³€ê²½
      if (balchulLimit['ê²€ê°•ì¦‰ì‹œë°œì¶œ']) { char.balchul = 'ê²€ê°•ì¦‰ì‹œë°œì¶œ'; char.balchulLv = balchulLimit['ê²€ê°•ì¦‰ì‹œë°œì¶œ']; }
      else if (balchulLimit['ê²€ê°•ë°œì¶œ']) { char.balchul = 'ê²€ê°•ë°œì¶œ'; char.balchulLv = balchulLimit['ê²€ê°•ë°œì¶œ']; }
      else if (balchulLimit['ê²€ê¸°ì¦‰ì‹œë°œì¶œ']) { char.balchul = 'ê²€ê¸°ì¦‰ì‹œë°œì¶œ'; char.balchulLv = balchulLimit['ê²€ê¸°ì¦‰ì‹œë°œì¶œ']; }
      else if (balchulLimit['ê²€ê¸°ë°œì¶œ']) { char.balchul = 'ê²€ê¸°ë°œì¶œ'; char.balchulLv = balchulLimit['ê²€ê¸°ë°œì¶œ']; }
      else { char.balchul = 'ì—†ìŒ'; char.balchulLv = 1; }
      
      // ì‹¬ë²•: ìµœê³  ê°€ëŠ¥ ì‹¬ë²•ìœ¼ë¡œ ë³€ê²½
      char.simbeop = DEFAULT_SIMBEOP[char.gyeongji];
      
      // ë³´ë²•: ìµœê³  ë ˆë²¨ë¡œ ë³€ê²½
      char.bobeop = BOBEOP_LIMIT[char.gyeongji];
    }
    
    const LEVEL_NAME = ['', 'ä¸‹', 'ä¸­', 'ä¸Šä¸‹', 'ä¸Šä¸­', 'ä¸Šä¸Š'];
    const DIRECTIONS = ['ì „ì§„', 'ì „ì¢Œ', 'ì „ìš°', 'ì¢Œ', 'ìš°', 'í›„í‡´', 'í›„ì¢Œ', 'í›„ìš°'];
    const APPROACH_DIR = ['ì „ì§„', 'ì „ì¢Œ', 'ì „ìš°'];
    const RETREAT_DIR = ['í›„í‡´', 'í›„ì¢Œ', 'í›„ìš°'];
    
    const ATTACK_TYPES = {
      ê²€ê¸°: ['ê²€ê¸°ë¥¼ ì‹¤ì€ ì§ì„ ë² ê¸°', 'ê²€ê¸°ë¥¼ ë‘ë¥¸ íš¡ë² ê¸°', 'ê²€ê¸° ì°Œë¥´ê¸°'],
      ê²€ì‚¬: ['ê²€ì‚¬ ì„¬ê´‘ë² ê¸°', 'ê²€ì‚¬ íšŒì „ì°¸', 'ê²€ì‚¬ê²©'],
      ê²€ê°•: ['ê²€ê°• íŒŒì²œê²©', 'ê²€ê°•ì¼ì„¬', 'ë¬´í˜•ê²€ê°•']
    };
    
    const BALCHUL_DESC = {
      'ê²€ê¸°ë°œì¶œ': 'ê²€ê¸°ê°€ í—ˆê³µì„ ê°€ë¥¸ë‹¤!',
      'ê²€ê¸°ì¦‰ì‹œë°œì¶œ': 'ì°°ë‚˜ì˜ ê²€ê¸° ì†ì‚¬!',
      'ê²€ê°•ë°œì¶œ': 'ì¥ëŒ€í•œ ê²€ê°•ì´ ìŸì•„ì§„ë‹¤!',
      'ê²€ê°•ì¦‰ì‹œë°œì¶œ': 'ì¼ìˆœê°„, ê²€ê°•ì´ ì„¸ê³„ë¥¼ ë² ì—ˆë‹¤!'
    };
    
    const DEFEND_TYPES = ['ê²€ìœ¼ë¡œ í˜ë ¤ëƒ„', 'ëª¸ì„ ë¹„í‹€ì–´ íšŒí”¼', 'ë³´ë²•ìœ¼ë¡œ ë¬¼ëŸ¬ë‚¨', 'ê²€ì‹ ìœ¼ë¡œ ë§‰ì•„ëƒ„'];
    const COMBO_BONUS = { 2: 0.05, 3: 0.10, 4: 0.15 };
    
    // ===== ìƒíƒœ =====
    let state = {
      running: false,
      time: 0,
      attackCount: 0,
      winner: null,
      animFrame: null,
      lastTime: 0,
      totalPotionsUsed: 0,
      hpPotionsUsed: 0,
      ngPotionsUsed: 0,
      chars: { ally: [], enemy: [] }
    };
    
    let charIdCounter = 0;
    
    // ===== ìºë¦­í„° ìƒì„± =====
    function createCharacter(team, preset = {}) {
      const id = ++charIdCounter;
      const isAlly = team === 'ally';
      const gyeongji = preset.gyeongji || (isAlly ? 'ì ˆì •' : 'ì¼ë¥˜');
      
      // ê²½ì§€ì— ë§ëŠ” ìµœê³  ë¬´ê³µ/ë ˆë²¨ ê²°ì •
      const mugongLimit = MUGONG_LIMIT[gyeongji];
      let defaultMugong = 'ê²€ê¸°';
      let defaultMugongLv = mugongLimit['ê²€ê¸°'];
      if (mugongLimit['ê²€ê°•'] > 0) { defaultMugong = 'ê²€ê°•'; defaultMugongLv = mugongLimit['ê²€ê°•']; }
      else if (mugongLimit['ê²€ì‚¬'] > 0) { defaultMugong = 'ê²€ì‚¬'; defaultMugongLv = mugongLimit['ê²€ì‚¬']; }
      
      // ê²½ì§€ì— ë§ëŠ” ìµœê³  ë°œì¶œ/ë ˆë²¨ ê²°ì •
      const balchulLimit = BALCHUL_LIMIT[gyeongji];
      let defaultBalchul = 'ì—†ìŒ';
      let defaultBalchulLv = 0;
      if (balchulLimit['ê²€ê°•ì¦‰ì‹œë°œì¶œ']) { defaultBalchul = 'ê²€ê°•ì¦‰ì‹œë°œì¶œ'; defaultBalchulLv = balchulLimit['ê²€ê°•ì¦‰ì‹œë°œì¶œ']; }
      else if (balchulLimit['ê²€ê°•ë°œì¶œ']) { defaultBalchul = 'ê²€ê°•ë°œì¶œ'; defaultBalchulLv = balchulLimit['ê²€ê°•ë°œì¶œ']; }
      else if (balchulLimit['ê²€ê¸°ì¦‰ì‹œë°œì¶œ']) { defaultBalchul = 'ê²€ê¸°ì¦‰ì‹œë°œì¶œ'; defaultBalchulLv = balchulLimit['ê²€ê¸°ì¦‰ì‹œë°œì¶œ']; }
      else if (balchulLimit['ê²€ê¸°ë°œì¶œ']) { defaultBalchul = 'ê²€ê¸°ë°œì¶œ'; defaultBalchulLv = balchulLimit['ê²€ê¸°ë°œì¶œ']; }
      
      // ê²½ì§€ì— ë§ëŠ” ìµœê³  ì‹¬ë²•
      const defaultSimbeop = DEFAULT_SIMBEOP[gyeongji];
      
      // ê²½ì§€ì— ë§ëŠ” ìµœê³  ë³´ë²•
      const defaultBobeop = BOBEOP_LIMIT[gyeongji];
      
      return {
        id, team,
        name: preset.name || (isAlly ? `ì•„êµ°${id}` : `ì êµ°${id}`),
        gyeongji: gyeongji,
        simbeop: preset.simbeop || defaultSimbeop,
        bobeop: preset.bobeop ?? defaultBobeop,
        mugong: preset.mugong || defaultMugong,
        mugongLv: preset.mugongLv || defaultMugongLv,
        balchul: preset.balchul || defaultBalchul,
        balchulLv: preset.balchulLv || defaultBalchulLv || 1,
        hp: 100, neigong: 100, ungi: 0,
        cooldown: 0,  // ì´ê²©/ê²½ì§ ì¿¨ë‹¤ìš´
        hpPotions: preset.hpPotions ?? (isAlly ? 5 : 3),
        ngPotions: preset.ngPotions ?? (isAlly ? 5 : 3),
        hpThreshold: 50, ngThreshold: 60,
        currentAction: 'ëŒ€ê¸° ì¤‘',
        comboCount: 0, lastTarget: null
      };
    }
    
    function addCharacter(team) {
      if (state.chars[team].length >= 5 || state.running) return;
      state.chars[team].push(createCharacter(team));
      renderTeam(team);
      updateAddButtons();
    }
    
    function removeCharacter(team, id) {
      if (state.running) return;
      state.chars[team] = state.chars[team].filter(c => c.id !== id);
      renderTeam(team);
      updateAddButtons();
    }
    
    function updateAddButtons() {
      ['ally', 'enemy'].forEach(team => {
        const btn = document.getElementById(`${team}-add-btn`);
        btn.disabled = state.chars[team].length >= 5 || state.running;
      });
    }
    
    // ===== ê³„ì‚° =====
    function calcChar(char) {
      const g = GYEONGJI[char.gyeongji];
      const s = SIMBEOP[char.simbeop];
      const m = MUGONG[char.mugong]?.[char.mugongLv] || [0, 0];
      const b = BALCHUL[char.balchul] || { bonus: 0, cost: 0 };
      
      const atkTime = 3 / g.speed;
      const ungiPath = Math.sqrt(s.chukgi);
      const danger = 1 / Math.sqrt(s.stab);
      
      // ìš´ê¸° ì¶©ì „ ì†ë„: ê³µì†(atkTime)ì´ˆ ë™ì•ˆ 100 ìš´ê¸° ì¶©ì „
      // ì‹¬ë²• ê³µì† íŒ¨ë„í‹° ì ìš©
      const speedPenalty = char.speedPenalty || 0;
      const ungiPerSec = (100 / atkTime) * (1 + speedPenalty);
      
      // íŒŒê´´ë ¥ = âˆšë‚´ê³µë…„ìˆ˜ Ã— âˆšì¶•ê¸°ì†ë„ Ã— ìš´ê¸°ìœ¨
      const power = Math.sqrt(g.neigong) * ungiPath * (char.ungi / 100);
      
      const bobeopBonus = char.bobeop * 0.1;
      const moveSpeed = char.bobeop > 0 ? Math.sqrt(char.bobeop) : 1;
      const mugongBonus = m[0] / 100;
      const mugongCost = m[1];
      const balchulBonus = (b.bonus * char.balchulLv / 5) / 100;
      const balchulCost = b.cost;
      
      const threshold = THRESHOLD[s.type];
      const hpDeadThreshold = parseInt(document.getElementById('hp-dead-threshold')?.value || 30);
      const isDead = char.neigong <= threshold || char.hp <= hpDeadThreshold;
      
      return {
        g, s, atkTime, ungiPath, danger, ungiPerSec, power,
        bobeopBonus, moveSpeed, mugongBonus, mugongCost, balchulBonus, balchulCost,
        threshold, isDead
      };
    }
    
    function randomPick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    
    // ===== ë°°ìœ¨ ì„¤ì • =====
    function getMultipliers() {
      return {
        neigong: parseInt(document.getElementById('mult-neigong').value),
        hp: parseInt(document.getElementById('mult-hp').value),
        skill: parseInt(document.getElementById('mult-skill').value)
      };
    }
    
    function getDamageSplit() {
      const split = document.getElementById('damage-split').value.split('-');
      return {
        ng: parseInt(split[0]) / 100,  // ë‚´ê³µ ë¹„ìœ¨
        hp: parseInt(split[1]) / 100   // ì²´ë ¥ ë¹„ìœ¨
      };
    }
    
    // ===== ë¬´ê³µ ëŒ€ì‘ =====
    function selectMugong(attacker, defender) {
      const mode = document.getElementById('mugong-response').value;
      const atkGyeongji = GYEONGJI[attacker.gyeongji].level;
      const defGyeongji = GYEONGJI[defender.gyeongji].level;
      
      // ê¸°ë³¸ê°’: ì„¤ì •ëœ ìµœê³  ë¬´ê³µ
      let mugong = attacker.mugong;
      let mugongLv = attacker.mugongLv;
      let balchul = attacker.balchul;
      let balchulLv = attacker.balchulLv;
      
      if (mode === 'max') {
        // ìµœê³ : í•­ìƒ ì„¤ì •ëœ ìµœê³  ë¬´ê³µ
        // ê¸°ë³¸ê°’ ê·¸ëŒ€ë¡œ
      } else if (mode === 'match') {
        // ëŒ€ì‘: ìƒëŒ€ ê²½ì§€/ë¬´ê³µì— ë§ì¶¤
        const levelDiff = atkGyeongji - defGyeongji;
        
        if (levelDiff >= 3) {
          // 3ë‹¨ê³„ ì´ìƒ ì°¨ì´ â†’ ìµœí•˜ ë¬´ê³µ
          mugongLv = 1;
          balchul = 'ì—†ìŒ';
        } else if (levelDiff >= 2) {
          // 2ë‹¨ê³„ ì°¨ì´ â†’ ë‚®ì€ ë¬´ê³µ
          mugongLv = Math.min(2, attacker.mugongLv);
          balchul = 'ì—†ìŒ';
        } else if (levelDiff >= 1) {
          // 1ë‹¨ê³„ ì°¨ì´ â†’ ì¤‘ê°„ ë¬´ê³µ
          mugongLv = Math.min(3, attacker.mugongLv);
          balchul = 'ì—†ìŒ';
        } else {
          // ë™ê¸‰ ì´í•˜ â†’ ìƒëŒ€ ë¬´ê³µ+1 or ë°œì¶œ ì‚¬ìš©
          mugongLv = Math.min(attacker.mugongLv, defender.mugongLv + 1);
          // ìƒëŒ€ê°€ ë°œì¶œ ê°€ëŠ¥í•˜ë©´ ë‚˜ë„ ë°œì¶œ
          if (defender.balchul !== 'ì—†ìŒ') {
            balchul = attacker.balchul;
          } else {
            balchul = Math.random() > 0.7 ? attacker.balchul : 'ì—†ìŒ';
          }
        }
      } else if (mode === 'save') {
        // ì ˆì•½: ìµœì†Œ ë¬´ê³µ
        mugongLv = 1;
        balchul = 'ì—†ìŒ';
      }
      
      // ë¬´ê³µ ë°ì´í„° ê³„ì‚°
      const m = MUGONG[mugong]?.[mugongLv] || [0, 0];
      const b = BALCHUL[balchul] || { bonus: 0, cost: 0 };
      
      return {
        mugong, mugongLv, balchul, balchulLv,
        mugongBonus: m[0] / 100,
        mugongCost: m[1],
        balchulBonus: (b.bonus * balchulLv / 5) / 100,
        balchulCost: b.cost
      };
    }
    
    // ===== ë Œë”ë§ =====
    function renderTeam(team) {
      const container = document.getElementById(`${team}-chars`);
      const inBattle = state.running;
      
      container.innerHTML = state.chars[team].map(char => {
        const c = calcChar(char);
        const statusClass = c.isDead ? 'dead' : 'alive';
        const statusText = c.isDead ? 'ì „íˆ¬ë¶ˆëŠ¥' : 'ìƒì¡´';
        const cardClass = c.isDead ? 'dead' : '';
        const ungiClass = char.ungi >= 80 ? 'ready' : 'charging';
        
        return `
          <div class="char-card ${team} ${cardClass}" data-id="${char.id}">
            ${!inBattle ? `<button class="btn-remove" onclick="removeCharacter('${team}', ${char.id})">Ã—</button>` : ''}
            
            <div class="char-header">
              <input type="text" value="${char.name}" onchange="updateCharField('${team}', ${char.id}, 'name', this.value)" ${inBattle ? 'disabled' : ''}>
              <span class="char-status ${statusClass}">${statusText}</span>
            </div>
            
            <div class="config-row">
              <div class="config-item">
                <label>ê²½ì§€</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'gyeongji', this.value)" ${inBattle ? 'disabled' : ''}>
                  ${Object.keys(GYEONGJI).map(g => `<option value="${g}" ${char.gyeongji === g ? 'selected' : ''}>${g}</option>`).join('')}
                </select>
              </div>
              <div class="config-item">
                <label>ì‹¬ë²•</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'simbeop', this.value)" ${inBattle ? 'disabled' : ''}>
                  ${SIMBEOP_LIMIT[char.gyeongji].map(s => `<option value="${s}" ${char.simbeop === s ? 'selected' : ''}>${s.replace('ì‹¬ë²•','').replace('ì‹¬ê³µ','')}</option>`).join('')}
                </select>
              </div>
              <div class="config-item">
                <label>ë³´ë²•</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'bobeop', +this.value)" ${inBattle ? 'disabled' : ''}>
                  ${Array.from({length: BOBEOP_LIMIT[char.gyeongji] + 1}, (_, b) => `<option value="${b}" ${char.bobeop === b ? 'selected' : ''}>${b===0?'ì—†ìŒ':'Lv'+b}</option>`).join('')}
                </select>
              </div>
              <div class="config-item">
                <label>ë¬´ê³µ</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'mugong', this.value)" ${inBattle ? 'disabled' : ''}>
                  ${(() => {
                    const limit = MUGONG_LIMIT[char.gyeongji];
                    return Object.keys(MUGONG).filter(m => limit[m] > 0).map(m => 
                      `<option value="${m}" ${char.mugong === m ? 'selected' : ''}>${m}</option>`
                    ).join('');
                  })()}
                </select>
              </div>
            </div>
            
            <div class="config-row">
              <div class="config-item">
                <label>ë¬´ê³µìˆ™ë ¨</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'mugongLv', +this.value)" ${inBattle ? 'disabled' : ''}>
                  ${(() => {
                    const maxLv = MUGONG_LIMIT[char.gyeongji][char.mugong];
                    return [1,2,3,4,5].filter(l => l <= maxLv).map(l => 
                      `<option value="${l}" ${char.mugongLv === l ? 'selected' : ''}>${LEVEL_NAME[l]}</option>`
                    ).join('');
                  })()}
                </select>
              </div>
              <div class="config-item">
                <label>ë°œì¶œê¸°</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'balchul', this.value)" ${inBattle ? 'disabled' : ''}>
                  ${(() => {
                    const limit = BALCHUL_LIMIT[char.gyeongji];
                    return Object.keys(BALCHUL).filter(b => limit[b] !== false).map(b => 
                      `<option value="${b}" ${char.balchul === b ? 'selected' : ''}>${b}</option>`
                    ).join('');
                  })()}
                </select>
              </div>
              <div class="config-item">
                <label>ë°œì¶œìˆ™ë ¨</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'balchulLv', +this.value)" ${inBattle ? 'disabled' : ''}>
                  ${(() => {
                    const limit = BALCHUL_LIMIT[char.gyeongji];
                    const maxLv = limit[char.balchul];
                    if (maxLv === true || maxLv === 0 || char.balchul === 'ì—†ìŒ') {
                      return '<option value="1">-</option>';
                    }
                    return [1,2,3,4,5].filter(l => l <= maxLv).map(l => 
                      `<option value="${l}" ${char.balchulLv === l ? 'selected' : ''}>${LEVEL_NAME[l]}</option>`
                    ).join('');
                  })()}
                </select>
              </div>
              <div class="config-item">
                <label>íŒŒê´´ë ¥</label>
                <div style="font-size:0.7rem;color:#ffd700;padding-top:2px;">${c.power.toFixed(1)}</div>
              </div>
            </div>
            
            <div class="ungi-row">
              <span class="ungi-label">ğŸŒ€</span>
              <div class="ungi-bar-wrap">
                <div class="ungi-threshold"></div>
                <div class="ungi-bar ${team} ${ungiClass}" style="width: ${Math.min(100, char.ungi)}%"></div>
              </div>
              <span class="ungi-value ${ungiClass}">${char.ungi.toFixed(0)}%</span>
            </div>
            
            <div class="stat-row">
              <div class="stat-item">
                <div class="label"><span>HP</span><span class="highlight-red">${char.hp.toFixed(1)}</span></div>
                <div class="track"><div class="fill hp" style="width:${Math.max(0,char.hp)}%"></div></div>
              </div>
              <div class="stat-item">
                <div class="label"><span>ë‚´ê³µ</span><span class="highlight-blue">${char.neigong.toFixed(1)}</span></div>
                <div class="track"><div class="fill ng" style="width:${Math.max(0,char.neigong)}%"></div></div>
              </div>
            </div>
            
            <div class="potion-row">
              <div class="potion-item">
                â¤ï¸<span class="potion-count ${char.hpPotions===0?'empty':''}">${char.hpPotions}</span>
                ${!inBattle ? `<input type="number" class="potion-input" value="${char.hpPotions}" min="0" max="99" onchange="updateCharField('${team}', ${char.id}, 'hpPotions', +this.value)">` : ''}
              </div>
              <div class="potion-item">
                ğŸ’™<span class="potion-count ${char.ngPotions===0?'empty':''}">${char.ngPotions}</span>
                ${!inBattle ? `<input type="number" class="potion-input" value="${char.ngPotions}" min="0" max="99" onchange="updateCharField('${team}', ${char.id}, 'ngPotions', +this.value)">` : ''}
              </div>
            </div>
            
            <div class="action-row ${getActionClass(char.currentAction)}">${char.currentAction}</div>
          </div>
        `;
      }).join('');
    }
    
    function getActionClass(action) {
      if (action.includes('ë¬¼ì•½')) return 'potion';
      if (action.includes('ê²€') || action.includes('ë°œì¶œ') || action.includes('ë² ê¸°')) return 'attack';
      if (action.includes('ë°©ì–´') || action.includes('íšŒí”¼') || action.includes('ë§‰')) return 'defend';
      return 'move';
    }
    
    function updateCharField(team, id, field, value) {
      const char = state.chars[team].find(c => c.id === id);
      if (char) {
        char[field] = value;
        
        // ê²½ì§€ ë³€ê²½ ì‹œ ë¬´ê³µ/ë°œì¶œ ìë™ ì¡°ì •
        if (field === 'gyeongji') {
          adjustMugongForGyeongji(char);
        }
        // ë¬´ê³µ ë³€ê²½ ì‹œ ë ˆë²¨ ì¡°ì •
        if (field === 'mugong') {
          const maxLv = MUGONG_LIMIT[char.gyeongji][char.mugong];
          if (char.mugongLv > maxLv) char.mugongLv = maxLv;
          if (char.mugongLv < 1) char.mugongLv = 1;
        }
        // ë°œì¶œ ë³€ê²½ ì‹œ ë ˆë²¨ ì¡°ì •
        if (field === 'balchul') {
          const limit = BALCHUL_LIMIT[char.gyeongji];
          if (limit[char.balchul] !== true && limit[char.balchul] > 0) {
            if (char.balchulLv > limit[char.balchul]) char.balchulLv = limit[char.balchul];
            if (char.balchulLv < 1) char.balchulLv = 1;
          }
        }
        
        renderTeam(team);
      }
    }
    
    function renderAll() {
      renderTeam('ally');
      renderTeam('enemy');
      document.getElementById('battle-time').textContent = state.time.toFixed(1);
      document.getElementById('attack-count').textContent = state.attackCount;
      document.getElementById('potion-used').textContent = state.totalPotionsUsed;
    }
    
    // ===== ë¡œê·¸ =====
    function addLog(text, cls = '') {
      const el = document.getElementById('log-content');
      const line = document.createElement('div');
      line.className = `log-line ${cls}`;
      line.textContent = text;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }
    
    function addLogTime(text, cls = '') {
      addLog(`[${state.time.toFixed(2)}s] ${text}`, cls);
    }
    
    // ===== íƒ€ê²ŸíŒ… =====
    function getAliveChars(team) {
      return state.chars[team].filter(c => !calcChar(c).isDead);
    }
    
    // ìˆœì°¨ ì „íˆ¬ ì‹œ ì „íˆ¬ ì°¸ì—¬ ê°€ëŠ¥í•œ ì  (ì²« ë²ˆì§¸ ì‚´ì•„ìˆëŠ” ì ë§Œ)
    function getActiveEnemies(team) {
      const battleMode = document.getElementById('battle-mode').value;
      const alive = getAliveChars(team);
      
      if (battleMode === 'sequential' && alive.length > 0) {
        return [alive[0]];  // ì²« ë²ˆì§¸ ì ë§Œ
      }
      return alive;  // ë™ì‹œ ì „íˆ¬: ì „ì²´
    }
    
    function selectTarget(attacker, enemies) {
      const battleMode = document.getElementById('battle-mode').value;
      let alive = enemies.filter(e => !calcChar(e).isDead);
      
      // ìˆœì°¨ ì „íˆ¬: ì²« ë²ˆì§¸ ì‚´ì•„ìˆëŠ” ì ë§Œ íƒ€ê²Ÿ ê°€ëŠ¥
      if (battleMode === 'sequential' && alive.length > 0) {
        return alive[0];
      }
      
      if (alive.length === 0) return null;
      
      const mode = document.getElementById('targeting-mode').value;
      if (mode === 'weakest') return alive.reduce((a, b) => a.neigong < b.neigong ? a : b);
      if (mode === 'strongest') return alive.reduce((a, b) => calcChar(a).power > calcChar(b).power ? a : b);
      return randomPick(alive);
    }
    
    // ===== ë¬¼ì•½ =====
    function usePotion(char) {
      const c = calcChar(char);
      if (c.isDead) return;
      
      const healAmountHp = parseInt(document.getElementById('potion-heal-hp').value);
      const healAmountNg = parseInt(document.getElementById('potion-heal-ng').value);
      const hpThreshold = parseInt(document.getElementById('hp-threshold').value);
      const ngThreshold = parseInt(document.getElementById('ng-threshold').value);
      
      if (char.hp <= hpThreshold && char.hpPotions > 0) {
        const heal = Math.min(healAmountHp, 100 - char.hp);
        char.hp += heal;
        char.hpPotions--;
        state.totalPotionsUsed++;
        state.hpPotionsUsed++;
        addLogTime(`ğŸ’Š ${char.name} ì²´ë ¥ ë¬¼ì•½! (+${heal.toFixed(1)}%)`, 'potion');
        char.currentAction = 'ì²´ë ¥ ë¬¼ì•½';
      }
      
      if (char.neigong <= ngThreshold && char.ngPotions > 0) {
        const heal = Math.min(healAmountNg, 100 - char.neigong);
        char.neigong += heal;
        char.ngPotions--;
        state.totalPotionsUsed++;
        state.ngPotionsUsed++;
        addLogTime(`ğŸ’Š ${char.name} ë‚´ê³µ ë¬¼ì•½! (+${heal.toFixed(1)}%)`, 'potion');
        char.currentAction = 'ë‚´ê³µ ë¬¼ì•½';
      }
    }
    
    // ===== ì „íˆ¬ =====
    function processAttack(attacker, defender) {
      const atkCalc = calcChar(attacker);
      const defCalc = calcChar(defender);
      
      if (atkCalc.isDead || defCalc.isDead) return;
      
      state.attackCount++;
      
      // ì½¤ë³´
      if (attacker.lastTarget === defender.id) attacker.comboCount++;
      else { attacker.comboCount = 1; attacker.lastTarget = defender.id; }
      
      // ë¬´ê³µ ëŒ€ì‘ ì„ íƒ
      const selectedMugong = selectMugong(attacker, defender);
      
      // ë‚´ê³µ ì†Œë¹„ (ë‚´ê³µì´ëŸ‰ = ë‚´ê³µë…„ìˆ˜ Ã— ë°°ìœ¨)
      const costMult = getMultipliers();
      const neigongTotal = atkCalc.g.neigong * costMult.neigong;  // ë‚´ê³µì´ëŸ‰
      const mugongCost = selectedMugong.mugongCost + selectedMugong.balchulCost;
      const costPercent = (mugongCost / neigongTotal) * 100;  // ì†Œë¹„ìœ¨(%)
      
      if (attacker.neigong < costPercent + atkCalc.threshold) {
        addLogTime(`${attacker.name}: ë‚´ê³µ ë¶€ì¡±!`, 'critical');
        attacker.ungi = 0;
        return;
      }
      attacker.neigong -= costPercent;
      
      // ëª…ì¤‘ë¥  íŒ¨ë„í‹°: ë‚´ê³µ ê¸°ì¤€ ì´í•˜ â†’ 5% + (ê¸°ì¤€-ë‚´ê³µ)Ã—5% ë¹—ë‚˜ê° í™•ë¥ 
      const missNgThreshold = parseInt(document.getElementById('miss-ng-threshold')?.value || 50);
      let missChance = 0;
      if (attacker.neigong <= missNgThreshold) {
        missChance = 5 + (missNgThreshold - attacker.neigong) * 5;
      }
      
      // ì²´ë ¥ íŒ¨ë„í‹°: ê¸°ì¤€ ì´í•˜ â†’ íŒŒê´´ë ¥ ê°ì†Œ
      const hpPenaltyThreshold = parseInt(document.getElementById('hp-penalty-threshold')?.value || 80);
      const hpPenaltyInit = parseInt(document.getElementById('hp-penalty-init')?.value || 3) / 100;
      const hpPenaltyPerPercent = parseInt(document.getElementById('hp-penalty-rate')?.value || 1) / 100;
      let hpPenalty = 0;
      if (attacker.hp <= hpPenaltyThreshold) {
        hpPenalty = hpPenaltyInit + (hpPenaltyThreshold - attacker.hp) * hpPenaltyPerPercent;
      }
      
      // ë¹—ë‚˜ê° ì²´í¬
      if (missChance > 0 && Math.random() * 100 < missChance) {
        addLog(`â”â” ${state.attackCount}í•©: ${attacker.name} â†’ ${defender.name} â”â”`, 'divider');
        addLogTime(`${attacker.name}ì˜ ê³µê²©ì´ ë¹—ë‚˜ê°”ë‹¤! (ëª…ì¤‘ë¥  -${missChance.toFixed(0)}%)`, 'naesang');
        
        // ë¹—ë‚˜ê°€ë©´ ê³µê²©ìë§Œ ë‚´ìƒ
        const dmgSplit = getDamageSplit();
        const atkRemain = 100 - attacker.ungi;
        const atkStabReduce = 1 - (atkCalc.s.stab / 500);
        const atkDefBonus = selectedMugong.mugongBonus;
        const atkNaesang = atkRemain * atkCalc.danger * atkStabReduce * (1 - atkDefBonus);
        attacker.hp -= atkNaesang * dmgSplit.hp;
        attacker.neigong -= atkNaesang * dmgSplit.ng;
        if (atkNaesang > 0.5) addLogTime(`  ${attacker.name} ë‚´ìƒ -${atkNaesang.toFixed(1)} (í—›ì†ì§ˆ)`, 'naesang');
        
        attacker.ungi = 0;
        const atkBobeop = attacker.bobeop || 0;
        const retreatTime = Math.max(1, 5 - atkBobeop * 0.4);
        attacker.cooldown = retreatTime;
        attacker.currentAction = 'ì´ê²© ì¤‘';
        return;
      }
      
      // ë°©í–¥
      const atkDir = randomPick(APPROACH_DIR);
      const defDir = randomPick(DIRECTIONS);
      let dirBonus = 0;
      if (atkDir === 'ì „ì§„') dirBonus += 0.10;
      else dirBonus += 0.08;
      if (RETREAT_DIR.includes(defDir)) dirBonus += 0.10;
      
      const comboBonus = COMBO_BONUS[Math.min(4, attacker.comboCount)] || 0;
      const atkUngi = attacker.ungi;
      const defUngi = defender.ungi;
      
      addLog(`â”â” ${state.attackCount}í•©: ${attacker.name} â†’ ${defender.name} â”â”`, 'divider');
      
      // ì´ë™
      addLogTime(`${attacker.name}, ${atkDir}!`, 'move');
      attacker.currentAction = `${atkDir} ì ‘ê·¼`;
      defender.currentAction = `${defDir} ëŒ€ì‘`;
      
      // ë¬´ê³µ (ëŒ€ì‘ ëª¨ë“œ ì ìš©)
      const usesBalchul = selectedMugong.balchul !== 'ì—†ìŒ' && Math.random() > 0.5;
      if (usesBalchul) {
        addLogTime(`${attacker.name}ì˜ ${selectedMugong.balchul}â”€ã€Œ${BALCHUL_DESC[selectedMugong.balchul]}ã€`, 'attack');
        attacker.currentAction = selectedMugong.balchul;
      } else {
        const atkType = randomPick(ATTACK_TYPES[selectedMugong.mugong]);
        addLogTime(`${attacker.name}ì˜ ${selectedMugong.mugong} ${LEVEL_NAME[selectedMugong.mugongLv]}â”€ã€Œ${atkType}ã€`, 'attack');
        attacker.currentAction = atkType;
      }
      
      // ë°©ì–´
      const defend = randomPick(DEFEND_TYPES);
      addLogTime(`${defender.name}, ${defend}!`, 'defend');
      defender.currentAction = defend;
      
      // ë‚´ìƒ (í”¼í•´ ë¶„ë°° + ì•ˆì •ì„±/500 ê°ì†Œ + ë¬´ê³µ ë°©ì–´ë ¥ ê°ì†Œ)
      const dmgSplit = getDamageSplit();
      const atkRemain = 100 - atkUngi;
      const defRemain = 100 - defUngi;
      
      // ì•ˆì •ì„±/500 = ë‚´ìƒí”¼í•´ëŸ‰ ê°ì†Œìœ¨
      const atkStabReduce = 1 - (atkCalc.s.stab / 500);
      const defStabReduce = 1 - (defCalc.s.stab / 500);
      
      // ë¬´ê³µ ë°©ì–´ë ¥ = ë‚´ìƒ ê°ì†Œ (ê³µê²©ìëŠ” ìê¸° ë¬´ê³µ, ë°©ì–´ìë„ ìê¸° ë¬´ê³µ)
      const atkDefBonus = usesBalchul ? selectedMugong.balchulBonus : selectedMugong.mugongBonus;
      const defMugong = MUGONG[defender.mugong]?.[defender.mugongLv] || [0, 0];
      const defDefBonus = defMugong[0] / 100;
      
      if (atkUngi < 100) {
        const atkNaesang = atkRemain * atkCalc.danger * atkStabReduce * (1 - atkDefBonus);
        attacker.hp -= atkNaesang * dmgSplit.hp;
        attacker.neigong -= atkNaesang * dmgSplit.ng;
        if (atkNaesang > 0.5) addLogTime(`  ${attacker.name} ë‚´ìƒ -${atkNaesang.toFixed(1)} (ë°©ì–´${(atkDefBonus*100).toFixed(0)}%)`, 'naesang');
      }
      
      const defNaesang = defRemain * defCalc.danger * defStabReduce * (1 - defDefBonus);
      defender.hp -= defNaesang * dmgSplit.hp;
      defender.neigong -= defNaesang * dmgSplit.ng;
      if (defNaesang > 0.5) addLogTime(`  ${defender.name} ë‚´ìƒ -${defNaesang.toFixed(1)} (ë°©ì–´${(defDefBonus*100).toFixed(0)}%)`, 'naesang');
      
      // í”¼í•´ (ë°°ìœ¨ + í”¼í•´ ë¶„ë°° + ê²½ì§€/ì‹¬ë²• ê²©ì°¨ íŒ¨ë„í‹°)
      const mult = getMultipliers();
      
      // ê²½ì§€ ì°¨ íŒ¨ë„í‹°: í•˜ìœ„ ê²½ì§€ -3%/ë‹¨ê³„
      const levelDiff = atkCalc.g.level - defCalc.g.level;
      let gyeongjiPenalty = levelDiff < 0 ? levelDiff * 0.03 : 0;
      
      // ì‹¬ë²• ê²©ì°¨ íŒ¨ë„í‹°: í•˜ìœ„ ì‹¬ë²• -3%/ë‹¨ê³„
      const simbeopDiff = atkCalc.s.tier - defCalc.s.tier;
      let simbeopPenalty = simbeopDiff < 0 ? simbeopDiff * 0.03 : 0;
      
      // ì²´ë ¥ íŒ¨ë„í‹°: 80% ì´í•˜ íŒŒê´´ë ¥ ê°ì†Œ (ì´ë¯¸ ìœ„ì—ì„œ ê³„ì‚°ë¨)
      let modifier = (1 + gyeongjiPenalty + simbeopPenalty) * (1 - hpPenalty);
      
      const mugongBonus = usesBalchul ? selectedMugong.balchulBonus : selectedMugong.mugongBonus;
      const totalBonus = atkCalc.bobeopBonus + mugongBonus + dirBonus + comboBonus;
      
      // ì´ëŸ‰ = ë‚´ê³µë…„ìˆ˜ Ã— ë°°ìœ¨
      const defNeigongTotal = defCalc.g.neigong * mult.neigong;  // ë‚´ê³µì´ëŸ‰
      const defHpTotal = defCalc.g.neigong * mult.hp;            // ì²´ë ¥ì´ëŸ‰
      
      // ê¸°ë³¸ ë°ë¯¸ì§€ (íŒŒê´´ë ¥ ê¸°ë°˜)
      const baseDamage = atkCalc.power * modifier;
      const totalDamage = baseDamage * (1 + totalBonus);
      
      // ë°©ì–´ì ì´ëŸ‰ ê¸°ì¤€ìœ¼ë¡œ ë¹„ìœ¨ ë³€í™˜
      const ngDmgPercent = (totalDamage / defNeigongTotal) * 100;
      const hpDmgPercent = (totalDamage / defHpTotal) * 100;
      
      defender.hp -= hpDmgPercent * dmgSplit.hp;
      defender.neigong -= ngDmgPercent * dmgSplit.ng;
      
      // ë³´ë„ˆìŠ¤/íŒ¨ë„í‹° í‘œì‹œ
      let bonusDesc = [];
      if (atkCalc.bobeopBonus > 0) bonusDesc.push(`ë³´ë²•+${(atkCalc.bobeopBonus*100).toFixed(0)}%`);
      if (mugongBonus > 0) bonusDesc.push(`ë¬´ê³µ+${(mugongBonus*100).toFixed(0)}%`);
      if (dirBonus > 0) bonusDesc.push(`ì´ë™+${(dirBonus*100).toFixed(0)}%`);
      if (comboBonus > 0) bonusDesc.push(`${attacker.comboCount}ì—°íƒ€+${(comboBonus*100).toFixed(0)}%`);
      if (gyeongjiPenalty < 0) bonusDesc.push(`ê²½ì§€ì°¨${(gyeongjiPenalty*100).toFixed(0)}%`);
      if (simbeopPenalty < 0) bonusDesc.push(`ì‹¬ë²•ì°¨${(simbeopPenalty*100).toFixed(0)}%`);
      if (hpPenalty > 0) bonusDesc.push(`ì²´ë ¥â†“${(hpPenalty*100).toFixed(0)}%`);
      
      if (bonusDesc.length > 0) addLogTime(`  [${bonusDesc.join(', ')}]`, 'combo');
      addLogTime(`  âš”ï¸ HP-${(hpDmgPercent * dmgSplit.hp).toFixed(1)}%, ë‚´ê³µ-${(ngDmgPercent * dmgSplit.ng).toFixed(1)}%`, 'damage');
      
      // ì •ë¦¬
      [attacker, defender].forEach(c => {
        c.hp = Math.max(0, c.hp);
        c.neigong = Math.max(0, c.neigong);
      });
      
      // ê³µê²©ì: ìš´ê¸° 0 + ì´ê²© ì¿¨ë‹¤ìš´ (ë³´ë²• ë†’ìœ¼ë©´ ë¹ ë¥´ê²Œ ë¹ ì§)
      const atkBobeop = attacker.bobeop || 0;
      const retreatTime = Math.max(1, 5 - atkBobeop * 0.4);  // 5ì´ˆ ê¸°ë³¸, ë³´ë²•ë‹¹ 0.4ì´ˆ ê°ì†Œ
      attacker.ungi = 0;
      attacker.cooldown = retreatTime;
      attacker.currentAction = 'ì´ê²© ì¤‘';
      addLogTime(`  â†©ï¸ ${attacker.name} ì´ê²© (${retreatTime.toFixed(1)}ì´ˆ)`, 'move');
      
      // ë°©ì–´ì: ìš´ê¸° ìœ ì§€, ì¦‰ì‹œ ë°˜ê²© ì¤€ë¹„
      
      // ì „íˆ¬ë¶ˆëŠ¥
      if (calcChar(defender).isDead) {
        addLogTime(`ğŸ’€ ${defender.name} ì „íˆ¬ë¶ˆëŠ¥!`, 'critical');
        
        // ìˆœì°¨ ì „íˆ¬: ë‹¤ìŒ ì  ì•Œë¦¼
        const battleMode = document.getElementById('battle-mode').value;
        if (battleMode === 'sequential' && defender.team === 'enemy') {
          const remainingEnemies = getAliveChars('enemy');
          if (remainingEnemies.length > 0) {
            addLogTime(`â¡ï¸ ë‹¤ìŒ ì : ${remainingEnemies[0].name} ë“±ì¥! (ë‚¨ì€ ì : ${remainingEnemies.length})`, 'ready');
          }
        }
      }
      if (calcChar(attacker).isDead) {
        addLogTime(`ğŸ’€ ${attacker.name} ë‚´ìƒìœ¼ë¡œ ì“°ëŸ¬ì¡Œë‹¤!`, 'critical');
      }
    }
    
    // ===== ê²Œì„ ë£¨í”„ =====
    function gameLoop(timestamp) {
      if (!state.running) return;
      
      const speed = parseFloat(document.getElementById('sim-speed').value);
      if (state.lastTime === 0) state.lastTime = timestamp;
      
      const delta = (timestamp - state.lastTime) / 1000 * speed;
      state.lastTime = timestamp;
      state.time += delta;
      
      // ìˆœì°¨ ì „íˆ¬ ëª¨ë“œ: ì êµ° ì¤‘ ì²« ë²ˆì§¸ë§Œ ì „íˆ¬ ì°¸ì—¬
      const battleMode = document.getElementById('battle-mode').value;
      const activeEnemies = battleMode === 'sequential' 
        ? getActiveEnemies('enemy')
        : state.chars.enemy;
      
      // ìš´ê¸° ì¶©ì „ + ì¿¨ë‹¤ìš´ ê°ì†Œ + ë¬¼ì•½
      [...state.chars.ally, ...state.chars.enemy].forEach(char => {
        const c = calcChar(char);
        
        // ìˆœì°¨ ì „íˆ¬: ë¹„í™œì„± ì ì€ ëŒ€ê¸°
        if (battleMode === 'sequential' && char.team === 'enemy') {
          if (!activeEnemies.includes(char)) {
            if (!c.isDead) char.currentAction = 'ëŒ€ê¸° (ìˆœì°¨)';
            return;  // ìš´ê¸° ì¶©ì „ ì•ˆ í•¨
          }
        }
        
        if (!c.isDead) {
          // ì¿¨ë‹¤ìš´ ê°ì†Œ
          if (char.cooldown > 0) {
            char.cooldown = Math.max(0, char.cooldown - delta);
            if (char.cooldown <= 0) {
              char.currentAction = 'ëŒ€ê¸° ì¤‘';
            }
          }
          
          // ì¿¨ë‹¤ìš´ ì—†ì„ ë•Œë§Œ ìš´ê¸° ì¶©ì „
          if (char.cooldown <= 0) {
            char.ungi += c.ungiPerSec * delta;
            char.ungi = Math.min(100, char.ungi);
            if (char.ungi < 80) char.currentAction = `ìš´ê¸° ${char.ungi.toFixed(0)}%`;
          }
          
          usePotion(char);
        }
      });
      
      // ê³µê²© ê°€ëŠ¥í•œ ìºë¦­í„° ìˆ˜ì§‘ (ìš´ê¸° 80% ì´ìƒ + ì¿¨ë‹¤ìš´ ì—†ìŒ)
      // ìˆœì°¨ ì „íˆ¬: ì êµ°ì€ í™œì„±í™”ëœ ì ë§Œ
      let combatants = [...state.chars.ally];
      if (battleMode === 'sequential') {
        combatants = [...combatants, ...activeEnemies];
      } else {
        combatants = [...combatants, ...state.chars.enemy];
      }
      
      const readyChars = combatants
        .filter(c => c.ungi >= 80 && c.cooldown <= 0 && !calcChar(c).isDead)
        .map(c => ({ char: c, calc: calcChar(c) }))
        .sort((a, b) => {
          if (b.calc.moveSpeed !== a.calc.moveSpeed) return b.calc.moveSpeed - a.calc.moveSpeed;
          return a.calc.atkTime - b.calc.atkTime;
        });
      
      // ë¨¼ì € ì¤€ë¹„ëœ ìºë¦­í„°ê°€ ê³µê²©
      if (readyChars.length > 0) {
        const attacker = readyChars[0].char;
        const enemies = attacker.team === 'ally' ? state.chars.enemy : state.chars.ally;
        const target = selectTarget(attacker, enemies);
        
        if (target) {
          processAttack(attacker, target);
        }
      }
      
      renderAll();
      
      // ìŠ¹íŒ¨ ì²´í¬
      const allyAlive = getAliveChars('ally').length;
      const enemyAlive = getAliveChars('enemy').length;
      
      if (allyAlive === 0 || enemyAlive === 0) {
        if (allyAlive === 0 && enemyAlive === 0) {
          state.winner = 'draw';
          endBattle('âš”ï¸ ìŒë°© ì „ë©¸!');
        } else if (allyAlive === 0) {
          state.winner = 'enemy';
          endBattle(`ğŸ† ì êµ° ìŠ¹ë¦¬! (${state.time.toFixed(1)}s, ${state.attackCount}í•©)`);
        } else {
          state.winner = 'ally';
          endBattle(`ğŸ† ì•„êµ° ìŠ¹ë¦¬! (${state.time.toFixed(1)}s, ${state.attackCount}í•©)`);
        }
        return;
      }
      
      state.animFrame = requestAnimationFrame(gameLoop);
    }
    
    // ===== ì»¨íŠ¸ë¡¤ =====
    function startBattle() {
      const allyCount = state.chars.ally.length;
      const enemyCount = state.chars.enemy.length;
      
      if (allyCount === 0 || enemyCount === 0) {
        alert('ì–‘ íŒ€ì— ìµœì†Œ 1ëª…ì”© ë°°ì¹˜í•´ì£¼ì„¸ìš”!');
        return;
      }
      
      if (state.running) return;
      state.running = true;
      state.lastTime = 0;
      
      // ì‹¬ë²• ê³µì† íŒ¨ë„í‹° ê³„ì‚° (ì „íˆ¬ ì‹œì‘ ì‹œ)
      const allyMaxTier = Math.max(...state.chars.ally.map(c => SIMBEOP[c.simbeop]?.tier || 0));
      const enemyMaxTier = Math.max(...state.chars.enemy.map(c => SIMBEOP[c.simbeop]?.tier || 0));
      
      state.chars.ally.forEach(char => {
        const myTier = SIMBEOP[char.simbeop]?.tier || 0;
        const diff = myTier - enemyMaxTier;
        char.speedPenalty = diff < 0 ? diff * 0.03 : 0;  // í•˜ìœ„ ì‹¬ë²• -3%/ë‹¨ê³„
      });
      
      state.chars.enemy.forEach(char => {
        const myTier = SIMBEOP[char.simbeop]?.tier || 0;
        const diff = myTier - allyMaxTier;
        char.speedPenalty = diff < 0 ? diff * 0.03 : 0;
      });
      
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-stop').style.display = 'inline-block';
      updateAddButtons();
      
      if (state.time === 0) {
        document.getElementById('log-content').innerHTML = '';
        
        const battleMode = document.getElementById('battle-mode').value;
        if (battleMode === 'sequential') {
          addLog(`â”â”â” ìˆœì°¨ ì „íˆ¬: ${allyCount} vs ${enemyCount} (ì†”í”Œ) â”â”â”`, 'divider');
          addLogTime(`ğŸ¯ ì²« ë²ˆì§¸ ì : ${state.chars.enemy[0].name}`, 'ready');
        } else {
          addLog(`â”â”â” ë™ì‹œ ì „íˆ¬: ${allyCount} vs ${enemyCount} â”â”â”`, 'divider');
        }
        
        // ì‹¬ë²• ê²©ì°¨ í‘œì‹œ
        [...state.chars.ally, ...state.chars.enemy].forEach(char => {
          if (char.speedPenalty < 0) {
            addLogTime(`âš ï¸ ${char.name}: ì‹¬ë²• ì—´ì„¸ (ê³µì† ${(char.speedPenalty*100).toFixed(0)}%)`, 'naesang');
          }
        });
        
        addLogTime('ì–‘ì¸¡ì´ ì„œë¡œë¥¼ ë…¸ë ¤ë³¸ë‹¤...', 'info');
        addLogTime('ìš´ê¸°ë¥¼ ì‹œì‘í•œë‹¤!', 'ready');
      }
      
      renderAll();
      state.animFrame = requestAnimationFrame(gameLoop);
    }
    
    function stopBattle() {
      state.running = false;
      state.lastTime = 0;
      if (state.animFrame) cancelAnimationFrame(state.animFrame);
      
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-stop').style.display = 'none';
      
      addLogTime('ì „íˆ¬ ì¼ì‹œì •ì§€', 'info');
      renderAll();
    }
    
    function endBattle(resultText) {
      state.running = false;
      if (state.animFrame) cancelAnimationFrame(state.animFrame);
      
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-stop').style.display = 'none';
      
      document.getElementById('battle-result').style.display = 'block';
      document.getElementById('result-text').textContent = resultText;
      
      addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'divider');
      addLog(resultText, 'ready');
      
      // ë¬¼ì•½ ì‚¬ìš©ëŸ‰ êµ¬ë¶„ í‘œì‹œ
      if (state.totalPotionsUsed > 0) {
        addLog(`ğŸ’Š ë¬¼ì•½ ì‚¬ìš©: ì²´ë ¥ ${state.hpPotionsUsed}ê°œ / ë‚´ê³µ ${state.ngPotionsUsed}ê°œ (ì´ ${state.totalPotionsUsed}ê°œ)`, 'potion');
      }
      
      renderAll();
    }
    
    function resetBattle() {
      stopBattle();
      
      state.time = 0;
      state.attackCount = 0;
      state.winner = null;
      state.totalPotionsUsed = 0;
      state.hpPotionsUsed = 0;
      state.ngPotionsUsed = 0;
      
      [...state.chars.ally, ...state.chars.enemy].forEach(char => {
        char.hp = 100;
        char.neigong = 100;
        char.ungi = 0;
        char.cooldown = 0;
        char.speedPenalty = 0;
        char.currentAction = 'ëŒ€ê¸° ì¤‘';
        char.comboCount = 0;
        char.lastTarget = null;
      });
      
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-stop').style.display = 'none';
      document.getElementById('battle-result').style.display = 'none';
      
      updateAddButtons();
      
      document.getElementById('log-content').innerHTML = `
        <div class="log-line info">ì–‘ íŒ€ì— ìºë¦­í„°ë¥¼ ë°°ì¹˜í•˜ê³  ì „íˆ¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</div>
        <div class="log-line info">ìµœëŒ€ 3 vs 3 ì „íˆ¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
      `;
      
      renderAll();
    }
    
    // ===== ì´ˆê¸°í™” =====
    function init() {
      // ê¸°ë³¸ ë°°ì¹˜: 1 vs 3 (ë¬´ìŒ ì‹œë‚˜ë¦¬ì˜¤)
      state.chars.ally.push(createCharacter('ally', {
        name: 'ê²€í˜¸', gyeongji: 'ì ˆì •', simbeop: 'ê¸°ë³¸ì‹¬ë²•',
        mugong: 'ê²€ê°•', mugongLv: 1, bobeop: 5,  // ì ˆì •ì€ ê²€ê°• ä¸‹ê¹Œì§€
        balchul: 'ê²€ê¸°ë°œì¶œ', balchulLv: 2,       // ì ˆì •ì€ ê²€ê¸°ë°œì¶œ ä¸­ê¹Œì§€
        hpPotions: 5, ngPotions: 5
      }));
      
      state.chars.enemy.push(createCharacter('enemy', {
        name: 'ë„ì ë‘ëª©', gyeongji: 'ì¼ë¥˜', simbeop: 'ê¸°ì´ˆì‹¬ë²•',
        mugong: 'ê²€ì‚¬', mugongLv: 2, bobeop: 3,  // ì¼ë¥˜ëŠ” ê²€ì‚¬ ä¸­ê¹Œì§€
        balchul: 'ê²€ê¸°ë°œì¶œ', balchulLv: 1,       // ì¼ë¥˜ëŠ” ê²€ê¸°ë°œì¶œ ä¸‹ê¹Œì§€
        hpPotions: 2, ngPotions: 2
      }));
      state.chars.enemy.push(createCharacter('enemy', {
        name: 'ë„ì 1', gyeongji: 'ì´ë¥˜', simbeop: 'ê¸°ì´ˆì‹¬ë²•',
        mugong: 'ê²€ê¸°', mugongLv: 2, bobeop: 2,  // ì´ë¥˜ëŠ” ê²€ê¸° ä¸­ê¹Œì§€
        balchul: 'ì—†ìŒ', balchulLv: 1,           // ì´ë¥˜ëŠ” ë°œì¶œ ë¶ˆê°€
        hpPotions: 1, ngPotions: 1
      }));
      state.chars.enemy.push(createCharacter('enemy', {
        name: 'ë„ì 2', gyeongji: 'ì‚¼ë¥˜', simbeop: 'ì‚¼ì¬ì‹¬ë²•',
        mugong: 'ê²€ê¸°', mugongLv: 1, bobeop: 1,  // ì‚¼ë¥˜ëŠ” ê²€ê¸° ä¸‹ë§Œ
        balchul: 'ì—†ìŒ', balchulLv: 1,           // ì‚¼ë¥˜ëŠ” ë°œì¶œ ë¶ˆê°€
        hpPotions: 1, ngPotions: 1
      }));
      
      renderAll();
      updateAddButtons();
    }
    
    init();
  </script>
</body>
</html>
